<!DOCTYPE html>
<html>
    <head>
        <title>Blog - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                            
                                
                                
                
                <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Blog</li>
    </ol>
</nav>

    <article>
        <header>
            <h2><a href="https://new.doctrine-project.org/2010/07/21/mongodb-odm-query-builder-api">MongoDB ODM: Query Builder API</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-07-21
                            by
                                    jwage
                                    </p>

        <hr />

        <div>
            <p>The Doctrine MongoDB Object Document Mapper includes a fluent
object oriented API for building queries to execute against
MongoDB. Recently some changes were made to the API to simplify it
and make it more readable. This blog post aims to demonstrate and
introduce the new API to you!</p>
<a id="title.1"></a><h1>Query Types</h1>
<p>The API still supports all the types of queries you would expect:</p>
<ul><li class="dash"> <a href="#find">find</a></li>
<li class="dash"> <a href="#insert">insert</a></li>
<li class="dash"> <a href="#update">update</a></li>
<li class="dash"> <a href="#delete">delete</a></li>
</ul>

<p>Continue reading to see examples for each of the above types of
queries!</p>
<p>## Find</p>
<p>You can easily find documents by just creating a new <code>Query</code>
object with the <code>createQuery()</code> method. A new <code>Query</code> object
defaults to a <code>find</code> query so you just need to pass the name of
the document to query for:</p>
<pre><code class="php">&lt;?php
$q = $dm-&gt;createQuery('User');
</code></pre>
<p>You can change the document being queried for by using the
<code>find()</code> method:</p>
<pre><code class="php">&lt;?php
$q-&gt;find('Project');
</code></pre>
<a id="title.1.1"></a><h2>Conditions</h2>
<p>You can limit the returned documents by specifying some
conditions:</p>
<pre><code class="php">&lt;?php
$q-&gt;field('title')-&gt;equals('The Doctrine Project');
</code></pre>
<p>Maybe you want to only return projects created after today:</p>
<pre><code class="php">&lt;?php
$q-&gt;field('createdAt')-&gt;greaterThan(new MongoDate(time()));
</code></pre>
<p>You can even a condition on an embedded document:</p>
<pre><code class="php">&lt;?php
$q-&gt;field('profile.firstName')-&gt;equals('Jonathan');
</code></pre>
<p>Also, you can add a condition for a referenced document to filter
by id:</p>
<pre><code class="php">&lt;?php
$q-&gt;field('account.$id')-&gt;equals($accountId);
</code></pre>
<p>The <code>field()</code> method specifies the current field to add the
conditions to. You can optionally use the magical <code>__call()</code>
feature of the <code>Query</code> object to specify the current field as
well:</p>
<pre><code class="php">&lt;?php
$q-&gt;createdAt()-&gt;greaterThan(new MongoDate(time()));
</code></pre>
<p>All the methods you'd expect can be used in combination with the
<code>field()</code> method for adding conditions to your query:</p>
<ul><li class="dash"> equal($value)</li>
<li class="dash"> where($javascript)</li>
<li class="dash"> not($value)</li>
<li class="dash"> in($values)</li>
<li class="dash"> notIn($values)</li>
<li class="dash"> notEqual($value)</li>
<li class="dash"> greaterThan($value)</li>
<li class="dash"> greaterThanOrEq($value)</li>
<li class="dash"> lessThan($value)</li>
<li class="dash"> lessThanOrEq($value)</li>
<li class="dash"> range($start, $end)</li>
<li class="dash"> size($size)</li>
<li class="dash"> exists($bool)</li>
<li class="dash"> type($type)</li>
<li class="dash"> all($values)</li>
<li class="dash"> mod($mod)</li>
</ul>

<p>## Insert</p>
<p>You can easily insert new documents using the <code>Query</code> API as
well. Just use the <code>insert()</code> method in combination with
<code>field()</code> and <code>set()</code>:</p>
<pre><code class="php">&lt;?php
$q = $dm-&gt;createQuery('User')
    -&gt;insert()
    -&gt;field('username')-&gt;set('jwage')
    -&gt;field('password')-&gt;set('password');
</code></pre>
<p>If you want to set the new document to insert you can use the
<code>setNewObj()</code> method:</p>
<pre><code class="php">&lt;?php
$q = $dm-&gt;createQuery('User')
    -&gt;insert()
    -&gt;setNewObj(array(
        'username' =&gt; 'jwage',
        'password' =&gt; 'password'
    ));
</code></pre>
<p>## Update</p>
<p>If you want to update a document you can use the <code>update()</code>
method in combination with <code>field()</code>, <code>set()</code> and conditions.
Here is an example where we create a query to update a user with
the username <code>jwage</code> and give him a new password:</p>
<pre><code class="php">&lt;?php
$q = $dm-&gt;createQuery('User')
    -&gt;update()
    -&gt;field('password')-&gt;set('newpassword')
    -&gt;field('username')-&gt;equals('jwage');
</code></pre>
<p>## Delete</p>
<p>You can delete documents as well by using the <code>delete()</code> method
in combination with conditions. Here is an example where we create
a query to delete the user document with a username of <code>jwage</code>:</p>
<pre><code class="php">&lt;?php
$q = $dm-&gt;createQuery('User')
    -&gt;delete()
    -&gt;field('username')-&gt;equals('jwage');
</code></pre>
<p>As you can see the fluent API makes it a bit easier to express
queries that are easy to read in the same way you would read
english from left to right. We hope to enhance and improve this API
even more before we release the stable 1.0 version.</p>
<p>You can read more about the Query Builder API in the
<a href="http://www.doctrine-project.org/projects/mongodb_odm/1.0/docs/reference/query-builder-api/en#query-builder-api">documentation</a>.</p>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://new.doctrine-project.org/2010/07/20/mixing-types-of-documents">MongoDB ODM: Mixing Types of Documents</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-07-20
                            by
                                    jwage
                                    </p>

        <hr />

        <div>
            <p>One major advantage to using something like MongoDB is the fact
that it is schema-less. We can store multiple types of documents in
a single collection and we are not limited to a single type of
document in embedded and referenced documents. This article shows
how you can easily mix types of documents in collections, embedded
and referenced documents.</p>
<a id="title.1"></a><h1>Mixing Types in Collections</h1>
<p>If you don't want to use <code>SINGLE_COLLECTION</code> inheritance you can
easily store different documents in the same collection by using a
discriminator field. First define an <code>Article</code> document that maps
to <code>my_documents</code>:</p>
<pre><code class="php">&lt;?php
/**
 * @Document(collection=&quot;my_documents&quot;)
 * @DiscriminatorField(fieldName=&quot;type&quot;)
 * @DiscriminatorMap({&quot;article&quot;=&quot;Article&quot;, &quot;album&quot;=&quot;Album&quot;})
 */
class Article
{
    // ...
}
</code></pre>
<p>Next create another document named <code>Album</code> and also map it to
<code>my_documents</code>:</p>
<pre><code class="php">&lt;?php
/**
 * @Document(collection=&quot;my_documents&quot;)
 * @DiscriminatorField(fieldName=&quot;type&quot;)
 * @DiscriminatorMap({&quot;article&quot;=&quot;Article&quot;, &quot;album&quot;=&quot;Album&quot;})
 */
class Album
{
    // ...
}
</code></pre>
<p>Now if you create some instances and persist them they will all be
stored in the <code>my_documents</code> collection and will have a
discriminator field named <code>type</code> automatically set with the value
specified in the mapping:</p>
<pre><code class="php">&lt;?php
$article = new Article();
$article-&gt;setTitle('Sample Article');
// ...

$album = new Album();
$album-&gt;setName('My Album');

$dm-&gt;persist($article);
$dm-&gt;persist($album);
</code></pre>
<p>Finally, if you retrieve the documents they'll all be retrieved
from <code>my_documents</code> but you will get back the proper PHP classes
that created them:</p>
<pre><code class="php">&lt;?php
$articles = $dm-&gt;find('Article');
$albums = $dm-&gt;find('Album');
</code></pre>
<p>You can retrieve more then just one document type by specifying an
array:</p>
<pre><code class="php">&lt;?php
$documents = $dm
    -&gt;createQuery(array('Article', 'Album'))
    -&gt;execute();
</code></pre>
<p>The returned documents will contain instances of articles and
albums!</p>
<a id="title.2"></a><h1>Mixing Types in Embedded Documents</h1>
<p>You can store multiple types of documents in embedded documents by
simply omitting the <code>targetDocument</code> option. First create a
<code>User</code> document and embed multiple task documents:</p>
<pre><code class="php">&lt;?php
/** @Document(collection=&quot;users&quot;) */
class User
{
    // ...

    /** @Embedded */
    private $tasks = array();

    // ...
}

**NOTE** Notice how on the ``$tasks`` annotation we don't specify
whether it is ``one`` or ``many``. This is because we know it is
``many`` due to the default value being an array.

</code></pre>
<p>Now create the different types of tasks we can add to the user:</p>
<pre><code class="php">&lt;?php
/** @EmbeddedDocument */
class DownloadTask
{
    // ...
}

/** @EmbeddedDocument */
class UploadTask
{
    // ...
}
</code></pre>
<p>Now you can embed any type of class in the <code>$tasks</code> property:</p>
<pre><code class="php">&lt;?php
$user = $dm-&gt;findOne('User', array(...));

$task = new DownloadTask();
// ...

$user-&gt;addTask($task);

$task = new UploadTask();
// ...

$user-&gt;addTask($task);

$dm-&gt;flush();
</code></pre>
<a id="title.3"></a><h1>Mixing Types in Referenced Documents</h1>
<p>Mixing types in referenced documents works just the same as
embedded by omitting the <code>targetDocument</code> option. In this example
a user can add references to all his favorite albums, songs and
books. First define a <code>User</code> document with a many references
property for storing the users favorites:</p>
<pre><code class="php">&lt;?php
/** @Document(collection=&quot;users&quot;) */
class User
{
    // ...

    /** @Reference */
    private $favorites = array();

    // ...
}
</code></pre>
<p>Now here is what the referenced documents would look like:</p>
<pre><code class="php">&lt;?php
/** @Document(collection=&quot;albums&quot;) */
class Album
{
    // ...
}

/** @Document(collection=&quot;songs&quot;) */
class Song
{
    // ...
}

/** @Document(collection=&quot;books&quot;) */
class Book
{
    // ...
}
</code></pre>
<p>Now it is easy to add the references to his favorites:</p>
<pre><code class="php">&lt;?php
$user-&gt;addFavorite($album);
$user-&gt;addFavorite($song);
$user-&gt;addFavorite($book);

$dm-&gt;flush();
</code></pre>
<p>When you retrieve the user and access the <code>$favorites</code> the
documents will be grouped by type and loaded with one or more
<code>$in</code> queries:</p>
<pre><code class="php">&lt;?php
$user = $dm-&gt;findOne('User', array(...));
$favorites = $user-&gt;getFavorites();

// Lazily loads references
// Contains Album, Song and Book instances
foreach ($favorites as $favorite) {
    // ...
}
</code></pre>
<p>That is it! It is easy to take advantage of the schema-less
features of MongoDB with the Doctrine Object Document Mapper
(ODM)!</p>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://new.doctrine-project.org/2010/07/19/your-own-orm-doctrine2">Write your own ORM on top of Doctrine2</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-07-19
                            by
                                    beberlei
                                    </p>

        <hr />

        <div>
            <p><strong>NOTE</strong></p>
<blockquote><p>The Doctrine ActiveEntity Extension is just an experiment, nothing
that will be developed much further from the Doctrine Dev Team. It
is only a show-case for what is possible with Doctrine2. Please
feel free to take the code and develop it further.</p>
</blockquote>
<p>Did you feel the urge to write your own Object-Relational Mapper
after reading Martin Fowlers PoEAA? I am guilty to have tried
implementing two different ORMs on my own, both now safely dumped
into the trash.</p>
<p>In isolation each ORM pattern is easy to describe, understand and
even implement. However the combination of a large set of patterns
into a single implementation introduces a lot of hard to solve
complexity in your code. Even simple Object-Relational-Mappers
require a lot of patterns to become useful: Metadata Mapping,
Identity Map, Foreign Key Mapping, Association Table Mapping and
Query Object. Implementations with more features at least need the
UnitOfWork and probably many more, for example handling
inheritance, locking, value objects and such.</p>
<p>Doctrine2 already solves a lot of the head aching problems in a
consistent approach. We have been working on this project for
almost 2 years now, with all the experience we gained implementing
Doctrine 1. Additionally we make use of well-understood concepts
from other ORM implementations across various languages.</p>
<p>We as developers think that Doctrine2 responsibilities are very
well separated such that you can exchange larger parts of the
Doctrine2 core without having to re-implement everything. So if you
ever feel inspired to implement your own ORM, we would be happy to
offer you Doctrine2 as a foundation to build upon.</p>
<p>There are examples of other ORMs that have taken the re-use instead
of re-implement road. For example the
<a href="http://www.grails.org/GORM">Groovy Grails ORM</a> is an
ActiveRecord implementation on top of the popular Hibernate Java
ORM. Since Groovy is a java-virtual-machine language it can safely
use the Hibernate ORM as a dependent library.</p>
<p>This article will describe some possible extensions and show where
you can hook into the Doctrine2 core to implement your own ORM. The
article will be very code focused and also comes with a
<a href="http://github.com/beberlei/Doctrine-ActiveEntity">Github project</a>
where all the code and some tests are hosted.</p>
<a id="title.1"></a><h1>Doctrine2 and ActiveRecord</h1>
<p>Doctrine2 is implementing the DataMapper pattern, however many
programmers think ActiveRecord is better for various reasons. For
me data-mappers are superiour to ActiveRecord, however I do
understand why ActiveRecord is so popular: Its very easy to get
started and do cool stuff with it! If you want Doctrine2 to be
ActiveRecord you can have it. Actually it is very easy to turn it
into a powerful ActiveRecord implementation, keeping all the
powerful features such as DQL.</p>
<p>Some while ago Jonathan already released his approach, called the
&quot;ActiveEntity&quot; extension. Its a single abstract php class that your
entities have to implement, the code is still
<a href="http://trac.doctrine-project.org/browser/extensions/ActiveEntity/branches/2.0-1.0/DoctrineExtensions/ActiveEntity.php">in our SVN repository</a>.
However a more recent version of this code is available as
<a href="http://github.com/beberlei/Doctrine-ActiveEntity">a project on Github</a>.
I won't support this experiment any further, I hope somebody picks
it up and starts maintaining it.</p>
<p>With Jonathans old code, to allow active record entities, you have
to bootstrap the ActiveEntity by passing a static EntityManager:</p>
<pre><code class="php">&lt;?php
\DoctrineExtensions\ActiveEntity::setEntityManager($em);
</code></pre>
<p>Now say we have a User Entity (using Jonathans old ActiveEntity):</p>
<pre><code class="php">&lt;?php
namespace Entities;

use DoctrineExtensions\ActiveEntity;

/** @Entity */
class User extends ActiveEntity
{
    /** @Id @GeneratedValue @column(type=&quot;integer&quot;) */
    private $id;

    /** @Column(type=&quot;string&quot;) */
    private $name;
}
</code></pre>
<p>With PHP 5.3 late-static binding functionality we can now access
the <code>EntityRepository</code>, a finder object for entities using a Ruby
on Rails'ish notation:</p>
<pre><code class="php">&lt;?php
$user = User::find($id);
$users = User::findBy(array(&quot;name&quot; =&gt; &quot;beberlei&quot;));
$beberlei = User::findOneBy(array(&quot;name&quot; =&gt; &quot;beberlei&quot;));
</code></pre>
<p>The code to allow this functionality is very simple:</p>
<pre><code class="php">&lt;?php
public static function __callStatic($method, $arguments)
{
    return call_user_func_array(array(self::$_em-&gt;getRepository(get_called_class()), $method), $arguments);
}
</code></pre>
<p>There are also some additional methods on the <code>ActiveEntity</code>
class that use magic <strong>get and</strong>set and \_\_call methods to access
the private properties of an Entity (such as the User id and name
shown above). Additionally you can call save() or remove() on any
instance.</p>
<p>For starters this offers a great ActiveRecord implementation with
all the powerful features that Doctrine2 offers, such as DQL and
UnitOfWork. However we can still go much further:</p>
<ul><li class="dash"> Eliminate the need to define ActiveEntity properties by metadata
   mapping inference</li>
<li class="dash"> Adding your own powerful Metadata Mapping Layer</li>
<li class="dash"> Add a Doctrine 1.2 behaviour system using the PHP 5.3.99DEV
   Traits functionalitiy</li>
<li class="dash"> Add validation to properties of an ActiveEntity</li>
</ul>

<p>Lets begin with a simple introduction to the Doctrine Metadata
Model to explain how this is all possible.</p>
<a id="title.2"></a><h1>Doctrine2 Metadata Model</h1>
<p>You probably already saw that Doctrine2 offers many different
metadata configuration mechanisms: Annotations, YAML, XML and plain
PHP. Any one of this implementations will transform into an
instance of <code>Doctrine\ORM\ClassMetadata</code> which is then cached for
subsequent web requests. The <code>ClassMetadataFactory</code> is
responsible for creating and managing those metadata instances.</p>
<p>Doctrine2 uses the <code>ClassMetadata</code> instance internally for all
runtime access to your entities metadata, which means that you have
to extend this class such that it works exactly the same from the
outside.</p>
<p>If you wanted to extend the inner workings of Doctrine2, this is
indeed the way to go. First extend the EntityManager to replace the
<code>ClassMetadataFactory</code> used. This piece of code is the only
hackish workaround, everything else is rather nice :-)</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\ActiveEntity;

use DoctrineExtensions\ActiveEntity\Mapping\ClassMetadataFactory;

class ActiveEntityManager extends \Doctrine\ORM\EntityManager
{
    protected function __construct(Connection $conn, Configuration $config, EventManager $eventManager)
    {
        parent::__construct($conn, $config, $eventManager);

        $metadataFactory = new ActiveClassMetadataFactory($this);
        $metadataFactory-&gt;setCacheDriver($this-&gt;getConfiguration()-&gt;getMetadataCacheImpl());

        // now this is the only hack required to get it work:
        $reflProperty = new \ReflectionProperty('Doctrine\ORM\EntityManager', 'metadataFactory');
        $reflProperty-&gt;setAccessible(true);
        $reflProperty-&gt;setValue($this, $metadataFactory);
    }

    public static function create($conn, Configuration $config, EventManager $eventManager = null)
    {
        // ... copy paste from EntityManager::create()

        return new ActiveEntityManager($conn, $config, $conn-&gt;getEventManager());
    }
}
</code></pre>
<p>And both the <code>ClassMetadataFactory</code> and <code>ClassMetadata</code>:</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\ActiveEntity\Mapping;

class ActiveClassMetadataFactory extends \Doctrine\ORM\Mapping\ClassMetadataFactory
{
    protected function _newClassMetadataInstance($className)
    {
        return new ActiveClassMetadata($className);
    }
}

class ActiveClassMetadata extends \Doctrine\ORM\Mapping\ClassMetadata
{
}
</code></pre>
<p>This is the foundation of your own Doctrine2-based ORM. We will see
in the next section how we can use this.</p>
<a id="title.3"></a><h1>Exchange Doctrine2 Reflection for Array-based Field Storage</h1>
<p>Doctrine2 uses reflection to access the current values of an
entity. This is necessary, because Doctrine2 is a Data Mapper that
enforces clean separation between entities and persistence. If we
extend it to be an ActiveRecord implementation this separation is
not wanted anymore and we can opt for a new approach, using the
get()/set() methods on our ActiveEntities.</p>
<p>Defining the properties &quot;id&quot; and &quot;name&quot; will then not be necessary
anymore, they will all be saved in an array hash-map called
&quot;\_data&quot; inside the ActiveEntity. We cannot use annotations for
metadata anymore, however the XML or YAML drivers would still work
smoothly.</p>
<p>To get started we have to modify our <code>ActiveClassMetadata</code> a bit
to exchange the contents of reflClass and reflFields with our own
classes. Looking at the <code>ClassMetadata</code> code and doing some
project wide searches I found out about all the necessary changes.
To replace the <code>ReflectionClass</code> we only need to exchange
<code>getProperty</code> and keep the rest. To exchange
<code>ReflectionProperty</code> we only have to overwrite
<code>setAccessible()</code>, <code>getValue()</code> and <code>setValue()</code>.</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\ActiveEntity\Reflection;

class ActiveEntityReflectionClass extends \ReflectionClass
{
    public function getProperty($name)
    {
        return new ActiveEntityPropertyReflection($this-&gt;name, $name);
    }
}

class ActiveEntityReflectionProperty
{
    public $name = null;
    public $class = null;

    public function __construct($class, $name)
    {
        $this-&gt;class = $class;
        $this-&gt;name = $name;
    }

    public function setAccessible($flag) {}

    public function setValue($entity = null, $value = null)
    {
        $entity-&gt;set($this-&gt;name, $value);
    }

    public function getValue($entity = null)
    {
        return $entity-&gt;get($this-&gt;name);
    }
}
</code></pre>
<p>This is about enough to exchange reflection transformation against
a simple ActiveRecord get/set approach. Now we need to replace the
all the instantiations of <code>ReflectionClass</code> relevant for runtime
mapping with our implementation:</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\ActiveEntity\Mapping;

use DoctrineExtensions\ActiveEntity\Reflection\ActiveEntityReflectionClass;
use DoctrineExtensions\ActiveEntity\Reflection\ActiveEntityReflectionProperty;

class ActiveClassMetadata extends \Doctrine\ORM\Mapping\ClassMetadata
{
    public function __construct($entityName)
    {
        parent::__construct($entityName);
        $this-&gt;reflClass = new ActiveEntityReflectionClass($entityName);
        $this-&gt;namespace = $this-&gt;reflClass-&gt;getNamespaceName();
        $this-&gt;table['name'] = $this-&gt;reflClass-&gt;getShortName();
    }

    /**
     * Restores some state that can not be serialized/unserialized.
     *
     * @return void
     */
    public function __wakeup()
    {
        // lots of code here, see the Github Repository
    }
}
</code></pre>
<p>Again, this is enough and our ActiveEntity Mapping now works. We
can heavily modify the <code>ActiveEntity</code> now to loose the
requirement to specify properties for the defined metadata. We can
rewrite the User entity to be:</p>
<pre><code class="php">&lt;?php
namespace Entities;

use DoctrineExtensions\ActiveEntity\ActiveEntity;

class User extends ActiveEntity
{
}
</code></pre>
<p>Using an XML or YAML Mapping is already enough for this
ActiveEntity to work out of the box.</p>
<a id="title.4"></a><h1>Implementing your own Metadata Mapping Driver</h1>
<p>In the spirit of Doctrine 1.\* or GORM there should be a PHP based
metadata mapping driver now and actually Doctrine2 ships with one
already:</p>
<pre><code class="php">&lt;?php
$config = new \Doctrine\ORM\Configuration();
$config-&gt;setMetadataDriverImpl(new \Doctrine\ORM\Mapping\Driver\StaticPHPDriver());
// ...
</code></pre>
<p>This allows to specify the metadata within the User class:</p>
<pre><code class="php">&lt;?php
namespace Entities;

use DoctrineExtensions\ActiveEntity\ActiveEntity;
use DoctrineExtensions\ActiveEntity\Mapping\ActiveClassMetadata;

class User extends ActiveEntity
{
    static public function loadMetadata(ActiveClassMetadata $cm)
    {
        // work with $cm here!
    }
}
</code></pre>
<p>You could extend that Static PHP Driver even more for the next
section. We could add additional metadata information, such as
names of behaviours to extend or validators or anything else.</p>
<a id="title.5"></a><h1>Using Traits for Behaviours</h1>
<p>We want to add a simple &quot;Timestampable&quot; behaviour now, hooking into
the <code>loadClassMetadata</code> event
<a href="http://www.doctrine-project.org/projects/orm/2.0/docs/reference/events/en#load-classmetadata-event">as described in the documentation</a>:</p>
<p>Now this is untested code, as i don't have a PHP-5.3.99-DEV version
compiled at this machine.</p>
<p>The following trait can be used by our <code>User</code> entity:</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\ActiveEntity\Behaviour;

trait Timestampable
{
    public function created()
    {
        return $this-&gt;get('created');
    }

    public function updated()
    {
        return $this-&gt;get('updated');
    }

    /** will be a prePersist lifecycle hook */
    public function setCreated()
    {
        return $this-&gt;set('created', new \DateTime(&quot;now&quot;));
    }

    /** will be a preUpdate lifecycle hook */
    public function setUpdated()
    {
        return $this-&gt;set('updated', new \DateTime(&quot;now&quot;));
    }
}

class User extends ActiveEntity use Timestampable
{

}
</code></pre>
<p>We now need an Event that modifies the <code>ActiveClassMetadata</code> as
required:</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\ActiveEntity\Behaviour;

use Doctrine\ORM\Event\LoadClassMetadataEventArgs;

class TimestampableEvent
{
    public function loadClassMetadata(LoadClassMetadataEventArgs $eventArgs)
    {
        $classMetadata = $eventArgs-&gt;getClassMetadata();
        $traits = $classMetadata-&gt;reflClass-&gt;getTraitNames();
        if (!in_array(&quot;DoctrineExtensions\ActiveEntity\Behaviour\Timestampable&quot;, $traits)) {
            return;
        }

        $classMetadata-&gt;mapField(array(
            'type' =&gt; 'datetime',
            'fieldName' =&gt; 'created',
        ));
        $classMetadata-&gt;mapField(array(
            'type' =&gt; 'datetime',
            'fieldName' =&gt; 'updated',
        ));
        $classMetadata-&gt;addLifecycleCallback(&quot;prePersist&quot;, &quot;setCreated&quot;);
        $classMetadata-&gt;addLifecycleCallback(&quot;prePersist&quot;, &quot;setUpdated&quot;);
        $classMetadata-&gt;addLifecycleCallback(&quot;preUpdate&quot;, &quot;setUpdated&quot;);
    }
}
</code></pre>
<p>You can now register this behaviour with your Entity Manager and
just the usage of the trait <code>Timestampable</code> adds two additional
fields and updates them accordingly.</p>
<blockquote><p><strong>NOTE</strong></p>
<p>Again, the trait code is untested. It should work, but I cannot
guarantee! :)</p>
</blockquote>
<a id="title.6"></a><h1>Conclusion</h1>
<p>What are you waiting for? This article showed a very deep
modification of the Doctrine2 core to turn it into Active Record.
The changes required some understanding of the inner workings of
Doctrine2, however not many changes were required in the end.</p>
<p><a href="http://github.com/beberlei/Doctrine-ActiveEntity">See the code on GitHub!</a></p>

        </div>

            </article>

    <nav class="mt-4">
        <ul class="pagination">
            <li class="page-item"><a class="page-link" href="https://new.doctrine-project.org/blog/page/44.html">Newer Posts</a></li><br />
            <li class="page-item"><a class="page-link" href="https://new.doctrine-project.org/blog/page/46.html">Older Posts</a></li>        </ul>
    </nav>
                    </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
