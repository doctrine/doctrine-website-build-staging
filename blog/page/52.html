<!DOCTYPE html>
<html>
    <head>
        <title>Blog - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?369e38" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/components/highlightjs/styles/railscasts.css?b4f8ae" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
            </head>
    <body>
                    <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/lexer/">Lexer</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>

                <div class="search-results rounded">
                    <div id="hits">
                        <!-- Hits widget will appear here -->
                    </div>

                    <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
                </div>
            </nav>
        
            <main role="main" class="container-wrapper container">
                        <article>
        <header>
            <h2><a href="https://staging.doctrine-project.org/2010/03/01/introduction-to-doctrine-2-webinar.html">Introduction to Doctrine 2 Webinar</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-03-01
                            by
                                    jwage
                                    </p>

        <hr />

        <div>
            
        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://staging.doctrine-project.org/2010/02/24/doctrine2-versionable.html">A re-usable Versionable Behavior for Doctrine 2</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-02-24
                            by
                                    beberlei
                                    </p>

        <hr />

        <div>
            <p><strong>NOTE</strong> This blog entry relates to an outdated Doctrine 2 Alpha
    version. Please see the documentation for the most up to date
    behavior. A test-implementation for this behavior is on
    github.com/beberlei/DoctrineExtensions</p>
<p>My previous post on behaviors in Doctrine 2 generated quite some
discussion about the difference on behaviours that are re-usable
across models and the trivial specific implementations I have
shown.</p>
<p>In this post I will show a re-usable versionable (audit-log)
behavior. For this we will need the following ingredients:</p>
<ul><li class="dash"> An interface <code>DoctrineExtensions\Versionable\Versionable</code></li>
<li class="dash"> A class <code>DoctrineExtensions\Versionable\VersionManager</code></li>
<li class="dash"> An event listener
   <code>DoctrineExtensions\Versionable\VersionListener</code></li>
<li class="dash"> A generic entity
   <code>DoctrineExtensions\Versionable\ResourceVersion</code>
    <strong>NOTE</strong> The Event API is currently in the central focus of our
    efforts so the API shown here may change before the first Beta
    release.</li>
</ul>

<p>The workflow is as follows, each Entity that is supposed to be
versionable has to implement the interface <code>Versionable</code> which
looks like this:</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\Versionable;

interface Versionable
{
    /**
     * @return int
     */
    public function getCurrentVersion();

    /**
     * @return array
     */
    public function getVersionedData();

    /**
     * @return int
     */
    public function getResourceId();
}
</code></pre>
<p>Whenever an entity is persisted or updated the state that is
persisted will also be logged in an audit table. The state is
returned with an array of key value pairs in the
<code>getVersionedData()</code> and the current version has to be the value
of the @Version column of the entity.</p>
<p>To sum up, the requirements of an entity that can be a
<code>Versionable</code> in this simple implementation:</p>
<ul><li class="dash"> Single Integer Primary Key.</li>
<li class="dash"> Has to be versioned with an integer column.</li>
</ul>

<p>How does such versioned data look like? The generic resource
version entity looks like this. Its a Doctrine Entity, but in a
domain model its an immutable value object. It should not be
changed after creation.</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\Versionable;

class ResourceVersion
{
    /** @Id @Column(type=&quot;integer&quot;) */
    private $id;

    /** @Column(type=&quot;string&quot;) */
    private $resourceName;

    /** @Column(type=&quot;integer&quot;) */
    private $resourceId;

    /** @Column(type=&quot;array&quot;) */
    private $versionedData;

    /**
     * @Column(type=&quot;integer&quot;) */
    private $version;

    /** @Column(type=&quot;datetime&quot;) */
    private $snapshotDate;

    public function __construct(Versionable $resource)
    {
        $this-&gt;resourceName = get_class($resource);
        $this-&gt;resourceId = $resource-&gt;getResourceId();
        $this-&gt;versionedData = $resource-&gt;getVersionedData();
        $this-&gt;version = $resource-&gt;getCurrentVersion();
        $this-&gt;snapshotDate = new \DateTime(&quot;now&quot;);
    }

    // getters
}
</code></pre>
<p>Now we need to solve the problem of generating the
<code>ResourceVersion</code> whenever an <code>Versionable</code> entity is persisted
or updated. This can be done by using the
<a href="http://www.doctrine-project.org/documentation/manual/2_0/en/events">Doctrine EventManager API</a>.
We will implement the <code>EventSubscriber</code> interface and hook into
the &quot;onFlush&quot; event.</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\Versionable;

use Doctrine\Common\EventSubscriber,
    Doctrine\ORM\Events,
    Doctrine\ORM\Event\OnFlushEventArgs,
    Doctrine\ORM\EntityManager;

class VersionListener implements EventSubscriber
{
    public function getSubscribedEvents()
    {
        return array(Events::onFlush);
    }

    public function onFlush(OnFlushEventArgs $args)
    {
        $em = $args-&gt;getEntityManager();
        $uow = $em-&gt;getUnitOfWork();

        foreach ($uow-&gt;getScheduledEntityInsertions() AS $entity) {
            if ($entity instanceof Versionable) {
                $this-&gt;_makeSnapshot($entity);
            }
        }

        foreach ($uow-&gt;getScheduledEntityUpdates() AS $entity) {
            if ($entity instanceof Versionable) {
                $this-&gt;_makeSnapshot($entity);
            }
        }
    }

    private function _makeSnapshot($entity)
    {
        $resourceVersion = new ResourceVersion($entity);
        $class = $this-&gt;_em-&gt;getClassMetadata(get_class($resourceVersion));

        $this-&gt;_em-&gt;persist( $resourceVersion );
        $this-&gt;_em-&gt;getUnitOfWork()-&gt;computeChangeSet($class, $resourceVersion);
    }
}
</code></pre>
<p>How do we hook this <code>VersionListener</code> into the EntityManager? We
will wrap the VersionManager around it that handles registration
and offers some convenience methods to retrieve the versions of a
resource.</p>
<pre><code class="php">&lt;?php
namespace DoctrineExtensions\Versionable;

use Doctrine\ORM\EntityManager;

class VersionManager
{
    private $_em;

    public function __construct(EntityManager $em)
    {
        $this-&gt;_em = $em;
        $this-&gt;_em-&gt;getEventManager()-&gt;addEventSubscriber(
            new VersionListener()
        );
    }

    public function getVersions(Versionable $resource)
    {
        $query = $this-&gt;_em-&gt;createQuery(
            &quot;SELECT v FROM DoctrineExtensions\Versionable\ResourceVersion v INDEX BY v.version &quot;.
            &quot;WHERE v.resourceName = ?1 AND v.resourceId = ?2 ORDER BY v.version DESC&quot;);
        $query-&gt;setParameter(1, get_class($resource));
        $query-&gt;setParameter(2, $resource-&gt;getResourceId());

        return $query-&gt;getResult();
    }
}
</code></pre>
<p>Now using this to retrieve all the versions of a given entity that
is versionable you would go and:</p>
<pre><code class="php">&lt;?php
// $em EntityManager, $blogPost my Blog Post

$versionManager = new VersionManager($em);
$versions = $versionManager-&gt;getVersions($blogPost);

echo &quot;Old Title: &quot;.$versions[$oldVersionNum]-&gt;getVersionedData('title');

// Create a new version
$blogPost-&gt;setTitle(&quot;My very new title&quot;);    
$em-&gt;flush();
</code></pre>
<p>This is a first example of how to use the powerful Doctrine 2 Event
API. It is certainly not easy to use, as you need to understand the
inner workings of the UnitOfWork and the different steps it is in
during the flush process. However you can generate huge benefits in
reusability.</p>
<p>The versionable behaviour could be extended by the following
features:</p>
<ul><li class="dash"> Create a new interface <code>Revertable</code> that extends
   <code>Versionable</code> and add a method
   <code>revert(Revertable $resource, $toVersion)</code> to the
   <code>VersionManager</code> that handles the retrieval, invoking of revert
   and such.</li>
<li class="dash"> Create a new interface Diffable with a method diff($aVersion,
   $bVersion) and new method diff(Diffable $resource, $aId, $bId) to
   the VersionManager that handles the delegation of a difference
   computation between two versions to the Diffable implementor.</li>
</ul>

<p>Another approach would be not to save the complete state of an
entity during the flush operation, but only the fields that
changed. This is generally called an <em>AuditLog</em>. We could add an
<code>Auditable</code> interface much in the same manner than the
<code>Versionable</code> and retrieve the ChangeSets of each entity during
flush using the following event listener:</p>
<pre><code class="php">&lt;?php
class AuditListener implements EventSubscriber
{
    public function getSubscribedEvents()
    {
        return array(Events::onFlush);
    }

    public function onFlush(OnFlushEventArgs $args)
    {
        $em = $args-&gt;getEntityManager();
        $uow = $em-&gt;getUnitOfWork();

        $changeDate = new DateTime(&quot;now&quot;);
        $class = $em-&gt;getClassMetadata('DoctrineExtensions\Auditable\AuditEntry');

        foreach ($uow-&gt;getScheduledEntityUpdates() AS $entity) {
            if ($entity instanceof Auditable) {
                $changeSet = $uow-&gt;getEntityChangeSet($entity);

                foreach ($changeSet AS $field =&gt; $vals) {
                    list($oldValue, $newValue) = $vals;
                    $audit = new AuditEntry(
                        $entity-&gt;getResourceName(),
                        $entity-&gt;getId(),
                        $oldValue,
                        $newValue,
                        $changeDate
                    );

                    $em-&gt;persist($audit);
                    $em-&gt;getUnitOfWork()
                       -&gt;computeChangeSet($class, $audit);
                }
            }
        }
    }
}
</code></pre>
<p>This approach can also be re-used or combined with several similiar
behaviours, like Taggable, Blamable, Commentable.</p>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://staging.doctrine-project.org/2010/02/18/symfony-live-2010.html">Symfony Live 2010</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-02-18
                            by
                                    jwage
                                    </p>

        <hr />

        <div>
            <p>This past week I had the pleasure of spending time in Paris, France
for the <a href="http://www.symfony-live.com">2010 Symfony Live</a>
conference. My first Symfony event was
<a href="http://www.symfonycamp.com">Symfony Camp</a> in 2008 which was a
great success. I also attended the first Symfony Live last year
where I spoke about <a href="http://www.sympalphp.org">Sympal</a> and
Doctrine. This time around the Symfony conference was an even
bigger success! The community around Symfony and Doctrine has grown
a great amount over the years and the event shows that! Many great
speakers and topics were present at the conference and it was very
exciting to get to be a part of it.</p>
<p>On the first day of the conference I was invited to speak about the
latest Doctrine 2! This is perfect timing as Fabien Potencier made
available the source code of
<a href="http://www.symfony-reloaded.org">Symfony 2</a> the following day. I
am very excited about what the future holds for PHP in the coming
years as Symfony 2 and Doctrine 2 are really revolutionary PHP
projects!</p>
<p>You can find the presentations given at the conference related to
Doctrine below:</p>
<ul><li class="dash"> <a href="http://www.slideshare.net/denderello/symfony-live-2010-using-doctrine-migrations">Using Doctrine Migrations</a></li>
<li class="dash"> <a href="http://www.slideshare.net/jwage/doctrine-2-not-the-same-old-php-orm">Doctrine 2: Not the same Old PHP ORM</a></li>
</ul>


        </div>

            </article>

    <nav class="mt-4">
        <ul class="pagination">
            <li class="page-item"><a class="page-link" href="https://staging.doctrine-project.org/blog/page/51.html">Newer Posts</a></li><br />
            <li class="page-item"><a class="page-link" href="https://staging.doctrine-project.org/blog/page/53.html">Older Posts</a></li>        </ul>
    </nav>
            </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://staging.doctrine-project.org/components/highlightjs/highlight.pack.js?3970aa"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?f32c09"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?36322d"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            new Main();

            new Search(projectSlug, versionSlug);
        </script>

        
        
        
            </body>
</html>
