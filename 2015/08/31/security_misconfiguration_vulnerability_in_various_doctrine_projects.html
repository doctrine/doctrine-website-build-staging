<!DOCTYPE html>
<html>
    <head>
        <title>Security Misconfiguration Vulnerability in various Doctrine projects - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="noindex">
        
            <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "NewsArticle",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://staging.doctrine-project.org/2015/08/31/security_misconfiguration_vulnerability_in_various_doctrine_projects.html"
        },
        "headline": "Security Misconfiguration Vulnerability in various Doctrine projects",
        "image": [
            "https://staging.doctrine-project.org/images/og.png"
        ],
        "datePublished": "2015-08-31T00:00:00+00:00",
        "dateModified": "2015-08-31T00:00:00+00:00",
        "author": {
            "@type": "Person",
            "name": "default"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Doctrine",
            "logo": {
                "@type": "ImageObject",
                "url": "https://staging.doctrine-project.org/images/og.png"
            }
        },
        "description": "We are releasing new versions of Doctrine Cache, Annotations, ORM and
MongoDB ODM today that fix a s"
    }
    </script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?aabb96" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/css/railscasts.css?6f6641" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/2015/08/31/security_misconfiguration_vulnerability_in_various_doctrine_projects.html" />
        <meta property="og:title" content="Security Misconfiguration Vulnerability in various Doctrine projects - Doctrine - PHP Database Tools" />
        <meta property="og:description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/reflection.html">Reflection</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="https://staging.doctrine-project.org/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/contribute/" id="navbarContributeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/">Contributor Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/maintainer/">Maintainer Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/website/">Contribute to Website</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
            <article>
        <header>
            <h2>Security Misconfiguration Vulnerability in various Doctrine projects</h2>
        </header>

        <p class="lead">
            Posted on 2015-08-31
                            by
                                    default
                                    </p>

        <hr />

        <div>
                <p>We are releasing new versions of Doctrine Cache, Annotations, ORM and
MongoDB ODM today that fix a security misconfiguration vulnerability.
This vulnerability was assigned CVE-2015-5723. It requires an attacker
to have direct access to a user of the server to be exploitable. We
consider exploitability to be low to medium.</p>
<p>Exploiting this vulnerability can allow attackers to perform local
arbitrary code execution with privileges of other users (privilege
escalation).</p>
<p><strong>You are only affected by this vulnerability, if your application runs
with a umask of 0.</strong></p>
<p>Please update:</p>
<ul>
<li>Annotations to 1.2.7</li>
<li>Cache to 1.4.2 or 1.3.2</li>
<li>Common to 2.5.1 or 2.4.3</li>
<li>ORM to 2.5.1 or 2.4.8</li>
<li>MongoDB ODM to 1.0.2</li>
<li>MongoDB ODM Bundle to 3.0.1</li>
</ul>
<p>If you want to check the fix or apply patch manually, we <a href="https://gist.github.com/beberlei/dc6e4b018988cba7e211">provide a Gist
with all
patches</a>.</p>
<p>If you cannot upgrade, see our notes below how to mitigate the problem
without having to patch the code.</p>
<p>We want to thank <a href="https://twitter.com/squiddlane">Ryan Lane</a> for finding
the vulnerability, <a href="https://github.com/jeskew">Jonathan Eskew</a> from the
AWS team to pass this security vulnerability to us and <a href="https://twitter.com/ircmaxell">Anthony
Ferrara</a> for helping us discuss and find
solutions to the problem.</p>
<h1>Details</h1>
<p>Doctrine uses different kinds of caches and some of them read the cached
entries using <code>require</code> or <code>include</code> to make use of APC or Opcache. In
case of proxy generation we actually need to execute the code to make a
new auto-generated class part of the code-base.</p>
<p>Doctrine always uses <code>mkdir($cacheDirectory, 0777);</code> on many of those
caches directories. If your application is running with <code>umask(0)</code>, this
allows an attacker to write arbitrary code into the cache directory
which can be executed with the user privileges of the webserver.</p>
<p>Running your application with <code>umask(0)</code> is not generally a good idea,
but is sometimes recommended as simple solution to solve filesystem
access problems when a console and a web user both write to a common
cache directory. In combination with a cache that executes the cache
entries as code, this can allow local arbitrary code execution.</p>
<p>The patches released today change all caches that execute code to always
use a default mask of <code>0775</code> instead of <code>0777</code>.</p>
<ul>
<li>In case of Cache and Annotations we solve this by implementing a
userland configurable umask that defaults to <code>0002</code>. We apply this
to every mkdir and chmod so that you can reconfigure to another mask
if you must.</li>
<li>In all the other cases its a hardcoded change to <code>0775</code> for
directories and <code>0664</code> for files.</li>
</ul>
<p>We are aware that if you depend on <code>umask(0)</code>, this is a very
inconvenient change, because your code will break when different users
write to the same cache directory.</p>
<p><strong>We feel it is not safe to make developers and operations responsible
to know how to secure our cache implementations. They are often third
party libraries to other open-source systems, we want them to be safe no
matter how users configure their system.</strong></p>
<h1>Am I vulnerable?</h1>
<p>Your application must run with <code>umask(0)</code> for this vulnerability to be
exploitable. This must not necessarily be an explicit call to the PHP
function, it can also happen if you misconfigured your shell or
webserver to run with umask 0 by default.</p>
<p>You can easily check this by calling <code>echo umask();</code> from both the shell
and your webserver. It will return 0, if you are potentially vulnerable.</p>
<p>Second, you must be using using Doctrine with the Annotations FileCache
or the PhpFileCache Cache implementation or one of the ORM or ODM
ProxyGenerators. Of course this vulnerability can also be present in any
other library or your own application, when you dynamically generate PHP
code into a directory with world writable permissions.</p>
<h1>Do you provide fixes for all branches of all affected components?</h1>
<p>No, fixes are only applied to the most recent versions of Doctrine
components.</p>
<p>If you are running older components and don't want to or cannot upgrade,
you should look into the sections about immediate and proper fixes
below, that show solutions that don't require upgrading your code.</p>
<p>If your system and application are correctly setup, it is also likely
that you are not vulnerable. See the next section for information about
that.</p>
<h1>Is there an immediate fix when I can't upgrade?</h1>
<p>Yes, as an immediate fix just make sure that your application runs with
a non-zero umask all the time. Call <code>umask(umask() | 0002);</code> early in
your code to prevent PHP from ever creating world writeable files and
directories.</p>
<p>Warning: It can break your application if it relies on running with
<code>umask(0);</code>.</p>
<p>This is not sufficient though, because the call to umask is not thread
safe and a call to this function later in the code can reset the umask
for all requests currently running. That means you must identify all
code that calls <code>umask(0);</code> and change it.</p>
<p>When you are unsure if your generated cache is clean, you can regenerate
all files after you have changed the umask of your application.</p>
<h1>Is there a proper fix or security best-practive to avoid this issue?</h1>
<p>Yes, the best way to fix this problem is to always execute PHP code for
a single application with the same user, independent of being called
from the webserver, php-fpm or the shell. In this case you can always
create directories with the default permissions of <code>0775</code> and files with
<code>0664</code>:</p>
<pre><code class="language-{.sourceCode .php}">&lt;?php
// safety measure to overrule webserver or shell misconfiguration
umask(umask() | 0002);

mkdir("/some/directory", 0775);
file_put_contents("/some/directory/file", "data");
chmod("/some/directory/file", 0664);</code></pre>
<p>On most linux distributions it is possible to execute cronjobs or
supervisord jobs with the <code>www-data</code>, <code>nginx</code> or <code>apache</code> users that the
webserver runs with.</p>
<p>Another way would be to use more advanced permission systems in Linux
such as <code>chmod +a</code> or <code>setfacl</code>, both of which are not available on all
distributions though.</p>
<h1>Isn't everyone just using 0777/0666 everywhere?</h1>
<p>Yes, this practice is extremely wide-spread in many projects. This is
why we think it is very important to make sure your application runs
with a proper umask.</p>
<p>However, in our case the potential vulnerability is more severe than
usual, because we use <code>require/include</code> to execute the written cache
files, which can allow an attacker with access to a local user the
possibility for executing arbitrary code with the webservers user.</p>
<p>Code that is reading the generted/cache files using
<code>fopen/file_get_contents</code> could &quot;only&quot; be poisoned with invalid or wrong
data by an attacker. This is severe by itself, but does not allow
arbitrary code execution.</p>
<p>We want users of Doctrine to be safe by default, so we are changing this
even if it will cause inconveniences.</p>
<p>We have also notified as many OSS projects of this beforehand, mainly
through PHP-FIG, because of the wide-spread practice. Several of them
are preparing security releases for their libraries as well.</p>
<p>Again, the nature of this issue is mostly remedied by <strong>not</strong> running
with umask of zero, so make sure this is the case for your applications.</p>
<h1>Questions?</h1>
<p>If you have questions you can signup to the <a href="https://groups.google.com/forum/#!forum/doctrine-user">Doctrine User
Mailinglist</a> and
ask there or join <code>#doctrine</code> IRC Channel on Freenode.</p>
        </div>
    </article>
    </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://cdn.ravenjs.com/3.24.2/raven.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            Raven.config('https://09ce137590054cfd8f0b7e9324d6ec14@sentry.io/1197701').install()
        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?850a2b"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?21d569"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            new Main();

            new Search(projectSlug, versionSlug);

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }

            function googleTranslateElementInit() {
                $('#google_translate_element').html('');

                new google.translate.TranslateElement(
                    {pageLanguage: 'en'}, 'google_translate_element'
                );

                $('#google_translate_element select').on('change', function() {
                    var language = $('#google_translate_element select option:selected').text();

                    googleAnalyticsEvent('Translate', 'click', language);
                });
            }
        </script>

        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>

        
        
            </body>
</html>
