<!DOCTYPE html>
<html>
    <head>
        <title>PHPCR ODM QueryBuilder v2 - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <meta name="robots" content="index, follow">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                <article>
        <header>
            <h2>PHPCR ODM QueryBuilder v2 <small>post</small></h2>
        </header>

        <p class="lead">
            Posted on 2013-09-25
                            by
                                    dantleech
                                    </p>

        <div>
            <p>managed to merge the new query builder.</p>
<p>I developed the original query builder about 9 months ago - it was one of my
first contributions to the PHPCR-ODM doctrine project. It was heavily based on
the ORM query builder and the consensus being that we should make the ODM as
intuitive as possible for existing ORM users.</p>
<p>Abstracting PHPCR to fit the existing interface worked up until a point, we
could implement the <em>basic</em> functionality of the ORM Query Builder exactly,
things started to come undone when we looked at implementing joins.</p>
<p>I had added the joins in the API but didn't get around to implementing them, the
methods just threw &quot;not implemented&quot; exceptions. Later, when we wanted to
implement them, it wasn't so simple. Infact, upon closer inspection, many of
the things available in the PHPCR API's Query Object Model interface were not
covered by the model of the query builder we had chosen, in short, it was not
fit for purpose. I expounded this on the following wiki page:</p>
<ul><li>https://github.com/symfony-cmf/symfony-cmf/wiki/Query-Builder-v2</li>
</ul>

<p>As detailed in the above linked page, it seemed to me that either we
implemented a 2 part factory heavy query builder or a fluent node based query
builder. The node based design won. However, at the time I never imagined it
would take so long to write! So nearly 2 months later here we are.</p>
<p>Some features of the new query builder</p>
<ul><li>Can fully express the PHPCR QOM (Query Object Model).</li>
<li>Features a fluent interface.</li>
<li>Strict validation and helpful exception messages.</li>
<li>Less verbose than the PHPCR QOM model.</li>
</ul>

<p>Lets compare a PHPCR QOM query with its new query builder counterpart:</p>
<p>The following two examples are equivalent and both select a blog posts with node
name &quot;My Post Title&quot; having the ODM class &quot;Blog\Post&quot;. We order the result set
first by publishing date and then by title.</p>
<p>Using the PHPCR QOM:</p>
<pre><code class="php">&lt;?php
$q = $qom-&gt;createQuery(
    // SourceInterface (from)
    $qom-&gt;selector('nt:unstructured', 'p')
    $qom-&gt;andConstraint(
        $qom-&gt;comparison(
            $qom-&gt;propertyValue('p', 'phpcr:class'),
            $qom-&gt;bindVariableValue('phpcr_class'),
            QueryObjectModelInterface::JCR_OPERATOR_EQUAL_TO
        ),
        $qom-&gt;comparison(
            $qom-&gt;nodeLocalName('p'),
            $qom-&gt;bindVariableValue('post_title'),
            QueryObjectModelInterface::JCR_OPERATOR_EQUAL_TO
        ),
        array(
            $qom-&gt;ascending($qom-&gt;propertyValue('published_on', 'p'))
            $qom-&gt;ascending($qom-&gt;propertyValue('title', 'p'))
        )
    )
);
$q-&gt;bindValue('phpcr_class', 'Blog\Post');
$q-&gt;bindValue('post_title', 'My Post Title');
$res = $q-&gt;execute();
</code></pre>
<p>Using the new PHPCR-ODM query builder:</p>
<pre><code class="php">&lt;?php
$q = $documentManager-&gt;createQueryBuilder()
    -&gt;fromDocument('Blog\Post', 'p')
    -&gt;where()
        -&gt;eq()-&gt;field('p.title')-&gt;parameter('post_title')-&gt;end()
    -&gt;end()
    -&gt;orderBy()
        -&gt;asc()-&gt;field('p.published_on')-&gt;end()
        -&gt;asc()-&gt;field('p.title')-&gt;end()
    -&gt;end()
    -&gt;setParameter('post_title', 'My Post Title')
    -&gt;getQuery();
$res = $q-&gt;execute();
</code></pre>
<p>Whilst the two examples above are equivalent it should be noted that we are
being slightly unfair to the PHPCR QOM as we are forced to add the
<code>phpcr:class</code> constraint, which is a PHPCR-ODMism. Despite this, the new API
is clearly less verbose and, I hope, more intelligible.</p>
<p>The API allows chaining together operands:</p>
<pre><code class="php">&lt;?php
$qb = $documentManager-&gt;createQueryBuilder();
$qb
    -&gt;from()
        -&gt;document('Blog\Post', 'p')
    -&gt;end()
    -&gt;where()
        -&gt;andX()
            -&gt;orX()
                -&gt;eq()-&gt;upperCase()-&gt;field('p.username')-&gt;end()-&gt;literal('DANTLEECH')-&gt;end()
                -&gt;eq()-&gt;field('c.initials')-&gt;literal('dtl')-&gt;end()
            -&gt;end()
            -&gt;lte()-&gt;field('p.published_on')-&gt;literal('2013-09-14')-&gt;end()
        -&gt;end()
    -&gt;end();
</code></pre>
<p>The API also allows you to break the query into multiple statements:</p>
<pre><code class="php">&lt;?php
$qb-&gt;from()-&gt;document('Blog\Post', 'p');
$qb-&gt;where()-&gt;eq()-&gt;field('p.title')-&gt;literal('Foobar');
$qb-&gt;orderBy()-&gt;asc()-&gt;field('p.title');
</code></pre>
<p>And to add extra criteria to an existing query builder instance (useful if the query
builder is instantiated and initialized by a vendor library):</p>
<pre><code class="php">&lt;?php
class MyExtension
{
    public function modifyQuery(QueryBuilder $qb)
    {
        $qb-&gt;andWhere()-&gt;field('f.site_id')-&gt;literal(1);
    }
}
</code></pre>
<p>As a bonus, the nature of the API also allows us to easily add multiple
constraints to <code>andX</code> and <code>orX</code> operator nodes, something not easily
done with the native PHPCR builder:</p>
<pre><code class="php">&lt;?php
$qb-&gt;fromDocument('Blog\Post', 'p');

// we can add one or many constraints to an &quot;andX&quot; node...
$qb-&gt;where()-&gt;andX()
    -&gt;fieldIsset('p.username')
    -&gt;gt()-&gt;field('p.rank')-&gt;literal(50)-&gt;end()
    -&gt;eq()-&gt;fueld('p.title')-&gt;literal('This is a title');

</code></pre>
<p>The documentation is now online and is made up of both a guide and a reference:</p>
<ul><li>Guide: http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/query-builder.html</li>
<li>Reference: http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/query-builder-reference.html</li>
</ul>


        </div>
                
                    <nav class="article">
                <ul class="pagination">
                                            <li class="page-item"><a class="page-link previous" href="https://new.doctrine-project.org/2013/09/11/doctrine-2-4-released" title="Doctrine 2.4 released"><span class="title">Previous: Doctrine 2.4 released</span></a></li>
                                                                <li class="page-item"><a class="page-link next" href="https://new.doctrine-project.org/2013/11/12/doctrine-2-4-1" title="Doctrine 2.4.1 released"><span class="title">Next: Doctrine 2.4.1 released</span></a></li>
                                    </ul>
            </nav>
            </article>



        </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
