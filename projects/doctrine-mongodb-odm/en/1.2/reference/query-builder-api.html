<!DOCTYPE html>
<html>
    <head>
        <title>Query Builder API - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                                                                
                                
                                                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/">Home</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/">Projects</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/doctrine-mongodb-odm/en/1.2/">Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Query Builder API</li>
                        </ol>
                    </nav>
                
                                    <ul class="list-inline float-right">
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-mongodb-odm/en/latest/reference/query-builder-api.html" class="badge badge-secondary">master</a>
                            </li>
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-mongodb-odm/en/1.2/reference/query-builder-api.html" class="badge badge-primary">1.2</a>
                            </li>
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-mongodb-odm/en/1.1/reference/query-builder-api.html" class="badge badge-secondary">1.1</a>
                            </li>
                                            </ul>
                
                <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>
<h1 class="section-header" id="title.1"><a href="#title.1">Query Builder API<i class="fas fa-link"></i></a></h1>
<div class="role"><p>Querying for documents with Doctrine is just as simple as if you
weren't using Doctrine at all. Of course you always have your
traditional <code>find()</code> and <code>findOne()</code> methods but you also have
a <code>Query</code> object with a fluent API for defining the query that
should be executed.</p></div>
<p>The <code>Query</code> object supports several types of queries</p>
<ul><li class="dash">FIND</li>
<li class="dash">FIND_AND_UPDATE</li>
<li class="dash">FIND_AND_REMOVE</li>
<li class="dash">INSERT</li>
<li class="dash">UPDATE</li>
<li class="dash">REMOVE</li>
<li class="dash">GROUP</li>
<li class="dash">MAP_REDUCE</li>
<li class="dash">DISTINCT_FIELD</li>
<li class="dash">GEO_LOCATION</li>
</ul>

<p>This section will show examples for the different types of queries.</p>
<h2 class="section-header" id="title.1.1"><a href="#title.1.1">Finding Documents<i class="fas fa-link"></i></a></h2>
<p>You have a few different ways to find documents. You can use the <code>find()</code> method
to find a document by its identifier:</p>
<pre><code class="php">&lt;?php

$users = $dm-&gt;find('User', $id);
</code></pre>
<p>The <code>find()</code> method is just a convenience shortcut method to:</p>
<pre><code class="php">&lt;?php

$user = $dm-&gt;getRepository('User')-&gt;find($id);
</code></pre>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>The <code>find()</code> method checks the local in memory identity map for the document
before querying the database for the document.</p>
</div>
<p>On the <code>DocumentRepository</code> you have a few other methods for finding documents:</p>
<ul><li class="dash"><code>findBy</code> - find documents by an array of criteria</li>
<li class="dash"><code>findOneBy</code> - find one document by an array of criteria</li>
</ul>

<pre><code class="php">&lt;?php

$users = $dm-&gt;getRepository('User')-&gt;findBy(array('type' =&gt; 'employee'));
$user = $dm-&gt;getRepository('User')-&gt;findOneBy(array('username' =&gt; 'jwage'));
</code></pre>
<h2 class="section-header" id="title.1.2"><a href="#title.1.2">Creating a Query Builder<i class="fas fa-link"></i></a></h2>
<p>You can easily create a new <code>Query\Builder</code> object with the
<code>DocumentManager::createQueryBuilder()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User');
</code></pre>
<p>The first and only argument is optional, you can specify it later
with the <code>find()</code>, <code>update()</code> (deprecated), <code>updateOne()</code>,
<code>updateMany()</code> or <code>remove()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder();

// ...

$qb-&gt;find('User');
</code></pre>
<h3 class="section-header" id="title.1.2.1"><a href="#title.1.2.1">Executing Queries<i class="fas fa-link"></i></a></h3>
<p>You can execute a query by getting a <code>Query</code> through the <code>getQuery()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User');
$query = $qb-&gt;getQuery();
</code></pre>
<p>Now you can <code>execute()</code> that query and it will return a cursor for you to iterate over the results:</p>
<pre><code class="php">&lt;?php

$users = $query-&gt;execute();
</code></pre>
<h3 class="section-header" id="title.1.2.2"><a href="#title.1.2.2">Debugging Queries<i class="fas fa-link"></i></a></h3>
<p>While building not complicated queries is really simple sometimes it might be hard to wrap your head
around more sophisticated queries that involves building separate expressions to work properly. If
you are not sure if your the query constructed with Builder is in fact correct you may want to <code>debug()</code> it</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User');
$query = $qb-&gt;getQuery();
$debug = $query-&gt;debug();
</code></pre>
<p>At this point your query is <em>prepared</em> - that means ODM done all its job in renaming fields to match their
database name, added discriminator fields, applied filters, created correct references and all other things
you employ ODM to. The array returned by <code>-&gt;debug()</code> is what is passed to the underlying driver for the
query to be performed.</p>
<h3 class="section-header" id="title.1.2.3"><a href="#title.1.2.3">Eager Cursors<i class="fas fa-link"></i></a></h3>
<p>You can configure queries to return an eager cursor instead of a normal mongodb cursor using the <code>Builder#eagerCursor()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;eagerCursor(true);
$query = $qb-&gt;getQuery();
$cursor = $query-&gt;execute(); // instanceof Doctrine\ODM\MongoDB\EagerCursor
</code></pre>
<p>Iterating over the <code>$cursor</code> will fetch all the data in a short and small cursor all at once and will hydrate
one document at a time in to an object as you iterate:</p>
<pre><code class="php">&lt;?php

foreach ($cursor as $user) { // queries for all users and data is held internally
    // each User object is hydrated from the data one at a time.
}
</code></pre>
<h3 class="section-header" id="title.1.2.4"><a href="#title.1.2.4">Getting Single Result<i class="fas fa-link"></i></a></h3>
<p>If you want to just get a single result you can use the <code>Query#getSingleResult()</code> method:</p>
<pre><code class="php">&lt;?php

$user = $dm-&gt;createQueryBuilder('User')
    -&gt;field('username')-&gt;equals('jwage')
    -&gt;getQuery()
    -&gt;getSingleResult();
</code></pre>
<h3 class="section-header" id="title.1.2.5"><a href="#title.1.2.5">Selecting Fields<i class="fas fa-link"></i></a></h3>
<p>You can limit the fields that are returned in the results by using
the <code>select()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;select('username', 'password');
$query = $qb-&gt;getQuery();
$users = $query-&gt;execute();
</code></pre>
<p>In the results only the data from the username and password will be
returned.</p>
<h3 class="section-header" id="title.1.2.6"><a href="#title.1.2.6">Index hints<i class="fas fa-link"></i></a></h3>
<p>You can force MongoDB to use a specific index for a query with the <code>hint()</code> method (see <a href="https://docs.mongodb.com/manual/reference/operator/meta/hint/">hint</a>)</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;hint('user_pass_idx');
$query = $qb-&gt;getQuery();
$users = $query-&gt;execute();
</code></pre>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>Combining <code>select()</code> and  <code>hint()</code> on appropriate indexes can result in very fast
<a href="https://docs.mongodb.com/manual/core/query-optimization/#covered-query">covered queries</a></p>
</div>
<h3 class="section-header" id="title.1.2.7"><a href="#title.1.2.7">Selecting Distinct Values<i class="fas fa-link"></i></a></h3>
<p>Sometimes you may want to get an array of distinct values in a
collection. You can accomplish this using the <code>distinct()</code>
method:</p>
<pre><code class="php">&lt;?php

$ages = $dm-&gt;createQueryBuilder('User')
    -&gt;distinct('age')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>The above would give you an <code>ArrayCollection</code> of all the distinct user ages!</p>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>MongoDB's <a href="https://docs.mongodb.com/manual/reference/command/distinct/">distinct command</a>
does not support sorting, so you cannot combine <code>distinct()</code> with
<code>sort()</code>. If you would like to sort the results of a distinct query, you
will need to do so in PHP after executing the query.</p>
</div>
<h3 class="section-header" id="title.1.2.8"><a href="#title.1.2.8">Refreshing Documents<i class="fas fa-link"></i></a></h3>
<p>When a query (e.g. find) returns one or more hydrated documents whose
identifiers are already in the identity map, ODM returns the managed document
instances for those results. In this case, a managed document's data may differ
from whatever was just returned by the database query.</p>
<p>The query builder's <code>refresh()</code> method may be used to instruct ODM to override
the managed document with data from the query result. This is comparable to
calling <code>DocumentManager::refresh()</code> for a managed document. The document's
changeset will be reset in the process.</p>
<pre><code class="php">&lt;?php

$user = $dm-&gt;createQueryBuilder('User')
    -&gt;field('username')-&gt;equals('jwage')
    -&gt;refresh()
    -&gt;getQuery()
    -&gt;getSingleResult();

// Jon's user will have the latest data, even if it was already managed
</code></pre>
<p>Refreshing is not applicable if hydration is disabled.</p>
<h3 class="section-header" id="title.1.2.9"><a href="#title.1.2.9">Fetching Documents as Read-Only<i class="fas fa-link"></i></a></h3>
<p>Similar to <code>refresh()</code>, <code>readOnly()</code> instructs ODM to not only hydrate the
latest data but also to create new document's instance (i.e. if found document
would be already managed by Doctrine, new instance will be returned) and not
register it in <code>UnitOfWork</code>.</p>
<p>This technique can prove especially useful when using <code>select()</code> with no intent
to update fetched documents.</p>
<pre><code class="php">&lt;?php

$user = $dm-&gt;createQueryBuilder('User')
    -&gt;field('username')-&gt;equals('malarzm')
    -&gt;readOnly()
    -&gt;getQuery()
    -&gt;getSingleResult();

// Maciej's user will have the latest data, and will not be the same object
// as the one that was already managed (if it was)
</code></pre>
<p>Read-Only is not applicable if hydration is disabled.</p>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>Read-only mode is not deep, i.e. any references (be it owning or inverse) of
fetched WILL be managed by Doctrine. This is a shortcoming of current
implementation, may change in future and will not be considered a BC break
(will be treated as a feature instead).</p>
</div>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>To manage a document previously fetched in read-only mode, always use the
`merge` method of the DocumentManager. Using `persist` in these cases can
have unwanted side effects.</p>
</div>
<h3 class="section-header" id="title.1.2.10"><a href="#title.1.2.10">Disabling Hydration<i class="fas fa-link"></i></a></h3>
<p>For find queries the results by default are hydrated and you get
document objects back instead of arrays. You can disable this and
get the raw results directly back from mongo by using the
<code>hydrate(false)</code> method:</p>
<pre><code class="php">&lt;?php

$users = $dm-&gt;createQueryBuilder('User')
    -&gt;hydrate(false)
    -&gt;getQuery()
    -&gt;execute();

print_r($users);
</code></pre>
<h3 class="section-header" id="title.1.2.11"><a href="#title.1.2.11">Limiting Results<i class="fas fa-link"></i></a></h3>
<p>You can limit results similar to how you would in a relational
database with a limit and offset by using the <code>limit()</code> and
<code>skip()</code> method.</p>
<p>Here is an example where we get the third page of blog posts when
we show twenty at a time:</p>
<pre><code class="php">&lt;?php

$blogPosts = $dm-&gt;createQueryBuilder('BlogPost')
    -&gt;limit(20)
    -&gt;skip(40)
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<h3 class="section-header" id="title.1.2.12"><a href="#title.1.2.12">Sorting Results<i class="fas fa-link"></i></a></h3>
<p>You can sort the results by using the <code>sort()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Article')
    -&gt;sort('createdAt', 'desc');
</code></pre>
<p>If you want to an additional sort you can call <code>sort()</code> again. The calls are stacked and ordered
in the order you call the method:</p>
<pre><code class="php">&lt;?php

$query-&gt;sort('featured', 'desc');
</code></pre>
<h3 class="section-header" id="title.1.2.13"><a href="#title.1.2.13">Map Reduce<i class="fas fa-link"></i></a></h3>
<p>You can also run map reduced find queries using the <code>Query</code>
object:</p>
<pre><code class="php">&lt;?php

$qb = $this-&gt;dm-&gt;createQueryBuilder('Event')
    -&gt;field('type')-&gt;equals('sale')
    -&gt;map('function() { emit(this.userId, 1); }')
    -&gt;reduce(&quot;function(k, vals) {
        var sum = 0;
        for (var i in vals) {
            sum += vals[i];
        }
        return sum;
    }&quot;);
$query = $qb-&gt;getQuery();
$results = $query-&gt;execute();
</code></pre>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>When you specify a <code>map()</code> and <code>reduce()</code> operation
the results will not be hydrated and the raw results from the map
reduce operation will be returned.</p>
</div>
<p>If you just want to reduce the results using a javascript function
you can just call the <code>where()</code> method:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;where(&quot;function() { return this.type == 'admin'; }&quot;);
</code></pre>
<p>You can read more about the <a href="https://docs.mongodb.com/manual/reference/operator/query/where/">$where operator</a> in the Mongo docs.</p>
<h3 class="section-header" id="title.1.2.14"><a href="#title.1.2.14">Conditional Operators<i class="fas fa-link"></i></a></h3>
<p>The conditional operators in Mongo are available to limit the returned results through a easy to use API. Doctrine abstracts this to a fluent object oriented interface with a fluent API. Here is a list of all the conditional operation methods you can use on the `Query\Builder` object.</p>
<ul><li><code>where($javascript)</code></li>
<li><code>in($values)</code></li>
<li><code>notIn($values)</code></li>
<li><code>equals($value)</code></li>
<li><code>notEqual($value)</code></li>
<li><code>gt($value)</code></li>
<li><code>gte($value)</code></li>
<li><code>lt($value)</code></li>
<li><code>lte($value)</code></li>
<li><code>range($start, $end)</code></li>
<li><code>size($size)</code></li>
<li><code>exists($bool)</code></li>
<li><code>type($type)</code></li>
<li><code>all($values)</code></li>
<li><code>mod($mod)</code></li>
<li><code>addOr($expr)</code></li>
<li><code>references($document)</code></li>
<li><code>includesReferenceTo($document)</code></li>
</ul>

<p>Query for active administrator users:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;field('type')-&gt;equals('admin')
    -&gt;field('active')-&gt;equals(true);
</code></pre>
<p>Query for articles that have some tags:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Article')
    -&gt;field('tags.name')-&gt;in(array('tag1', 'tag2'));
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/in/">$in operator</a>
in the Mongo docs</p>
<p>Query for articles that do not have some tags:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Article')
    -&gt;field('tags.name')-&gt;notIn(array('tag3'));
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/nin/">$nin operator</a>
in the Mongo docs.</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;field('type')-&gt;notEqual('admin');
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/ne/">$ne operator</a>
in the Mongo docs.</p>
<p>Query for accounts with an amount due greater than 30:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Account')
    -&gt;field('amount_due')-&gt;gt(30);
</code></pre>
<p>Query for accounts with an amount due greater than or equal to 30:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Account')
    -&gt;field('amount_due')-&gt;gte(30);
</code></pre>
<p>Query for accounts with an amount due less than 30:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Account')
    -&gt;field('amount_due')-&gt;lt(30);
</code></pre>
<p>Query for accounts with an amount due less than or equal to 30:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Account')
    -&gt;field('amount_due')-&gt;lte(30);
</code></pre>
<p>Query for accounts with an amount due between 10 and 20:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Account')
    -&gt;field('amount_due')-&gt;range(10, 20);
</code></pre>
<p>Read more about
<a href="http://www.mongodb.org/display/DOCS/Advanced+Queries#AdvancedQueries-ConditionalOperators%3A%3C%2C%3C%3D%2C%3E%2C%3E%3D">conditional operators</a>
in the Mongo docs.</p>
<p>Query for articles with no comments:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Article')
    -&gt;field('comments')-&gt;size(0);
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/size/">$size operator</a>
in the Mongo docs.</p>
<p>Query for users that have a login field before it was renamed to
username:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;field('login')-&gt;exists(true);
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/exists/">$exists operator</a>
in the Mongo docs.</p>
<p>Query for users that have a type field that is of integer bson
type:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;field('type')-&gt;type('integer');
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/type/">$type operator</a>
in the Mongo docs.</p>
<p>Query for users that are in all the specified Groups:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;field('groups')-&gt;all(array('Group 1', 'Group 2'));
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/all/">$all operator</a>
in the Mongo docs.</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Transaction')
    -&gt;field('field')-&gt;mod('field', array(10, 1));
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/mod/">$mod operator</a> in the Mongo docs.</p>
<p>Query for users who have subscribed or are in a trial.</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('User');
$qb-&gt;addOr($qb-&gt;expr()-&gt;field('subscriber')-&gt;equals(true));
$qb-&gt;addOr($qb-&gt;expr()-&gt;field('inTrial')-&gt;equals(true));
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/query/or/">$or operator</a> in the Mongo docs.</p>
<p>The <code>references()</code> method may be used to query the owning side of a
<a href="annotations_reference_reference_one.html">@ReferenceOne</a> relationship. In the
following example, we query for all articles written by a particular user.</p>
<pre><code class="php">&lt;?php

// Suppose $user has already been fetched from the database
$qb = $dm-&gt;createQueryBuilder('Article')
    -&gt;field('user')-&gt;references($user);
</code></pre>
<p>The <code>includesReferenceTo()</code> method may be used to query the owning side of a
<a href="annotations_reference_reference_many.html">@ReferenceMany</a> relationship. In
the following example, we query for the user(s) that have access to a particular
account.</p>
<pre><code class="php">&lt;?php

// Suppose $account has already been fetched from the database
$qb = $dm-&gt;createQueryBuilder('User')
    -&gt;field('accounts')-&gt;includesReferenceTo($account);
</code></pre>
<h3 class="section-header" id="title.1.2.15"><a href="#title.1.2.15">Text Search<i class="fas fa-link"></i></a></h3>
<p>You can use the
<a href="https://docs.mongodb.com/manual/reference/operator/query/text/">$text operator</a>
to run a text search against a field with a text index. To do so, create a
document with a text index:</p>
<pre><code class="php">&lt;?php

/**
 * @Document
 * @Index(keys={&quot;description&quot;=&quot;text&quot;})
 */
class Document
{
    /** @Id */
    public $id;

    /** @Field(type=&quot;string&quot;) */
    public $description;

    /** @Field(type=&quot;float&quot;) @NotSaved */
    public $score;
}
</code></pre>
<p>You can then run queries using the text operator:</p>
<pre><code class="php">&lt;?php

// Run a text search against the index
$qb = $dm-&gt;createQueryBuilder('Document')
    -&gt;text('words you are looking for');
</code></pre>
<p>To fetch the calculated score for the text search, use the <code>selectMeta()</code>
method:</p>
<pre><code class="php">&lt;?php

// Run a text search against the index
$qb = $dm-&gt;createQueryBuilder('Document')
    -&gt;selectMeta('score', 'textScore')
    -&gt;text('words you are looking for');
</code></pre>
<p>You can also change the language used for stemming using the <code>language()</code>
method:</p>
<pre><code class="php">&lt;?php

// Run a text search against the index
$qb = $dm-&gt;createQueryBuilder('Document')
    -&gt;language('it')
    -&gt;text('parole che stai cercando');
</code></pre>
<h3 class="section-header" id="title.1.2.16"><a href="#title.1.2.16">Update Queries<i class="fas fa-link"></i></a></h3>
<p>Doctrine also supports executing atomic update queries using the `Query\Builder`
object. You can use the conditional operations in combination with the ability to
change document field values atomically. Additionally if you are modifying a field
that is a reference you can pass managed document to the Builder and let ODM build
<code>DBRef</code> object for you.</p>
<p>You have several modifier operations
available to you that make it easy to update documents in Mongo:</p>
<ul><li><code>set($name, $value, $atomic = true)</code></li>
<li><code>setNewObj($newObj)</code></li>
<li><code>inc($name, $value)</code></li>
<li><code>unsetField($field)</code></li>
<li><code>push($field, $value)</code></li>
<li><code>addToSet($field, $value)</code></li>
<li><code>popFirst($field)</code></li>
<li><code>popLast($field)</code></li>
<li><code>pull($field, $value)</code></li>
<li><code>pullAll($field, array $valueArray)</code></li>
</ul>

<h2 class="section-header" id="title.1.3"><a href="#title.1.3">Updating multiple documents<i class="fas fa-link"></i></a></h2>
<p>By default Mongo updates only one document unless <code>multi</code> option is provided and true.
In ODM the distinction is done by explicitly calling <code>updateMany()</code> method of the builder:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('User')
    -&gt;updateMany()
    -&gt;field('someField')-&gt;set('newValue')
    -&gt;field('username')-&gt;equals('sgoettschkes')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<h2 class="section-header" id="title.1.4"><a href="#title.1.4">Modifier Operations<i class="fas fa-link"></i></a></h2>
<p>Change a users password:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('User')
    -&gt;updateOne()
    -&gt;field('password')-&gt;set('newpassword')
    -&gt;field('username')-&gt;equals('jwage')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>If you want to just set the values of an entirely new object you
can do so by passing false as the third argument of <code>set()</code> to
tell it the update is not an atomic one:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('User')
    -&gt;updateOne()
    -&gt;field('username')-&gt;set('jwage', false)
    -&gt;field('password')-&gt;set('password', false)
    // ... set other remaining fields
    -&gt;field('username')-&gt;equals('jwage')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/set/">$set modifier</a>
in the Mongo docs.</p>
<p>You can set an entirely new object to update as well:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('User')
    -&gt;setNewObj(array(
        'username' =&gt; 'jwage',
        'password' =&gt; 'password',
        // ... other fields
    ))
    -&gt;field('username')-&gt;equals('jwage')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Increment the value of a document:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Package')
    -&gt;field('id')-&gt;equals('theid')
    -&gt;field('downloads')-&gt;inc(1)
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/inc/">$inc modifier</a>
in the Mongo docs.</p>
<p>Unset the login field from users where the login field still
exists:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('User')
    -&gt;updateMany()
    -&gt;field('login')-&gt;unsetField()-&gt;exists(true)
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/unset/">$unset modifier</a>
in the Mongo docs.</p>
<p>Append new tag to the tags array:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Article')
    -&gt;updateOne()
    -&gt;field('tags')-&gt;push('tag5')
    -&gt;field('id')-&gt;equals('theid')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/push/">$push modifier</a>
in the Mongo docs.</p>
<p>Append new tags to the tags array:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Article');
$qb-&gt;updateOne()
    -&gt;field('tags')-&gt;push($qb-&gt;expr()-&gt;each(array('tag6', 'tag7')))
    -&gt;field('id')-&gt;equals('theid')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Add value to array only if its not in the array already:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Article')
    -&gt;updateOne()
    -&gt;field('tags')-&gt;addToSet('tag1')
    -&gt;field('id')-&gt;equals('theid')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/addToSet/">$addToSet modifier</a>
in the Mongo docs.</p>
<p>Add many values to the array only if they do not exist in the array
already:</p>
<pre><code class="php">&lt;?php

$qb = $dm-&gt;createQueryBuilder('Article');
$qb-&gt;updateOne()
    -&gt;field('tags')-&gt;addToSet($qb-&gt;expr()-&gt;each(array('tag6', 'tag7')))
    -&gt;field('id')-&gt;equals('theid')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Remove first element in an array:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Article')
    -&gt;updateOne()
    -&gt;field('tags')-&gt;popFirst()
    -&gt;field('id')-&gt;equals('theid')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Remove last element in an array:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Article')
    -&gt;updateOne()
    -&gt;field('tags')-&gt;popLast()
    -&gt;field('id')-&gt;equals('theid')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/pop/">$pop modifier</a>
in the Mongo docs.</p>
<p>Remove all occurrences of value from array:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Article')
    -&gt;updateMany()
    -&gt;field('tags')-&gt;pull('tag1')
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/pull/">$pull modifier</a>
in the Mongo docs.</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('Article')
    -&gt;updateMany()
    -&gt;field('tags')-&gt;pullAll(array('tag1', 'tag2'))
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>Read more about the
<a href="https://docs.mongodb.com/manual/reference/operator/update/pullAll/">$pullAll modifier</a>
in the Mongo docs.</p>
<h2 class="section-header" id="title.1.5"><a href="#title.1.5">Remove Queries<i class="fas fa-link"></i></a></h2>
<p>In addition to updating you can also issue queries to remove
documents from a collection. It works pretty much the same way as
everything else and you can use the conditional operations to
specify which documents you want to remove.</p>
<p>Here is an example where we remove users who have never logged in:</p>
<pre><code class="php">&lt;?php

$dm-&gt;createQueryBuilder('User')
    -&gt;remove()
    -&gt;field('num_logins')-&gt;equals(0)
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<h2 class="section-header" id="title.1.6"><a href="#title.1.6">Group Queries<i class="fas fa-link"></i></a></h2>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>Due to deprecation of <code>group</code> command in MongoDB 3.4 the ODM
also deprecates its usage through Query Builder in 1.2. Please
use <a href="aggregation_builder_group.html">$group stage</a> of the
Aggregation Builder instead.</p>
</div>
<p>The last type of supported query is a group query. It performs an
operation similar to SQL's GROUP BY command.</p>
<pre><code class="php">&lt;?php

$result = $this-&gt;dm-&gt;createQueryBuilder('Documents\User')
    -&gt;group(array(), array('count' =&gt; 0))
    -&gt;reduce('function (obj, prev) { prev.count++; }')
    -&gt;field('a')-&gt;gt(1)
    -&gt;getQuery()
    -&gt;execute();
</code></pre>
<p>This is the same as if we were to do the group with the raw PHP
code:</p>
<pre><code class="php">&lt;?php

$reduce = 'function (obj, prev) { prev.count++; }';
$condition = array('a' =&gt; array( '$gt' =&gt; 1));
$result = $collection-&gt;group(array(), array('count' =&gt; 0), $reduce, $condition);
</code></pre>
</body>
</html>                    </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
