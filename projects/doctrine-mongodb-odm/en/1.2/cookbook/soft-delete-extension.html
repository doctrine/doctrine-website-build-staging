<!DOCTYPE html>
<html>
    <head>
        <title>Soft Delete Extension - MongoDB Object Document Mapper (MongoDB ODM)</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="PHP Doctrine MongoDB Object Document Mapper (ODM) provides transparent persistence for PHP objects to MongoDB.
">

        <meta name="keywords" content="php,mongodb,odm,mapper,mapping,object">

                    <meta name="robots" content="noindex">
        
                    <link rel="canonical" href="https://staging.doctrine-project.org/projects/doctrine-mongodb-odm/en/1.2/cookbook/soft-delete-extension.html" />
    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?3625e4" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/components/highlightjs/styles/railscasts.css?b4f8ae" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine-mongodb-odm/en/1.2/cookbook/soft-delete-extension.html" />
        <meta property="og:title" content="Soft Delete Extension - MongoDB Object Document Mapper (MongoDB ODM)" />
        <meta property="og:description" content="PHP Doctrine MongoDB Object Document Mapper (ODM) provides transparent persistence for PHP objects to MongoDB.
" />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Course",
            "name": "Doctrine MongoDB Object Document Mapper",
            "description": "Soft Delete Extension",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://staging.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu projects-dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/couchdb-odm.html">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>

                <div class="search-results rounded">
                    <div id="hits">
                        <!-- Hits widget will appear here -->
                    </div>

                    <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
                </div>
            </nav>
        
            <div class="container-wrapper container-fluid">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        
<div class="toc"><ul><li id="blending-orm-and-mongodb-odm-html-title-1" class="toc-item"><a href="blending-orm-and-mongodb-odm.html#title.1">Blending the ORM and MongoDB ODM</a></li><ul><li id="blending-orm-and-mongodb-odm-html-title-1-1" class="toc-item"><a href="blending-orm-and-mongodb-odm.html#title.1.1">Define Product</a></li><li id="blending-orm-and-mongodb-odm-html-title-1-2" class="toc-item"><a href="blending-orm-and-mongodb-odm.html#title.1.2">Define Entity</a></li><li id="blending-orm-and-mongodb-odm-html-title-1-3" class="toc-item"><a href="blending-orm-and-mongodb-odm.html#title.1.3">Event Subscriber</a></li><li id="blending-orm-and-mongodb-odm-html-title-1-4" class="toc-item"><a href="blending-orm-and-mongodb-odm.html#title.1.4">Working with Products and Orders</a></li></ul><li id="implementing-array-access-for-domain-objects-html-title-1" class="toc-item"><a href="implementing-array-access-for-domain-objects.html#title.1">Implementing ArrayAccess for Domain Objects</a></li><ul><li id="implementing-array-access-for-domain-objects-html-title-1-1" class="toc-item"><a href="implementing-array-access-for-domain-objects.html#title.1.1">Option 1</a></li><li id="implementing-array-access-for-domain-objects-html-title-1-2" class="toc-item"><a href="implementing-array-access-for-domain-objects.html#title.1.2">Option 2</a></li><li id="implementing-array-access-for-domain-objects-html-title-1-3" class="toc-item"><a href="implementing-array-access-for-domain-objects.html#title.1.3">Read-only</a></li></ul><li id="implementing-the-notify-changetracking-policy-html-title-1" class="toc-item"><a href="implementing-the-notify-changetracking-policy.html#title.1">Implementing the Notify ChangeTracking Policy</a></li><ul><li id="implementing-the-notify-changetracking-policy-html-title-1-1" class="toc-item"><a href="implementing-the-notify-changetracking-policy.html#title.1.1">Implementing NotifyPropertyChanged</a></li></ul><li id="implementing-wakeup-or-clone-html-title-1" class="toc-item"><a href="implementing-wakeup-or-clone.html#title.1">Implementing Wakeup or Clone</a></li><ul><li id="implementing-wakeup-or-clone-html-title-1-1" class="toc-item"><a href="implementing-wakeup-or-clone.html#title.1.1">Safely implementing \_\_wakeup</a></li><li id="implementing-wakeup-or-clone-html-title-1-2" class="toc-item"><a href="implementing-wakeup-or-clone.html#title.1.2">Safely implementing \_\_clone</a></li><li id="implementing-wakeup-or-clone-html-title-1-3" class="toc-item"><a href="implementing-wakeup-or-clone.html#title.1.3">Summary</a></li></ul><li id="mapping-classes-to-orm-and-odm-html-title-1" class="toc-item"><a href="mapping-classes-to-orm-and-odm.html#title.1">Mapping Classes to the ORM and ODM</a></li><ul><li id="mapping-classes-to-orm-and-odm-html-title-1-1" class="toc-item"><a href="mapping-classes-to-orm-and-odm.html#title.1.1">Test Subject</a></li><li id="mapping-classes-to-orm-and-odm-html-title-1-2" class="toc-item"><a href="mapping-classes-to-orm-and-odm.html#title.1.2">Mapping Information</a></li><ul><li id="mapping-classes-to-orm-and-odm-html-title-1-2-1" class="toc-item"><a href="mapping-classes-to-orm-and-odm.html#title.1.2.1">ORM</a></li><li id="mapping-classes-to-orm-and-odm-html-title-1-2-2" class="toc-item"><a href="mapping-classes-to-orm-and-odm.html#title.1.2.2">MongoDB ODM</a></li></ul><li id="mapping-classes-to-orm-and-odm-html-title-1-3" class="toc-item"><a href="mapping-classes-to-orm-and-odm.html#title.1.3">Repository Classes</a></li></ul><li id="resolve-target-document-listener-html-title-1" class="toc-item"><a href="resolve-target-document-listener.html#title.1">Keeping Your Modules Independent</a></li><ul><li id="resolve-target-document-listener-html-title-1-1" class="toc-item"><a href="resolve-target-document-listener.html#title.1.1">Background</a></li><li id="resolve-target-document-listener-html-title-1-2" class="toc-item"><a href="resolve-target-document-listener.html#title.1.2">Configuration</a></li><li id="resolve-target-document-listener-html-title-1-3" class="toc-item"><a href="resolve-target-document-listener.html#title.1.3">Final Thoughts</a></li></ul><li id="simple-search-engine-html-title-1" class="toc-item"><a href="simple-search-engine.html#title.1">Simple Search Engine</a></li><ul><li id="simple-search-engine-html-title-1-1" class="toc-item"><a href="simple-search-engine.html#title.1.1">Sample Model: Product</a></li><li id="simple-search-engine-html-title-1-2" class="toc-item"><a href="simple-search-engine.html#title.1.2">Working with Keywords</a></li><li id="simple-search-engine-html-title-1-3" class="toc-item"><a href="simple-search-engine.html#title.1.3">Searching Keywords</a></li><ul><li id="simple-search-engine-html-title-1-3-1" class="toc-item"><a href="simple-search-engine.html#title.1.3.1">User Input</a></li></ul><li id="simple-search-engine-html-title-1-4" class="toc-item"><a href="simple-search-engine.html#title.1.4">Embedded Documents</a></li><ul><li id="simple-search-engine-html-title-1-4-1" class="toc-item"><a href="simple-search-engine.html#title.1.4.1">Definition</a></li></ul></ul><li id="soft-delete-extension-html-title-1" class="toc-item"><a href="soft-delete-extension.html#title.1">Soft Delete Extension</a></li><ul><li id="soft-delete-extension-html-title-1-1" class="toc-item"><a href="soft-delete-extension.html#title.1.1">Installation</a></li><li id="soft-delete-extension-html-title-1-2" class="toc-item"><a href="soft-delete-extension.html#title.1.2">Setup</a></li><li id="soft-delete-extension-html-title-1-3" class="toc-item"><a href="soft-delete-extension.html#title.1.3">SoftDeleteable Interface</a></li><li id="soft-delete-extension-html-title-1-4" class="toc-item"><a href="soft-delete-extension.html#title.1.4">Example Implementation</a></li><li id="soft-delete-extension-html-title-1-5" class="toc-item"><a href="soft-delete-extension.html#title.1.5">Usage</a></li><li id="soft-delete-extension-html-title-1-6" class="toc-item"><a href="soft-delete-extension.html#title.1.6">Events</a></li><li id="soft-delete-extension-html-title-1-7" class="toc-item"><a href="soft-delete-extension.html#title.1.7">Cascading Soft Deletes</a></li></ul><li id="validation-of-documents-html-title-1" class="toc-item"><a href="validation-of-documents.html#title.1">Validation of Documents</a></li></ul></div>
                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects.html">Projects</a></li>
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a></li>
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine-mongodb-odm/en/1.2/">Documentation</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Soft Delete Extension</li>
                            </ol>
                        </nav>
                                    </div>

                
                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            <ul class="list-inline">
                                                                            <li class="list-inline-item mr-0">
                                            <a href="/projects/doctrine-mongodb-odm/en/latest/cookbook/soft-delete-extension.html" class="project-version-switcher badge badge-secondary">master</a>
                                        </li>
                                                                            <li class="list-inline-item mr-0">
                                            <a href="/projects/doctrine-mongodb-odm/en/1.2/cookbook/soft-delete-extension.html" class="project-version-switcher badge badge-warning">1.2</a>
                                        </li>
                                                                            <li class="list-inline-item mr-0">
                                            <a href="/projects/doctrine-mongodb-odm/en/1.1/cookbook/soft-delete-extension.html" class="project-version-switcher badge badge-secondary">1.1</a>
                                        </li>
                                    
                                    
                                    <li class="list-inline-item ml-2"><a href="https://github.com/doctrine/mongodb-odm/edit/1.2.x/docs/en/cookbook/soft-delete-extension.rst" class="badge badge-primary">Edit</a></li>

                                </ul>
                            
                            
<p></p>
<a class="section-anchor" id="title.1" name="title.1"></a><h1 class="section-header"><a href="#title.1">Soft Delete Extension<i class="fas fa-link"></i></a></h1>
<p>Sometimes you may not want to delete data from your database completely, but you want to
disable or temporarily delete some records so they do not appear anymore in your frontend.
Then, later you might want to restore that deleted data like it was never deleted.</p>
<p>This is possible with the <code>SoftDelete</code> extension which can be found on <a href="https://github.com/doctrine/mongodb-odm-softdelete">github</a>.</p>
<a class="section-anchor" id="title.1.1" name="title.1.1"></a><h2 class="section-header"><a href="#title.1.1">Installation<i class="fas fa-link"></i></a></h2>
<p>First you just need to get the code by cloning the <a href="https://github.com/doctrine/mongodb-odm-softdelete">github</a> repository:</p>
<pre><code class="console">$ git clone git://github.com/doctrine/mongodb-odm-softdelete.git
</code></pre>
<p>Now once you have the code you can setup the autoloader for it:</p>
<pre><code class="php">&lt;?php

$classLoader = new ClassLoader('Doctrine\ODM\MongoDB\SoftDelete', 'mongodb-odm-softdelete/lib');
$classLoader-&gt;register();
</code></pre>
<a class="section-anchor" id="title.1.2" name="title.1.2"></a><h2 class="section-header"><a href="#title.1.2">Setup<i class="fas fa-link"></i></a></h2>
<p>Now you can autoload the classes you need to setup the <code>SoftDeleteManager</code> instance you need to manage
the soft delete state of your documents:</p>
<pre><code class="php">&lt;?php

use Doctrine\ODM\MongoDB\SoftDelete\Configuration;
use Doctrine\ODM\MongoDB\SoftDelete\UnitOfWork;
use Doctrine\ODM\MongoDB\SoftDelete\SoftDeleteManager;
use Doctrine\Common\EventManager;

// $dm is a DocumentManager instance we should already have

$config = new Configuration();
$evm = new EventManager();
$sdm = new SoftDeleteManager($dm, $config, $evm);
</code></pre>
<a class="section-anchor" id="title.1.3" name="title.1.3"></a><h2 class="section-header"><a href="#title.1.3">SoftDeleteable Interface<i class="fas fa-link"></i></a></h2>
<p>In order for your documents to work with the SoftDelete functionality they must implement
the <code>SoftDeleteable</code> interface:</p>
<pre><code class="php">&lt;?php

interface SoftDeleteable
{
    function getDeletedAt();
}
</code></pre>
<a class="section-anchor" id="title.1.4" name="title.1.4"></a><h2 class="section-header"><a href="#title.1.4">Example Implementation<i class="fas fa-link"></i></a></h2>
<p>An implementation might look like this in a <code>User</code> document:</p>
<pre><code class="php">&lt;?php

use Doctrine\ODM\MongoDB\SoftDelete\SoftDeleteable;

/** @mongodb:Document */
class User implements SoftDeleteable
{
    // ...

    /** @mongodb:Date @mongodb:Index */
    private $deletedAt;

    public function getDeletedAt()
    {
        return $this-&gt;deletedAt;
    }

    // ...
}
</code></pre>
<a class="section-anchor" id="title.1.5" name="title.1.5"></a><h2 class="section-header"><a href="#title.1.5">Usage<i class="fas fa-link"></i></a></h2>
<p>Once you have the <code>$sdm</code> you can start managing the soft delete state of your documents:</p>
<pre><code class="php">&lt;?php

$jwage = $dm-&gt;getRepository('User')-&gt;findOneByUsername('jwage');
$fabpot = $dm-&gt;getRepository('User')-&gt;findOneByUsername('fabpot');
$sdm-&gt;delete($jwage);
$sdm-&gt;delete($fabpot);
$sdm-&gt;flush();
</code></pre>
<p>The call to <code>SoftDeleteManager#flush()</code> would persist the deleted state to the database
for all the documents it knows about and run a query like the following:</p>
<pre><code class="javascript">db.users.update({ _id : { $in : userIds }}, { $set : { deletedAt : new Date() } })
</code></pre>
<p>Now if we were to restore the documents:</p>
<pre><code class="php">&lt;?php

$sdm-&gt;restore($jwage);
$sdm-&gt;flush();
</code></pre>
<p>It would execute a query like the following:</p>
<pre><code class="javascript">db.users.update({ _id : { $in : userIds }}, { $unset : { deletedAt : true } })
</code></pre>
<a class="section-anchor" id="title.1.6" name="title.1.6"></a><h2 class="section-header"><a href="#title.1.6">Events<i class="fas fa-link"></i></a></h2>
<p>We trigger some additional lifecycle events when documents are soft deleted and restored:</p>
<ul><li class="dash">Events::preSoftDelete</li>
<li class="dash">Events::postSoftDelete</li>
<li class="dash">Events::preRestore</li>
<li class="dash">Events::postRestore</li>
</ul>

<p>Using the events is easy, just define a class like the following:</p>
<pre><code class="php">&lt;?php

class TestEventSubscriber implements \Doctrine\Common\EventSubscriber
{
    public function preSoftDelete(LifecycleEventArgs $args)
    {
        $document = $args-&gt;getDocument();
        $sdm = $args-&gt;getSoftDeleteManager();
    }

    public function getSubscribedEvents()
    {
        return array(Events::preSoftDelete);
    }
}
</code></pre>
<p>Now we just need to add the event subscriber to the EventManager:</p>
<pre><code class="php">&lt;?php

$eventSubscriber = new TestEventSubscriber();
$evm-&gt;addEventSubscriber($eventSubscriber);
</code></pre>
<p>When we soft delete something the preSoftDelete() method will be invoked before any queries are sent
to the database:</p>
<pre><code class="php">&lt;?php

$sdm-&gt;delete($fabpot);
$sdm-&gt;flush();
</code></pre>
<a class="section-anchor" id="title.1.7" name="title.1.7"></a><h2 class="section-header"><a href="#title.1.7">Cascading Soft Deletes<i class="fas fa-link"></i></a></h2>
<p>You can easily implement cascading soft deletes by using events in a certain way. Imagine you have
a User and Post document and you want to soft delete a users posts when you delete him.</p>
<p>You just need to setup an event listener like the following:</p>
<pre><code class="php">&lt;?php

use Doctrine\Common\EventSubscriber;
use Doctrine\ODM\MongoDB\SoftDelete\Event\LifecycleEventArgs;

class CascadingSoftDeleteListener implements EventSubscriber
{
    public function preSoftDelete(LifecycleEventArgs $args)
    {
        $sdm = $args-&gt;getSoftDeleteManager();
        $document = $args-&gt;getDocument();
        if ($document instanceof User) {
            $sdm-&gt;deleteBy('Post', array('user.id' =&gt; $document-&gt;getId()));
        }
    }

    public function preRestore(LifecycleEventArgs $args)
    {
        $sdm = $args-&gt;getSoftDeleteManager();
        $document = $args-&gt;getDocument();
        if ($document instanceof User) {
            $sdm-&gt;restoreBy('Post', array('user.id' =&gt; $document-&gt;getId()));
        }
    }

    public function getSubscribedEvents()
    {
        return array(
            Events::preSoftDelete,
            Events::preRestore
        );
    }
}
</code></pre>
<p>Now when you delete an instance of User it will also delete any Post documents where they
reference the User being deleted. If you restore the User, his Post documents will also be restored.</p>
<p></p>
                                            </div>
                </div>
            </main>
        </div>
    </div>

                            
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://staging.doctrine-project.org/components/highlightjs/highlight.pack.js?3970aa"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?f32c09"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?21d569"></script>

        <script type="text/javascript">
            var projectSlug = 'mongodb-odm';
            var versionSlug = '1.2';

            new Main();

            new Search(projectSlug, versionSlug);
        </script>

            <script src="https://staging.doctrine-project.org/js/sidebar.js?6349dd"></script>

    <script type="text/javascript">
        new Sidebar();
    </script>

        
        
            </body>
</html>
