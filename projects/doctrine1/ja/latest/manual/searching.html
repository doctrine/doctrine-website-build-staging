<!DOCTYPE html>
<html>
    <head>
        <title>はじめに - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="noindex">
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?c8b404" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/css/railscasts.css?62eb49" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine1/ja/latest/manual/searching.html" />
        <meta property="og:title" content="はじめに - Doctrine - PHP Database Tools" />
        <meta property="og:description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?6c0dab" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/reflection.html">Reflection</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="https://staging.doctrine-project.org/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/contribute/" id="navbarContributeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/">Contributor Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/maintainer/">Maintainer Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/website/">Contribute to Website</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
                    
<p></p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">はじめに<i class="fas fa-link"></i></a></h1>
<p>検索は巨大なトピックなので、この章全体では<code>Searchable</code>と呼ばれるビヘイビアを専門に扱います。これは全文インデックス作成と検索ツールでデータベースとファイルの両方で使うことができます。</p>
<p>次の定義を持つ<code>NewsItem</code>クラスを考えてみましょう:</p>
<blockquote><p>// models/NewsItem.php</p>
</blockquote>
<p>class NewsItem extends Doctrine\_Record { public function
setTableDefinition() { $this-&gt;hasColumn('title', 'string', 255);
$this-&gt;hasColumn('body', 'clob'); } }</p>
<p>YAMLフォーマットでの例は次の通りです。[doc yaml-schema-files
:name]の章でYAMLの詳細を読むことができます:</p>
<blockquote><p># schema.yml</p>
</blockquote>
<p>NewsItem: columns: title: string(255) body: clob</p>
<p>ユーザーが異なるニュースの項目を検索できるアプリケーションを考えてみましょう。これを実装する明らかな方法はフォームを構築し投稿された値に基づいて次のようなDQLクエリを構築することです:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $q = Doctrine\_Query::create() -&gt;from('NewsItem i')
-&gt;where('n.title LIKE ? OR n.content LIKE ?');</p>
<p>アプリケーションが成長するにつれてこの種のクエリはとても遅くなります。例えば<code>%framework%</code>パラメータで以前のクエリを使うとき、(<code>framework</code>という単語を含むタイトルもしくは内容を持つすべてのニュースの項目を見つけることと同等です)データベースはテーブルのそれぞれの列をトラバースしなければなりません。当然ながらこれは非常に遅くなります。</p>
<p>Doctrineはこの問題を検索コンポーネントとインバースインデックスで解決します。最初に定義を少し変えてみましょう:</p>
<blockquote><p>// models/NewsItem.php</p>
</blockquote>
<p>class NewsItem extends Doctrine\_Record { // ...</p>
<div class="console"><pre><code class="console">public function setUp()
{
    $this->actAs('Searchable', array(
            'fields' => array('title', 'content')
        )
    );
}</code></pre></div>
<p>}</p>
<p>YAMLフォーマットでの例は次の通りです。[doc yaml-schema-files
:name]の章でYAMLの詳細を読むことができます:</p>
<blockquote><p># schema.yml</p>
</blockquote>
<p>NewsItem: actAs: Searchable: fields: [title, content] # ...</p>
<p>上記のモデルで生成されたSQLをチェックしてみましょう:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $sql = Doctrine\_Core::generateSqlFromArray(array('NewsItem'));
echo $sql[0] . &quot;&quot;; echo $sql[1] . &quot;&quot;; echo $sql[2];</p>
<p>上記のコードは次のSQLクエリを出力します:</p>
<blockquote><p>CREATE TABLE news\_item\_index (id BIGINT, keyword VARCHAR(200), field</p>
</blockquote>
<p>VARCHAR(50), position BIGINT, PRIMARY KEY(id, keyword, field, position))
ENGINE = INNODB CREATE TABLE news\_item (id BIGINT AUTO\_INCREMENT,
title VARCHAR(255), body LONGTEXT, PRIMARY KEY(id)) ENGINE = INNODB
ALTER TABLE news\_item\_index ADD FOREIGN KEY (id) REFERENCES
news\_item(id) ON UPDATE CASCADE ON DELETE CASCADE</p>
<p>Here we tell Doctrine that
<code>NewsItem</code>クラスがsearchable(内部ではDoctrineが<code>Doctrine\_Template_Searchable</code>をロードする)として振る舞い<code>title</code>と<code>content</code>フィールドは全文検索用のインデックス付きフィールドとしてマークされます。これは<code>NewsItem</code>が追加もしくは更新されるたびにDoctrineは次のことを行うことを意味します:</p>
<ol><li>インバース検索インデックスを更新するもしくは</li>
<li>インバース検索インデックスに新しいエントリを追加する(バッチでインバース検索インデックスを更新するのが効率的であることがあります)</li>
</ol>

<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">インデックス構造<i class="fas fa-link"></i></a></h1>
<p>Doctrineが使用するインバースインデックスの構造は次の通りです:</p>
<p>[ (string) keyword] [ (string) field ] [ (integer) position ] [ (mixed)
[foreign\_keys] ]</p>
<p>\&nbsp; カラム \&nbsp; 説明 \ \ <code>keyword</code> \
検索できるテキストのキーワード \ \ <code>field</code> \
キーワードが見つかるフィールド \ \ <code>position</code> \
キーワードが見つかる位置 \ \ <code>[foreign_keys]</code> \
インデックスが作成されるレコードの外部キー \</p>
<p><code>NewsItem</code>の例において<code>[foreign_keys]</code>は<code>NewsItem(id)</code>への外部キー参照と<code>onDelete
=&gt; CASCADE</code>制約を持つ1つの<code>id</code>フィールドを格納します。</p>
<p>このテーブルの列のようになりますの例は次のようになります:</p>
<p>\&nbsp; キーワード \&nbsp; フィールド \&nbsp; 位置 \&nbsp; id \ \
<code>database</code> \ <code>title</code> \ <code>3</code> \ <code>1</code>\</p>
<p>この例において単語の<code>database</code>は<code>1</code>の<code>id</code>を持つ<code>NewsItem</code>の<code>title</code>フィールドの3番目の単語です。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">インデックスのビルド<i class="fas fa-link"></i></a></h1>
<p>検索可能なレコードがデータベースにinsertされるときDoctrineはインデックスビルドのプロシージャを実行します。プロシージャが検索リスナーによって起動されているときこれはバックグラウンドで行われます。このプロシージャのフェーズは次の通りです:</p>
<ol><li><code>Doctrine\_Search_Analyzer</code>基底クラスを使用してテキストを分析する</li>
<li>分析されたすべてのキーワード用に新しい列をインデックステーブルに挿入する</li>
</ol>

<p>新しい検索可能なエントリが追加されるときインデックステーブルを更新したくなく、むしろ特定の間隔でインデックステーブルをバッチ更新したい場合があります。直接の更新機能を無効にするにはビヘイビアを添付する際にbatchUpdatesオプションをtrueに設定する必要があります:</p>
<blockquote><p>// models/NewsItem.php</p>
</blockquote>
<p>class NewsItem extends Doctrine\_Record { // ...</p>
<div class="console"><pre><code class="console">public function setUp()
{
    $this->actAs('Searchable', array(
            'fields' => array('title', 'content')
            'batchUpdates' => true
        )
    );
}</code></pre></div>
<p>}</p>
<p>YAMLフォーマットでの例は次の通りです。[doc yaml-schema-files
:name]の章でYAMLの詳細を読むことができます:</p>
<blockquote><p># schema.yml</p>
</blockquote>
<p>NewsItem: actAs: Searchable: fields: [title, content] batchUpdates: true
# ...</p>
<p>更新プロシージャの実際のバッチは<code>batchUpdateIndex()</code>メソッドによって起動します。これは2つのオプション引数:
<code>limit</code>と<code>offset</code>を受けとります。バッチでインデックス化されるエントリ数を制限するためにlimitが使用できoffsetはインデックス作成を始める最初のエントリを設定するために使用できます。</p>
<p>最初に新しい<code>NewsItem</code>レコードを挿入してみましょう:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $newsItem = new NewsItem(); $newsItem-&gt;title = 'Test';
$newsItem-&gt;body = 'test'; $newsItem-&gt;save();</p>
<blockquote><p><strong>NOTE</strong>
バッチ更新を有効にしない場合<code>NewsItem</code>レコードを挿入もしくは更新するときにインデックスは自動的に更新されます。バッチ更新を有功にする場合次のコードでバッチ更新を実行できます:</p>
<p>test.php</p>
</blockquote>
<p>// ... $newsItemTable = Doctrine\_Core::getTable('NewsItem');
$newsItemTable-&gt;batchUpdateIndex();</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">テキストアナライザー<i class="fas fa-link"></i></a></h1>
<p>デフォルトではDoctrineはテキスト分析のために<code>Doctrine\_Search\_Analyzer_Standard</code>を使用します。このクラスは次のことを実行します:</p>
<ul><li class="dash"> 'and'、'if'などのストップワードをはぎとる。よく使われ検索には関係ないのと、インデックスのサイズを適切なものにするため。</li>
<li class="dash"> すべてのキーワードを小文字にする。標準アナライザーはすべてのキーワードを小文字にするので単語を検索するとき'database'と'DataBase'は等しいものとしてみなされる。</li>
<li class="dash"> アルファベットと数字ではないすべての文字はホワイトスペースに置き換える。通常のテキストでは例えば'database.'などアルファベットと数字ではない文字がキーワードに含まれるからである。標準のアナライザーはこれらをはぎとるので'database'は'database.'にマッチします</li>
<li class="dash"> すべてのクォテーション記号を空の文字列に置き換えるので&quot;O'Connor&quot;は&quot;oconnor&quot;にマッチします</li>
</ul>

<p><code>Doctrine\_Search\_Analyzer_Interface</code>を実装することで独自のアナライザークラスを書くことができます。<code>MyAnalyzer</code>という名前のアナライザーを作成する例は次の通りです:</p>
<blockquote><p>// models/MyAnalyzer.php</p>
</blockquote>
<p>class MyAnalyzer implements Doctrine\_Search\_Analyzer\_Interface {
public function analyze($text) { `text = trim(`\ text); return$text; } }</p>
<blockquote><p><strong>NOTE</strong>
検索アナライザーは<code>analyze()</code>という名前の1つのメソッドを持たなければなりません。このメソッドはインデックス化される入力テキストの修正版を返します。</p>
</blockquote>
<p>このアナライザーは検索オブジェクトに次のように適用されます:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $newsItemTable = Doctrine\_Core::getTable('NewsItem'); $search =
$newsItemTable -&gt;getTemplate('Doctrine\_Template\_Searchable')
-&gt;getPlugin();</p>
<p>$search-&gt;setOption('analyzer', new MyAnalyzer());</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">クエリ言語<i class="fas fa-link"></i></a></h1>
<p><code>Doctrine_Search</code>はApache
Luceneに似たクエリ言語を提供します。<code>Doctrine\_Search_Query</code>は人間が読解でき、構築が簡単なクエリ言語を同等の複雑なDQLに変換します。そしてこのDQLは通常のSQLに変換されます。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">検索を実行する<i class="fas fa-link"></i></a></h1>
<p>次のコードはレコードのidと関連データを読み取るシンプルな例です。</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $newsItemTable = Doctrine\_Core::getTable('NewsItem');</p>
<p>$results = `newsItemTable-&gt;search('test'); print_r(`\ results);
上記のコードは次のクエリを実行します:</p>
<blockquote><p>SELECT COUNT(keyword) AS relevance, id FROM article\_index WHERE id IN</p>
</blockquote>
<p>(SELECT id FROM article\_index WHERE keyword = ?) AND id IN (SELECT id
FROM article\_index WHERE keyword = ?) GROUP BY id ORDER BY relevance
DESC</p>
<p>コードの出力は次の通りです:</p>
<blockquote><p>$ php test.php Array ( [0] =&gt; Array ( [relevance] =&gt; 1 [id] =&gt; 1 )</p>
</blockquote>
<p>)</p>
<p>実際の<code>NewsItem</code>オブジェクトを読み取るために別のクエリでこれらの結果を使うことができます:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... `ids = array(); foreach (`\ results as $result) { $ids[] =$result['id']; }</p>
<p>$q = Doctrine\_Query::create() -&gt;from('NewsItem i') -&gt;whereIn('i.id',
$ids);</p>
<p>$newsItems = $q-&gt;execute();</p>
<p>print\_r($newsItems-&gt;toArray());</p>
<p>上記の例は次の出力を生み出します:</p>
<blockquote><p>$ php test.php Array ( [0] =&gt; Array ( [id] =&gt; 1 [title] =&gt; Test [body]</p>
</blockquote>
<p>=&gt; test )</p>
<p>)</p>
<p>オプションとして検索インデックスを使用して結果を制限するwhere条件サブクエリで修正するために<code>search()</code>メソッドにクエリオブジェクトを渡すことができます。</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $q = Doctrine\_Query::create() -&gt;from('NewsItem i');</p>
<p>$q = Doctrine\_Core::getTable('Article') -&gt;search('test', $q);</p>
<p>echo $q-&gt;getSqlQuery();</p>
<p>上記の<code>getSql()</code>の呼び出しは次のSQLクエリを出力します:</p>
<blockquote><p>SELECT n.id AS n<strong>id, n.title AS n</strong>title, n.body AS n\_\_body FROM</p>
</blockquote>
<p>news\_item n WHERE n.id IN (SELECT id FROM news\_item\_index WHERE
keyword = ? GROUP BY id)</p>
<p>クエリを実行して<code>NewsItem</code>オブジェクトを取得できます:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $newsItems = $q-&gt;execute();</p>
<p>print\_r($newsItems-&gt;toArray());</p>
<p>上記の例は次の出力を生み出します:</p>
<blockquote><p>$ php test.php Array ( [0] =&gt; Array ( [id] =&gt; 1 [title] =&gt; Test [body]</p>
</blockquote>
<p>=&gt; test )</p>
<p>)</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">ファイル検索<i class="fas fa-link"></i></a></h1>
<p>前に述べたように<code>Doctrine\_Search</code>はファイル検索にも使うことができます。検索可能なディレクトリを用意したい場合を考えてみましょう。最初に<code>Doctrine\_Search\_File</code>のインスタンスを作る必要があります。これは<code>Doctrine_Search</code>の子クラスでファイル検索に必要な機能を提供します。</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $search = new Doctrine\_Search\_File();</p>
<p>2番目に行うことはインデックステーブルを生成することです。デフォルトではDoctrineはデータベースのインデックスクラスを<code>FileIndex</code>
と名づけます。</p>
<p>上記のモデルによって生成されたSQLをチェックしてみましょう:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $sql = Doctrine\_Core::generateSqlFromArray(array('FileIndex'));</p>
<p>上記のコードは次のSQLクエリを出力します:</p>
<blockquote><p>CREATE TABLE file\_index (url VARCHAR(255), keyword VARCHAR(200), field</p>
</blockquote>
<p>VARCHAR(50), position BIGINT, PRIMARY KEY(url, keyword, field,
position)) ENGINE = INNODB</p>
<p><code>Doctrine_Core::createTablesFromArray()</code>メソッドを使用することでデータベースで実際のテーブルを作ることができます:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... Doctrine\_Core::createTablesFromArray(array('FileIndex'));</p>
<p>ファイルサーチャーを使い始めることができます。この例では<code>models</code>ディレクトリのインデックスを作りましょう:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $search-&gt;indexDirectory('models');</p>
<p><code>indexDirectory()</code>はディレクトリを再帰的にイテレートしインデックステーブルを更新しながらその範囲のすべてのファイルを分析します。</p>
<p>最後にインデックス化されたファイルの範囲内でテキストのピースの検索を始めることができます:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $results = `search-&gt;search('hasColumn'); print_r(`\ results);
上記の例は次の出力を生み出します:</p>
<blockquote><p>$ php test.php Array ( [0] =&gt; Array ( [relevance] =&gt; 2 [url] =&gt;</p>
</blockquote>
<p>models/generated/BaseNewsItem.php )</p>
<p>)</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">まとめ<i class="fas fa-link"></i></a></h1>
<p><code>Searchable</code>ビヘイビアのすべてを学んだので[doc hierarchical-data
:name]の章で<code>NestedSet</code>ビヘイビアの詳細を学ぶ準備ができています。<code>NestedSet</code>は<code>Searchable</code>ビヘイビアのように大きなトピックなので1つの章全体で扱います。</p>
<p></p>
            </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://cdn.ravenjs.com/3.24.2/raven.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            Raven.config('https://09ce137590054cfd8f0b7e9324d6ec14@sentry.io/1197701').install()
        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?4138a7"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?493399"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            new Main();

            new Search(projectSlug, versionSlug, searchBoxSettings);

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }

            function googleTranslateElementInit() {
                $('#google_translate_element').html('');

                new google.translate.TranslateElement(
                    {pageLanguage: 'en'}, 'google_translate_element'
                );

                $('#google_translate_element select').on('change', function() {
                    var language = $('#google_translate_element select option:selected').text();

                    googleAnalyticsEvent('Translate', 'click', language);
                });
            }
        </script>

        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>

        
        
            </body>
</html>
