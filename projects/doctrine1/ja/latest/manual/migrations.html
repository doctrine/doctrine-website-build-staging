<!DOCTYPE html>
<html>
    <head>
        <title>マイグレーションを実行する - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="noindex">
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?c8b404" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/css/railscasts.css?62eb49" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine1/ja/latest/manual/migrations.html" />
        <meta property="og:title" content="マイグレーションを実行する - Doctrine - PHP Database Tools" />
        <meta property="og:description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?6c0dab" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/reflection.html">Reflection</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="https://staging.doctrine-project.org/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/contribute/" id="navbarContributeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/">Contributor Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/maintainer/">Maintainer Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/website/">Contribute to Website</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
                    
<p></p>
<p>Doctrineのマイグレーションパッケージのプログラミングインターフェイスを通して本番のデータベースを簡単に更新できます。データベースがバージョン管理されバージョンを通して差し戻しできるように変更が行われます。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">マイグレーションを実行する<i class="fas fa-link"></i></a></h1>
<p>マイグレーションクラスの作り方を学んだので次のセクションでDoctrinenのテスト環境でマイグレーションを実装できるようにマイグレーションの実行の仕方を見てみましょう。</p>
<p>最初に<code>Doctrine_Migration</code>の新しいインスタンスを作りこれにマイグレーションクラスへのパスを渡しましょう:</p>
<blockquote><p>$migration = new Doctrine\_Migration('/path/to/migration\_classes',</p>
</blockquote>
<p>$conn);</p>
<blockquote><p><strong>NOTE</strong>
<code>Doctrine\_Migration</code>コンストラクタの2番目の引数に注目してください。オプションの<code>Doctrine_Connection</code>インスタンスを渡すことができます。使うマイグレーションクラスの接続を渡さなければ、現在の接続が取り込まれます。</p>
</blockquote>
<p><code>migrate()</code>メソッドを呼び出すことで最新バージョンに移行できます:</p>
<blockquote><p>$migration-&gt;migrate();</p>
</blockquote>
<p>特定のバージョンにマイグレートするには<code>migrate()</code>に引数を渡します。例えばバージョン0から3にマイグレートできます:</p>
<blockquote><p>$migration-&gt;migrate(3);</p>
</blockquote>
<p>バージョン3から0に戻すことができます:</p>
<blockquote><p>$migration-&gt;migrate(0);</p>
</blockquote>
<p>データベースの現在のバージョンを取得するには<code>getCurrentVersion()</code>メソッドを使います:</p>
<blockquote><p>echo $migration-&gt;getCurrentVersion();</p>
<div class="alert tip-admonition bg-success text-light border"><table width="100%"><tr><td width="10" class="align-top"><i class="fas fa-question-circle mr-2"></i></td><td><p><code>migrate()</code>メソッドのバージョン番号の引数を省略するとDoctrineは内部でディレクトリで見つかるクラスの最新バージョン番号にマイグレートしようとします。</p>
<p><strong>NOTE</strong> <strong>マイグレーションのトランザクション</strong>
内部ではDoctrineはトランザクションのマイグレーションバージョンをラップしません。マイグレーションクラスで例外とトランザクションを処理するのは開発者しだいです。トランザクションDDLをサポートするデータベースはごくわずかであることを覚えておいてください。大抵のデータベースでは、トランザクションでマイグレーションをラップする場合でも、create、alter、drop、renameなどのステートメントは効果があります。</p>
</td></tr></table></div>
</blockquote>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">実装<i class="fas fa-link"></i></a></h1>
<p>マイグレーションの実施方法を理解したので<code>migrate.php</code>という名前でテスト環境のスクリプトを実装してみましょう。</p>
<p>最初にマイグレーションクラスを保存する場所が必要なので<code>migrations</code>という名前のディレクトリを作りましょう:</p>
<blockquote><p>$ mkdir migrations</p>
</blockquote>
<p><code>migrate.php</code>スクリプトを作り次のコードを記入します:</p>
<blockquote><p>// migrate.php</p>
</blockquote>
<p>require\_once('bootstrap.php');</p>
<p>$migration = new Doctrine\_Migration('migrations');
$migration-&gt;migrate();</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">マイグレーションクラスを書く<i class="fas fa-link"></i></a></h1>
<p>マイグレーションクラスは<code>Doctrine_Migration</code>を継承するシンプルなクラスで構成されます。<code>up()</code>と<code>down()</code>メソッドを定義します。これらのメソッドはそれぞれ指定されたマイグレーションバージョンでのデータベースの変更とその取り消しを意味します。</p>
<blockquote><p><strong>NOTE</strong>
クラスの名前がなんであれ、正しい順序でマイグレーションをロードするために使われる数字が含まれる接頭辞をクラスが含まれるファイルの名前につけなければなりません。</p>
</blockquote>
<p>バージョン1から始まるデータベースをビルドするために使うマイグレーションクラスの例です。</p>
<p>最初のバージョンとして<code>migration_test</code>という名前の新しいテーブルを作りましょう:</p>
<blockquote><p>// migrations/1\_add\_table.php</p>
</blockquote>
<p>class AddTable extends Doctrine\_Migration\_Base { public function up()
{ $this-&gt;createTable('migration\_test', array('field1' =&gt; array('type'
=&gt; 'string'))); }</p>
<div class="console"><pre><code class="console">public function down()
{
    $this->dropTable('migration_test');
}</code></pre></div>
<p>}</p>
<p>前のバージョンで追加したテーブルに新しいカラムを追加した2番目のバージョンを作りましょう:</p>
<blockquote><p>// migrations/2\_add\_column.php</p>
</blockquote>
<p>class AddColumn extends Doctrine\_Migration\_Base { public function up()
{ $this-&gt;addColumn('migration\_test', 'field2', 'string'); }</p>
<div class="console"><pre><code class="console">public function down()
{
    $this->removeColumn('migration_test', 'field2');
}</code></pre></div>
<p>}</p>
<p>最後に、<code>field1</code>カラムの型を変更してみましょう:</p>
<blockquote><p>// migrations/3\_change\_column.php</p>
</blockquote>
<p>class ChangeColumn extends Doctrine\_Migration\_Base { public function
up() { $this-&gt;changeColumn('migration\_test', 'field2', 'integer'); }</p>
<div class="console"><pre><code class="console">public function down()
{
    $this->changeColumn('migration_test', 'field2', 'string');
}</code></pre></div>
<p>}</p>
<p>3つのマイグレーションクラスを作成したので以前実装した<code>migrate.php</code>スクリプトを実行できます:</p>
<blockquote><p>$ php migrate.php</p>
</blockquote>
<p>データベースを見ると<code>migrate\_test</code>という名前のテーブルが存在し<code>migration_version</code>のバージョン番号が3に設定されることが確認できます。</p>
<p>最初の状態に差し戻したい場合<code>migrate.php</code>スクリプトで<code>migrate()</code>メソッドにバージョン番号を渡します:</p>
<blockquote><p>// migrate.php</p>
</blockquote>
<p>// ... $migration = new Doctrine\_Migration('migrations');
$migration-&gt;migrate(0);</p>
<p>そして<code>migrate.php</code>スクリプトを実行します:</p>
<blockquote><p>$ php migrate.php</p>
</blockquote>
<p>データベースを見ると、<code>up()</code>メソッドで行ったすべての内容が<code>down()</code>メソッドの内容によって差し戻されます。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">利用可能なオペレーション<i class="fas fa-link"></i></a></h2>
<p>マイグレーションクラスでデータベースを変えるために利用できるメソッドの一覧は次の通りです。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">テーブルを作成する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $columns = array( 'id' =&gt; array( 'type'</p>
</blockquote>
<p>=&gt; 'integer', 'unsigned' =&gt; 1, 'notnull' =&gt; 1, 'default' =&gt; 0 ), 'name'
=&gt; array( 'type' =&gt; 'string', 'length' =&gt; 12 ), 'password' =&gt; array(
'type' =&gt; 'string', 'length' =&gt; 12 ) );</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>options = array(
    'type'     => 'INNODB',
    'charset'  => 'utf8'
);

<span class="noselect">$ </span>this->createTable('table_name', $columns, $options);</code></pre></div>
<p>// ...</p>
<blockquote><p><strong>NOTE</strong>
スキーマを操作するために使われるデータ構造とデータベース抽象化レイヤーで使われるデータ構造が同じであることにお気づきかもしれません。これはマイグレーションクラスで指定されているオペレーションを実行するために内部でマイグレーションパッケージがデータベース抽象化レイヤーを使用しているからです。</p>
</blockquote>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">テーブルを削除する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function down() { $this-&gt;dropTable('table\_name'); } //</p>
</blockquote>
<p>...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">テーブルをリネームする<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $this-&gt;renameTable('old\_table\_name',</p>
</blockquote>
<p>'new\_table\_name'); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">制約を作成する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $definition = array( 'fields' =&gt; array(</p>
</blockquote>
<p>'username' =&gt; array() ), 'unique' =&gt; true );</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>this->createConstraint('table_name', 'constraint_name', $definition);</code></pre></div>
<p>// ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">制約を削除する<i class="fas fa-link"></i></a></h3>
<p><strong>Now the opposite <code>down()</code> would look like the following:</strong></p>
<blockquote><p>// ... public function down() { $this-&gt;dropConstraint('table\_name',</p>
</blockquote>
<p>'constraint\_name'); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">外部キーを削除する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $definition = array( 'local' =&gt;</p>
</blockquote>
<p>'email\_id', 'foreign' =&gt; 'id', 'foreignTable' =&gt; 'email', 'onDelete' =&gt;
'CASCADE' );</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>this->createForeignKey('table_name', 'email_foreign_key', $definition);</code></pre></div>
<p>// ...</p>
<p><code>$definition</code>用の有効なオプションは次の通りです:</p>
<p>\&nbsp; 名前 \&nbsp; 説明 \ \ <code>name</code> \ オプションの制約名 \
\ <code>local</code> \ ローカルフィールド \ \ <code>foreign</code> \
外部参照フィールド \ \ <code>foreignTable</code> \ 外部テーブルの名前
\ \ <code>onDelete</code> \ 参照の削除アクション \ \ <code>onUpdate</code>
\ 参照の更新アクション \ \ <code>deferred</code> \
延期された制約チェック \</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">外部キーを削除する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function down() { $this-&gt;dropForeignKey('table\_name',</p>
</blockquote>
<p>'email\_foreign\_key'); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">カラムを追加する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $this-&gt;addColumn('table\_name',</p>
</blockquote>
<p>'column\_name', 'string', $length, $options); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">カラムをリネームする<i class="fas fa-link"></i></a></h3>
<blockquote><p><strong>NOTE</strong>
sqliteのような一部のDBMSはカラムのリネームオペレーションを実装していません。sqlite接続を使用している場合カラムをリネームしようとすると例外が投げられます。</p>
<p>... public function up() { $this-&gt;renameColumn('table\_name',</p>
</blockquote>
<p>'old\_column\_name', 'new\_column\_name'); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">カラムを変更する<i class="fas fa-link"></i></a></h3>
<p><strong>既存のカラムのアスペクトを変更する:</strong></p>
<blockquote><p>// ... public function up() { $options = array('length' =&gt; 1);</p>
</blockquote>
<p>$this-&gt;changeColumn('table\_name', 'column\_name', 'tinyint', $options);
} // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">カラムを削除する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $this-&gt;removeColumn('table\_name',</p>
</blockquote>
<p>'column\_name'); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">不可逆なマイグレーション<i class="fas fa-link"></i></a></h3>
<div class="alert tip-admonition bg-success text-light border"><table width="100%"><tr><td width="10" class="align-top"><i class="fas fa-question-circle mr-2"></i></td><td><p>リバースできない<code>up()</code>メソッドでオペレーションを実行することがあります。例えばテーブルからカラムを削除する場合です。この場合新しい<code>Doctrine\_Migration_IrreversibleMigrationException</code>例外を投げる必要があります。</p>
<p>... public function down() { throw new</p>
</td></tr></table></div>
<p>Doctrine\_Migration\_IrreversibleMigrationException( 'The remove column
operation cannot be undone!' ); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">インデックスを追加する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function up() { $options = array('fields' =&gt; array(</p>
</blockquote>
<p>'username' =&gt; array( 'sorting' =&gt; 'ascending' ), 'last\_login' =&gt;
array()));</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>this->addIndex('table_name', 'index_name', $options)</code></pre></div>
<p>// ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">インデックスを削除する<i class="fas fa-link"></i></a></h3>
<blockquote><p>// ... public function down() { $this-&gt;removeIndex('table\_name',</p>
</blockquote>
<p>'index\_name'); } // ...</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">プレフックとポストフック<i class="fas fa-link"></i></a></h2>
<p>モデルでデータベースのデータを変えることが必要な場合があります。テーブルを作成もしくは変更するので<code>up()</code>もしくは<code>down()</code>メソッドが処理された後でデータを変更しなければなりません。<code>preUp()</code>、<code>postUp()</code>、<code>preDown()</code>、と<code>postDown()</code>という名前でフックを用意します。定義すればこれらのメソッドは実行されます:</p>
<blockquote><p>// migrations/1\_add\_table.php</p>
</blockquote>
<p>class AddTable extends Doctrine\_Migration\_Base { public function up()
{ $this-&gt;createTable('migration\_test', array('field1' =&gt; array('type'
=&gt; 'string'))); }</p>
<div class="console"><pre><code class="console">public function postUp()
{
    $migrationTest = new MigrationTest();
    $migrationTest->field1 = 'Initial record created by migrations';
    $migrationTest->save();
}

public function down()
{
    $this->dropTable('migration_test');
}</code></pre></div>
<p>}</p>
<blockquote><p><strong>NOTE</strong>
上記の例は<code>MigrationTest</code>モデルを作成し利用可能にしたことを前提とします。<code>up()</code>メソッドが実行されると<code>migration_test</code>テーブルが作成されるので<code>MigrationTest</code>モデルが使われます。このモデルの定義は下記の通りです。</p>
<p>models/MigrationTest.php</p>
</blockquote>
<p>class MigrationTest extends Doctrine\_Record { public function
setTableDefinition() { $this-&gt;hasColumn('field1', 'string'); } }</p>
<p>YAMLフォーマットでの例は次の通りです。[doc yaml-schema-files
:name]の章でYAMLの詳細を学びます:</p>
<blockquote><p># schema.yml</p>
</blockquote>
<p>MigrationTest: columns: field1: string</p>
<hr />
<a class="section-anchor" id="up-down" name="up-down"></a><h2 class="section-header"><a href="#up-down">Up/Downの自動化<i class="fas fa-link"></i></a></h2>
<p>Doctrineのマイグレーション機能では大抵の場合マイグレーションメソッドの反対側を自動化することが可能です。例えばマイグレーションのupで新しいカラムを作成する場合、downを簡単に自動化するのは可能で必要なのは作成されたカラムを削除することです。これは<code>up</code>と<code>down</code>の両方に対して<code>migrate()</code>メソッドを使用して実現可能です。</p>
<p><code>migrate()</code>メソッドは$directionの引数を受け取り<code>up</code>もしくは<code>down</code>の値を持つようになります。この値は<code>column</code>、<code>table</code>、のようなメソッドの最初の引数に渡されます。</p>
<p>カラムの追加と削除を自動化する例は次の通りです。</p>
<blockquote><p>class MigrationTest extends Doctrine\_Migration\_Base { public function</p>
</blockquote>
<p>migrate($direction) { `this-&gt;column(`\ direction, 'table\_name','column\_name', 'string', '255'); } }</p>
<p>上記のマイグレーションでupを実行するときカラムが追加され、downが実行されるときカラムが削除されます。</p>
<p>自動化できるマイグレーションメソッドのリストは次の通りです:</p>
<p>\&nbsp; 自動メソッド名 \&nbsp; 自動化 \ \ <code>table()</code> \
createTable()/dropTable() \ \ <code>constraint()</code> \
createConstraint()/dropConstraint() \ \ <code>foreignKey()</code> \
createForeignKey()/dropForeignKey() \ \ <code>column()</code> \
addColumn()/removeColumn() \ \ <code>index()</code> \
addIndex()/removeIndex() \</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">マイグレーションを生成する<i class="fas fa-link"></i></a></h2>
<p>Doctrineはいくつかの異なる方法でマイグレーションクラスを生成する機能を提供します。既存のデータベースを再現するマイグレーションのセットを生成する、もしくは既存のモデルのセット用にデータベースを作成するマイグレーションクラスを生成します。2つのスキーマ情報の2つのセットの間の違いからマイグレーションを生成することもできます。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">データベースから<i class="fas fa-link"></i></a></h3>
<p>既存のデータベース接続からマイグレーションのセットを生成するには、<code>Doctrine_Core::generateMigrationsFromDb()</code>を使います。</p>
<blockquote><p>Doctrine\_Core::generateMigrationsFromDb('/path/to/migration/classes');</p>
</blockquote>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">既存のモデルから<i class="fas fa-link"></i></a></h3>
<p>既存のモデルのセットからマイグレーションのセットを生成するには、<code>Doctrine_Core::generateMigrationsFromModels()</code>を使うだけです。</p>
<p>Doctrine\_Core::generateMigrationsFromModels('/path/to/migration/classes',
'/path/to/models');</p>
<hr />
<a class="section-anchor" id="" name=""></a><h3 class="section-header"><a href="#">差分ツール<i class="fas fa-link"></i></a></h3>
<p>ときにはモデルを変更して変更に対するマイグレーション処理を自動化できるようにしたいことがあります。以前は変更に対してマイグレーションクラスを書かなければなりませんでした。しかし差分ツールによって変更を行い変更用のマイグレーションクラスを生成できます。</p>
<p>差分ツールはシンプルで使いやすいです。これは&quot;from&quot;と&quot;to&quot;を受け取り、これらは次のうちのどれかになります:</p>
<ul><li class="dash"> YAMLスキーマファイルへのパス</li>
<li class="dash"> 既存のデータベース接続の名前</li>
<li class="dash"> モデルの既存のセットへのパス</li>
</ul>

<p>2つのYAMLスキーマファイルを作るシンプルな例を考えます。1つは<code>schema1.yml</code>でもう1つは<code>schema2.yml</code>という名前です。</p>
<p><code>schema1.yml</code>はシンプルな<code>User</code>モデルを含みます:</p>
<blockquote><p># schema1.yml</p>
</blockquote>
<p>User: columns: username: string(255) password: string(255)</p>
<p>スキーマを修正して<code>email_address</code>カラムを追加する場合を考えてみましょう:</p>
<blockquote><p># schema1.yml</p>
</blockquote>
<p>User: columns: username: string(255) password: string(255)
email\_address: string(255)</p>
<p>これでデータベースに新しいカラムを追加できるマイグレーションクラスを簡単に作ることができます:</p>
<p>Doctrine\_Core::generateMigrationsFromDiff('/path/to/migration/classes',
'/path/to/schema1.yml', '/path/to/schema2.yml');</p>
<p>これによって<code>/path/to/migration/classes/1236199329_version1.php</code>のパスでファイルが生み出されます。</p>
<blockquote><p>class Version1 extends Doctrine\_Migration\_Base { public function up()</p>
</blockquote>
<p>{ $this-&gt;addColumn('user', 'email\_address', 'string', '255', array ());
}</p>
<div class="console"><pre><code class="console">public function down()
{
    $this->removeColumn('user', 'email_address');
}</code></pre></div>
<p>}</p>
<p>データベースを簡単にマイグレートして新しいカラムを追加できます！</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">まとめ<i class="fas fa-link"></i></a></h1>
<p>安全かつ簡単にスキーマを変更できるので本番のデータベーススキーマを変更するためにマイグレーション機能は大いに推奨されます。</p>
<p>マイグレーションはこの本で検討する最後の機能です。最後の章では日常業務で手助けになる他のトピックを検討します。最初に他の[doc
utilities :name]を検討しましょう。</p>
<p></p>
            </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://cdn.ravenjs.com/3.24.2/raven.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            Raven.config('https://09ce137590054cfd8f0b7e9324d6ec14@sentry.io/1197701').install()
        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?4138a7"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?493399"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            new Main();

            new Search(projectSlug, versionSlug, searchBoxSettings);

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }

            function googleTranslateElementInit() {
                $('#google_translate_element').html('');

                new google.translate.TranslateElement(
                    {pageLanguage: 'en'}, 'google_translate_element'
                );

                $('#google_translate_element select').on('change', function() {
                    var language = $('#google_translate_element select option:selected').text();

                    googleAnalyticsEvent('Translate', 'click', language);
                });
            }
        </script>

        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>

        
        
            </body>
</html>
