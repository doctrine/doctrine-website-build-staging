<!DOCTYPE html>
<html>
    <head>
        <title>はじめに - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="noindex">
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?c8b404" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/css/railscasts.css?62eb49" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine1/ja/latest/manual/event-listeners.html" />
        <meta property="og:title" content="はじめに - Doctrine - PHP Database Tools" />
        <meta property="og:description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?6c0dab" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://staging.doctrine-project.org/projects/reflection.html">Reflection</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="https://staging.doctrine-project.org/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/contribute/" id="navbarContributeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/">Contributor Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/maintainer/">Maintainer Workflow</a>
                                <a class="dropdown-item" href="https://staging.doctrine-project.org/contribute/website/">Contribute to Website</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
                    
<p></p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">はじめに<i class="fas fa-link"></i></a></h1>
<p>Doctrineは柔軟なイベントリスナーアーキテクチャを提供します。このアークテクチャは異なるイベントのリスニングだけでなくリスニングされるメソッドの実行を変更することも可能にします。</p>
<p>様々なDoctrineコンポーネント用の異なるリスナーとフックがあります。リスナーは個別のクラスであるのに対してフックはリスニングされるクラスの範囲内の空のテンプレートメソッドです。</p>
<p>フックはイベントリスナーよりもシンプルですがこれらは異なるアスペクトの分離が欠けています。<code>Doctrine_Record</code>フックを使用する例は次の通りです:</p>
<blockquote><p>// models/BlogPost.php</p>
</blockquote>
<p>class BlogPost extends Doctrine\_Record { // ...</p>
<div class="console"><pre><code class="console">public function preInsert($event)
{
    $invoker = $event->getInvoker();

    $invoker->created = date('Y-m-d', time());
}</code></pre></div>
<p>}</p>
<blockquote><p><strong>NOTE</strong>
これまでたくさんのモデルを定義してきたので、<code>BlogModel</code>に対して独自の<code>setTableDefinition()</code>を定義できます。もしくは独自のカスタムモデルを作りましょう！</p>
</blockquote>
<p>次のコードで上記のモデルを使うことができます。<code>title</code>、<code>body</code>と<code>created</code>カラムをモデルに追加することを前提とします:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $blog = new BlogPost(); $blog-&gt;title = 'New title'; $blog-&gt;body =
'Some content'; $blog-&gt;save();</p>
<p>echo $blog-&gt;created;</p>
<p>上記の例はPHPが理解する現在の日付を出力します。</p>
<p>それぞれのリスナーとフックメソッドは
<code>Doctrine\_Event</code>オブジェクトを1つのパラメータとして受け取ります。<code>Doctrine_Event</code>オブジェクトは問題のイベントの情報を格納しリスニングされるメソッドの実行を変更できます。</p>
<p>ドキュメントの目的のために多くのメソッドテーブルは<code>params</code>という名前のカラムで提供されます。このカラムはパラメータの名前は与えられたイベント上でイベントオブジェクトが保有するパラメータの名前を示します。例えば<code>preCreateSavepoint</code>イベントは作成された<code>savepoint</code>の名前を持つ1つのパラメータを持ちます。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">接続リスナー<i class="fas fa-link"></i></a></h1>
<p>接続リスナーは<code>Doctrine\_Connection</code>とそのモジュール(<code>Doctrine\_Transaction</code>など)のメソッドをリスニングするために使われます。すべてのリスナーメソッドはリスニングされるイベントの情報を格納する<code>Doctrine_Event</code>オブジェクトを1つの引数として受け取ります。</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">新しいリスナーを作成する<i class="fas fa-link"></i></a></h2>
<p>リスナーを定義する方法は3つあります。最初に<code>Doctrine_EventListener</code>を継承するクラスを作成することでリスナーを作成できます:</p>
<blockquote><p>class MyListener extends Doctrine\_EventListener { public function</p>
</blockquote>
<p>preExec(Doctrine\_Event $event) {</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>}
</code></pre></div>
<p>}</p>
<p><code>Doctrine\_EventListener</code>を継承するクラスを定義することで<code>Doctrine\_EventListener\_Interface</code>の範囲内ですべてのメソッドを定義する必要はありません。これは<code>Doctrine_EventListener</code>が既にこれらすべてのメソッド用の空のスケルトンを持つからです。</p>
<p>ときに<code>Doctrine\_EventListener</code>を継承するリスナーを定義できないことがあります(他の基底クラスを継承するリスナーを用意できます)。この場合<code>Doctrine\_EventListener_Interface</code>を実装させることができます。</p>
<blockquote><p>class MyListener implements Doctrine\_EventListener\_Interface { public</p>
</blockquote>
<p>function preTransactionCommit(Doctrine\_Event $event) {} public function
postTransactionCommit(Doctrine\_Event $event) {}</p>
<div class="console"><pre><code class="console">public function preTransactionRollback(Doctrine_Event $event) {}
public function postTransactionRollback(Doctrine_Event $event) {}

public function preTransactionBegin(Doctrine_Event $event) {}
public function postTransactionBegin(Doctrine_Event $event) {}

public function postConnect(Doctrine_Event $event) {}
public function preConnect(Doctrine_Event $event) {}

public function preQuery(Doctrine_Event $event) {}
public function postQuery(Doctrine_Event $event) {}

public function prePrepare(Doctrine_Event $event) {}
public function postPrepare(Doctrine_Event $event) {}

public function preExec(Doctrine_Event $event) {}
public function postExec(Doctrine_Event $event) {}

public function preError(Doctrine_Event $event) {}
public function postError(Doctrine_Event $event) {}

public function preFetch(Doctrine_Event $event) {}
public function postFetch(Doctrine_Event $event) {}

public function preFetchAll(Doctrine_Event $event) {}
public function postFetchAll(Doctrine_Event $event) {}

public function preStmtExecute(Doctrine_Event $event) {}
public function postStmtExecute(Doctrine_Event $event) {}</code></pre></div>
<p>}</p>
<blockquote><p><strong>CAUTION</strong>
すべてのリスナーメソッドはここで定義しなければなりません。さもないとPHPは致命的エラーを投げます。</p>
</blockquote>
<p>リスナーを作成する3番目の方法はとても優雅です。<code>Doctrine_Overloadable</code>を実装するクラスを作成します。インターフェイスは1つのメソッド:
<code>\__call()</code>のみを持ちます。このメソッドは<em>すべての</em>イベントと補足するために使われます。</p>
<blockquote><p>class MyDebugger implements Doctrine\_Overloadable { public function</p>
</blockquote>
<p>\_\_call($methodName, $args) { echo $methodName . ' called !'; } }</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">リスナーを追加する<i class="fas fa-link"></i></a></h2>
<p>setListener()でリスナーを接続に追加できます。</p>
<blockquote><p>$conn-&gt;setListener(new MyDebugger());</p>
</blockquote>
<p>複数のリスナーが必要な場合はaddListener()を使います。</p>
<blockquote><p>$conn-&gt;addListener(new MyDebugger()); $conn-&gt;addListener(new</p>
</blockquote>
<p>MyLogger());</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">プレ接続とポスト接続<i class="fas fa-link"></i></a></h2>
<p>下記のリスナーのすべては<code>Doctrine\_Connection</code>クラスに含まれます。これらすべては<code>Doctrine_Event</code>のインスタンスです。</p>
<p>\&nbsp; メソッド \&nbsp; リスニング \&nbsp; パラメータ \ \
<code>preConnect(Doctrine_Event $event)</code> \
Doctrine\_Connection::connection() \ \ \
<code>postConnect(Doctrine_Event $event)</code> \
Doctrine\_Connection::connection() \ \</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">トランザクションリスナー<i class="fas fa-link"></i></a></h2>
<p>下記のリスナーのすべては<code>Doctrine\_Transaction</code>クラスに含まれます。これらすべてに<code>Doctrine_Event</code>のインスタンスが渡されます。</p>
<p>\&nbsp; メソッド \&nbsp; リスニング \&nbsp; パラメータ \ \
<code>preTransactionBegin()</code> \ <code>beginTransaction()</code> \ \ \
<code>postTransactionBegin()</code> \ <code>beginTransaction()</code> \ \ \
<code>preTransactionRollback()</code> \ <code>rollback()</code> \ \ \
<code>postTransactionRollback()</code> \ <code>rollback()</code> \ \ \
<code>preTransactionCommit()</code> \ <code>commit()</code> \ \ \
<code>postTransactionCommit()</code> \ <code>commit()</code> \ \ \
<code>preCreateSavepoint()</code> \ <code>createSavepoint()</code> \ <code>savepoint</code>
\ \ <code>postCreateSavepoint()</code> \ <code>createSavepoint()</code> \
<code>savepoint</code> \ \ <code>preRollbackSavepoint()</code> \
<code>rollbackSavepoint()</code> \ <code>savepoint</code> \ \
<code>postRollbackSavepoint()</code> \ <code>rollbackSavepoint()</code> \
<code>savepoint</code> \ \ <code>preReleaseSavepoint()</code> \
<code>releaseSavepoint()</code> \ <code>savepoint</code> \ \
<code>postReleaseSavepoint()</code> \ <code>releaseSavepoint()</code> \
<code>savepoint</code> \</p>
<blockquote><p>class MyTransactionListener extends Doctrine\_EventListener { public</p>
</blockquote>
<p>function preTransactionBegin(Doctrine\_Event $event) { echo 'beginning
transaction... '; }</p>
<div class="console"><pre><code class="console">public function preTransactionRollback(Doctrine_Event $event)
{
    echo 'rolling back transaction... ';
}</code></pre></div>
<p>}</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">クエリ実行リスナー<i class="fas fa-link"></i></a></h2>
<p>下記のリスナーのすべては<code>Doctrine\_Connection</code>と<code>Doctrine\_Connection\_Statement</code>クラスに含まれます。そしてこれらすべては<code>Doctrine_Event</code>のインスタンスです。</p>
<p>\&nbsp; メソッド \&nbsp; リスニング \&nbsp; パラメータ \ \
<code>prePrepare()</code> \ <code>prepare()</code> \ <code>query</code> \ \
<code>postPrepare()</code> \ <code>prepare()</code> \ <code>query</code> \ \
<code>preExec()</code> \ <code>exec()</code> \ <code>query</code> \ \ <code>postExec()</code>
\ <code>exec()</code> \ <code>query, rows</code> \ \ <code>preStmtExecute()</code> \
<code>execute()</code> \ <code>query</code> \ \ <code>postStmtExecute()</code> \
<code>execute()</code> \ <code>query</code> \ \ <code>preExecute()</code> \
<code>execute()</code> \<em> \ <code>query</code> \ \ <code>postExecute()</code> \
<code>execute()</code> \</em> \ <code>query</code> \ \ <code>preFetch()</code> \
<code>fetch()</code> \ <code>query, data</code> \ \ <code>postFetch()</code> \
<code>fetch()</code> \ <code>query, data</code> \ \ <code>preFetchAll()</code> \
<code>fetchAll()</code> \ <code>query, data</code> \ \ <code>postFetchAll()</code> \
<code>fetchAll()</code> \ <code>query, data</code> \</p>
<blockquote><p><strong>NOTE</strong>
<code>Doctrine\_Connection::execute()</code>がプリペアードステートメントパラメータで呼び出されるときにのみ<code>preExecute()</code>と<code>postExecute()</code>は起動します。そうではない場合<code>Doctrine_Connection::execute()</code>は<code>prePrepare()</code>、<code>postPrepare()</code>、<code>preStmtExecute()</code>と<code>postStmtExecute()</code>を起動します。</p>
</blockquote>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">ハイドレーションリスナー<i class="fas fa-link"></i></a></h1>
<p>ハイドレーションリスナーは結果セットのハイドレーション処理をリスニングするために使われます。ハイドレーション処理をリスニングするために2つのメソッド:
<code>preHydrate()</code>と<code>postHydrate()</code>が存在します。</p>
<p>ハイドレーションリスナーを接続レベルで設定する場合、<code>preHydrate()</code>と<code>postHydrate()</code>ブロックの範囲内のコードは複数のコンポーネントの結果セットの範囲内ですべてのコンポーネントによって実行されます。テーブルレベルで同様のリスナーを追加する場合、テーブルのデータがハイドレイトされているときのみ起動します。</p>
<p>フィールド:
<code>first\_name</code>、<code>last\_name</code>と<code>age</code>を持つ<code>User</code>クラスを考えてみましょう。次の例では<code>first\_name</code>と<code>last\_name</code>フィールドに基づいて<code>full\__name</code>と呼ばれる生成フィールドを常にビルドするリスナーを作成します。</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... class HydrationListener extends Doctrine\_Record\_Listener {
public function preHydrate(Doctrine\_Event $event) { $data =
$event-&gt;data;</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>data['full_name'] = $data['first_name'] . ' ' . $data['last_name'];
<span class="noselect">$ </span>event->data = $data;</code></pre></div>
<p>}</p>
<p>行う必要があるのは<code>User</code>レコードにこのリスナーを追加して複数のユーザーを取得することです:</p>
<blockquote><p>// test.php</p>
</blockquote>
<p>// ... $userTable = Doctrine\_Core::getTable('User');
$userTable-&gt;addRecordListener(new HydrationListener());</p>
<p>$q = Doctrine\_Query::create() -&gt;from('User');</p>
<p>$users = $q-&gt;execute();</p>
<p>foreach ($users as $user) { echo $user-&gt;full\_name; }</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">レコードリスナー<i class="fas fa-link"></i></a></h1>
<p><code>Doctrine\_Record</code>は<code>Doctrine_Connection</code>とよく似たリスナーを提供します。グローバル、接続、テーブルレベルでリスナーを設定できます。</p>
<p>利用可能なすべてのリスナーメソッドの一覧は次の通りです:
下記のリスナーすべてが<code>Doctrine\_Record</code>と<code>Doctrine\_Validator</code>クラスに含まれます。そしてこれらすべてに<code>Doctrine_Event</code>のインスタンスが渡されます。</p>
<p>\&nbsp; メソッド \&nbsp; リスニング \ \ <code>preSave()</code> \ <code>save()</code>
\ \ <code>postSave()</code> \ <code>save()</code> \ \ <code>preUpdate()</code> \
レコードが<code>DIRTY</code>のとき<code>save()</code> \ \ <code>postUpdate()</code> \
レコードが<code>DIRTY</code>のとき<code>save()</code> \ \ <code>preInsert()</code> \
レコードが<code>DIRTY</code>のとき<code>save()</code> \ \ <code>postInsert()</code> \
レコードが<code>DIRTY</code>のとき<code>save()</code> \ \ <code>preDelete()</code> \
<code>delete()</code> \ \ <code>postDelete()</code> \ <code>delete()</code> \ \
<code>preValidate()</code> \ <code>validate()</code> \ \ <code>postValidate()</code> \
<code>validate()</code> \</p>
<p>接続リスナーと同じようにレコードリスナーを定義する方法は3つあります:
<code>Doctrine\_Record\_Listener</code>を継承する、<code>Doctrine\_Record\_Listener\_Interface</code>を実装するもしくは<code>Doctrine_Overloadable</code>を実装するです。</p>
<p>次の例では<code>Doctrine_Overloadable</code>を実装することでグローバルレベルのリスナーを作成します:</p>
<blockquote><p>class Logger implements Doctrine\_Overloadable { public function</p>
</blockquote>
<p>\_\_call($m, $a) { echo 'caught event ' . $m;</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>// do some logging here...
</code></pre></div>
<p>}</p>
<p>マネージャーにリスナーを追加するのは簡単です:</p>
<blockquote><p>$manager-&gt;addRecordListener(new Logger());</p>
</blockquote>
<p>マネージャーレベルのリスナーを追加することでこれらの接続の範囲内ですべてのテーブル/レコードに影響を及ぼします。次の例では接続レベルのリスナーを作成します:</p>
<blockquote><p>class Debugger extends Doctrine\_Record\_Listener { public function</p>
</blockquote>
<p>preInsert(Doctrine\_Event $event) { echo 'inserting a record ...'; }</p>
<div class="console"><pre><code class="console">public function preUpdate(Doctrine_Event $event)
{
    echo 'updating a record...';
}</code></pre></div>
<p>}</p>
<p>接続にリスナーを追加するのも簡単です:</p>
<blockquote><p>$conn-&gt;addRecordListener(new Debugger());</p>
</blockquote>
<p>リスナーが特定のテーブルのみにアクションを適用するようにリスナーをテーブル固有のものにしたい場合がよくあります。</p>
<p>例は次の通りです:</p>
<blockquote><p>class Debugger extends Doctrine\_Record\_Listener { public function</p>
</blockquote>
<p>postDelete(Doctrine\_Event $event) { echo 'deleted ' .
$event-&gt;getInvoker()-&gt;id; } }</p>
<p>このリスナーを任意のテーブルに追加するのは次のようにできます:</p>
<blockquote><p>class MyRecord extends Doctrine\_Record { // ...</p>
</blockquote>
<div class="console"><pre><code class="console">public function setUp()
{
    $this->addListener(new Debugger());
}</code></pre></div>
<p>}</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">レコードフック<i class="fas fa-link"></i></a></h1>
<p>\&nbsp; メソッド \&nbsp; リスニング \ \ <code>preSave()</code> \ <code>save()</code>
\ \ <code>postSave()</code> \ <code>save()</code> \ \ <code>preUpdate()</code> \
レコード状態が<code>DIRTY</code>であるとき<code>save()</code> \ \ <code>postUpdate()</code>
\ レコード状態が<code>DIRTY</code>であるとき<code>save()</code> \ \
<code>preInsert()</code> \ レコード状態が<code>DIRTY</code>であるとき<code>save()</code> \
\ <code>postInsert()</code> \ レコード状態が<code>DIRTY</code>であるとき<code>save()</code>
\ \ <code>preDelete()</code> \ <code>delete()</code> \ \ <code>postDelete()</code>
\ <code>delete()</code> \ \ <code>preValidate()</code> \ <code>validate()</code> \
\ <code>postValidate()</code> \ <code>validate()</code> \</p>
<p><code>preInsert()</code>と<code>preUpdate()</code>メソッドを利用するシンプルな例は次の通りです:</p>
<blockquote><p>class BlogPost extends Doctrine\_Record { public function</p>
</blockquote>
<p>setTableDefinition() { $this-&gt;hasColumn('title', 'string', 200);
$this-&gt;hasColumn('content', 'string'); $this-&gt;hasColumn('created',
'date'); $this-&gt;hasColumn('updated', 'date'); }</p>
<div class="console"><pre><code class="console">public function preInsert($event)
{
    $this->created = date('Y-m-d', time());
}

public function preUpdate($event)
{
    $this->updated = date('Y-m-d', time());
}</code></pre></div>
<p>}</p>
<hr />
<a class="section-anchor" id="dql" name="dql"></a><h1 class="section-header"><a href="#dql">DQLフック<i class="fas fa-link"></i></a></h1>
<p>レコードリスナーをグローバル、それぞれの接続で、もしくは特定のレコードインスタンスで追加することができます。<code>Doctrine_Query</code>は<code>preDql\*()</code>フックを実装します。これはクエリが実行されるときに、追加されたレコードリスナーもしくはモデルインスタンス自身でチェックされます。フックを起動したクエリを変更できるフックのためにクエリはクエリの<code>from</code>部分に関連するすべてのモデルをチェックします。</p>
<p>DQLで使うことができるフックのリストは次の通りです:</p>
<p>\&nbsp; メソッド \&nbsp; リスニング \ \ <code>preDqlSelect()</code> \
<code>from()</code> \ \ <code>preDqlUpdate()</code> \ <code>update()</code> \ \
<code>preDqlDelete()</code> \ <code>delete()</code> \</p>
<p>下記のコードは<code>User</code>モデル用の<code>SoftDelete</code>機能を実装するモデルにレコードリスナーを直接追加する例です。</p>
<div class="alert tip-admonition bg-success text-light border"><table width="100%"><tr><td width="10" class="align-top"><i class="fas fa-question-circle mr-2"></i></td><td><p>SoftDeleteの機能はDoctrineのビヘイビアとして含まれます。このコードは実行されるクエリを修正するためにDQLリスナーをselect、delete、updateする方法を実演しています。Doctrine\_Record::setUp()の定義で$this-&gt;actAs('SoftDelete')を指定することでSoftDeleteビヘイビアを使うことができます。</p>
<p>ss UserListener extends Doctrine\_EventListener { /\<em>\</em> \* Skip the</p>
</td></tr></table></div>
<p>normal delete options so we can override it with our own \<em> \</em> @param
Doctrine\_Event $event \<em> @return void \</em>/ public function
preDelete(Doctrine\_Event $event) { $event-&gt;skipOperation(); }</p>
<div class="console"><pre><code class="console">/**
 * Implement postDelete() hook and set the deleted flag to true
 *
 * @param Doctrine_Event $event
 * @return void
 */
public function postDelete(Doctrine_Event $event)
{
    $name = $this->_options['name'];
    $event->getInvoker()->$name = true;
    $event->getInvoker()->save();
}

/**
 * Implement preDqlDelete() hook and modify a dql delete query so it updates the deleted flag
 * instead of deleting the record
 *
 * @param Doctrine_Event $event
 * @return void
 */
public function preDqlDelete(Doctrine_Event $event)
{
    $params = $event->getParams();
    $field = $params['alias'] . '.deleted';
    $q = $event->getQuery();
    if ( ! $q->contains($field)) {
        $q->from('')->update($params['component'] . ' ' . $params['alias']);
        $q->set($field, '?', array(false));
        $q->addWhere($field . ' = ?', array(true));
    }
}

/**
 * Implement preDqlDelete() hook and add the deleted flag to all queries for which this model 
 * is being used in.
 *
 * @param Doctrine_Event $event 
 * @return void
 */
public function preDqlSelect(Doctrine_Event $event)
{
    $params = $event->getParams();
    $field = $params['alias'] . '.deleted';
    $q = $event->getQuery();
    if ( ! $q->contains($field)) {
        $q->addWhere($field . ' = ?', array(false));
    }
}</code></pre></div>
<p>}</p>
<p>オプションとして上記のリスナーのメソッドは下記のユーザークラスに設置できます。Doctrineはそこでフックを同じようにチェックします:</p>
<blockquote><p>class User extends Doctrine\_Record { // ...</p>
</blockquote>
<div class="console"><pre><code class="console">public function preDqlSelect()
{
    // ...
}

public function preDqlUpdate()
{
    // ...
}

public function preDqlDelete()
{
    // ...
}</code></pre></div>
<p>}</p>
<p>これらのDQLコールバックがチェックされるようにするには、これらを明示的に有効にしなければなりません。これはそれぞれのクエリに対して少量のオーバーヘッドを追加するので、デフォルトでは無効です。以前の章で既にこの属性を有効にしました。</p>
<p>思い出すためにコードを再掲載します:</p>
<blockquote><p>// bootstrap.php</p>
</blockquote>
<p>// ... $manager-&gt;setAttribute(Doctrine::ATTR\_USE\_DQL\_CALLBACKS,
true);</p>
<p>Userモデルとやりとりをするとき削除フラグが考慮されます:</p>
<p>レコードインスタンスを通してユーザーを削除します:</p>
<blockquote><p>$user = new User(); $user-&gt;username = 'jwage'; $user-&gt;password =</p>
</blockquote>
<p>'changeme'; $user-&gt;save(); $user-&gt;delete();</p>
<blockquote><p><strong>NOTE</strong>
<code>$user-&gt;delete()</code>を呼び出しても実際にはレコードは削除されず代わりに削除フラグがtrueに設定されます。</p>
<p>= Doctrine\_Query::create() -&gt;from('User u');</p>
</blockquote>
<p>echo $q-&gt;getSql();</p>
<blockquote><p>SELECT u.id AS u<strong>id, u.username AS u</strong>username, u.password AS</p>
</blockquote>
<p>u<strong>password, u.deleted AS u</strong>deleted FROM user u WHERE u.deleted = ?</p>
<blockquote><p><strong>NOTE</strong> <code>&quot;u.deleted =
?&quot;</code>が//true//のパラメータの値でwhere条件に自動的に追加されたことに注目してください。</p>
</blockquote>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">複数のリスナーを連結する<i class="fas fa-link"></i></a></h1>
<p>異なるイベントリスナーを連結することができます。このことは同じイベントをリスニングするために複数のリスナーを追加できることを意味します。次の例では与えられた接続用に2つのリスナーを追加します:</p>
<p>この例では<code>Debugger</code>と<code>Logger</code>は両方とも<code>Doctrine_EventListener</code>を継承します:</p>
<blockquote><p>$conn-&gt;addListener(new Debugger()); $conn-&gt;addListener(new Logger());</p>
</blockquote>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">イベントオブジェクト<i class="fas fa-link"></i></a></h1>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">インボーカーを取得する<i class="fas fa-link"></i></a></h2>
<p><code>getInvoker()</code>を呼び出すことでイベントを起動したオブジェクトを取得できます:</p>
<blockquote><p>class MyListener extends Doctrine\_EventListener { public function</p>
</blockquote>
<p>preExec(Doctrine\_Event $event) { $event-&gt;getInvoker(); //
Doctrine\_Connection } }</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">イベントコード<i class="fas fa-link"></i></a></h2>
<p><code>Doctrine_Event</code>は定数をイベントコードとして使用します。利用可能なイベントの定数の一覧は下記の通りです:</p>
<ul><li class="dash"> <code>Doctrine\_Event::CONN_QUERY</code></li>
<li class="dash"> <code>Doctrine\_Event::CONN_EXEC</code></li>
<li class="dash"> <code>Doctrine\_Event::CONN_PREPARE</code></li>
<li class="dash"> <code>Doctrine\_Event::CONN_CONNECT</code></li>
<li class="dash"> <code>Doctrine\_Event::STMT_EXECUTE</code></li>
<li class="dash"> <code>Doctrine\_Event::STMT_FETCH</code></li>
<li class="dash"> <code>Doctrine\_Event::STMT_FETCHALL</code></li>
<li class="dash"> <code>Doctrine\_Event::TX_BEGIN</code></li>
<li class="dash"> <code>Doctrine\_Event::TX_COMMIT</code></li>
<li class="dash"> <code>Doctrine\_Event::TX_ROLLBACK</code></li>
<li class="dash"> <code>Doctrine\_Event::SAVEPOINT_CREATE</code></li>
<li class="dash"> <code>Doctrine\_Event::SAVEPOINT_ROLLBACK</code></li>
<li class="dash"> <code>Doctrine\_Event::SAVEPOINT_COMMIT</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD_DELETE</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD_SAVE</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD_UPDATE</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD_INSERT</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD_SERIALIZE</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD_UNSERIALIZE</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD\_DQL_SELECT</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD\_DQL_DELETE</code></li>
<li class="dash"> <code>Doctrine\_Event::RECORD\_DQL_UPDATE</code></li>
</ul>

<p>フックの使い方と返されるコードの例は次の通りです:</p>
<blockquote><p>class MyListener extends Doctrine\_EventListener { public function</p>
</blockquote>
<p>preExec(Doctrine\_Event $event) { $event-&gt;getCode(); //
Doctrine\_Event::CONN\_EXEC } }</p>
<p>class MyRecord extends Doctrine\_Record { public function
preUpdate(Doctrine\_Event $event) { $event-&gt;getCode(); //
Doctrine\_Event::RECORD\_UPDATE } }</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">インボーカーを取得する<i class="fas fa-link"></i></a></h2>
<p><code>getInvoker()</code>メソッドは与えられたイベントを起動したオブジェクトを返します。例えばイベント用の<code>Doctrine\_Event::CONN\_QUERY</code>インボーカーは<code>Doctrine_Connection</code>オブジェクトです。</p>
<p><code>Doctrine_Record</code>インスタンスが保存されupdateがデータベースに発行されるときに起動する<code>preUpdate()</code>という名前のレコードフックの使い方の例は次の通りです:</p>
<blockquote><p>class MyRecord extends Doctrine\_Record { public function</p>
</blockquote>
<p>preUpdate(Doctrine\_Event $event) { $event-&gt;getInvoker(); //
Object(MyRecord) } }</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">次のオペレーションをスキップする<i class="fas fa-link"></i></a></h2>
<p>リスナーチェーンのビヘイビアの変更と同様にリスニングされているメソッドの実行の変更のために<code>Doctrine_Event</code>は多くのメソッドを提供します。</p>
<p>多くの理由からリスニングされているメソッドの実行をスキップしたいことがあります。これは次のように実現できます(<code>preExec()</code>は任意のリスナーメソッドにできることに注意してください):</p>
<blockquote><p>class MyListener extends Doctrine\_EventListener { public function</p>
</blockquote>
<p>preExec(Doctrine\_Event $event) { // some business logic, then:</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>event->skipOperation();</code></pre></div>
<p>}</p>
<hr />
<a class="section-anchor" id="" name=""></a><h2 class="section-header"><a href="#">次のリスナーをスキップする<i class="fas fa-link"></i></a></h2>
<p>リスナーのチェーンを使うとき次のリスナーの実行をスキップしたいことがあります。これは次のように実現できます:</p>
<blockquote><p>class MyListener extends Doctrine\_EventListener { public function</p>
</blockquote>
<p>preExec(Doctrine\_Event $event) { // some business logic, then:</p>
<div class="console"><pre><code class="console"><span class="noselect">$ </span>event->skipNextListener();</code></pre></div>
<p>}</p>
<hr />
<a class="section-anchor" id="" name=""></a><h1 class="section-header"><a href="#">まとめ<i class="fas fa-link"></i></a></h1>
<p>イベントリスナーはDoctrineの素晴らしい機能で[doc behaviors
:name]に結びつけられます。これらは最小量のコードで非常に複雑な機能を提供します。</p>
<p>これでパフォーマンスを改善するためのベストな機能である[doc caching
:name]を検討する準備ができました。</p>
<p></p>
            </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://cdn.ravenjs.com/3.24.2/raven.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            Raven.config('https://09ce137590054cfd8f0b7e9324d6ec14@sentry.io/1197701').install()
        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?4138a7"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?493399"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            new Main();

            new Search(projectSlug, versionSlug, searchBoxSettings);

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }

            function googleTranslateElementInit() {
                $('#google_translate_element').html('');

                new google.translate.TranslateElement(
                    {pageLanguage: 'en'}, 'google_translate_element'
                );

                $('#google_translate_element select').on('change', function() {
                    var language = $('#google_translate_element select option:selected').text();

                    googleAnalyticsEvent('Translate', 'click', language);
                });
            }
        </script>

        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>

        
        
            </body>
</html>
