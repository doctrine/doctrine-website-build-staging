<!DOCTYPE html>
<html>
    <head>
        <title>Master and Slave Connections - Doctrine1 ORM (Doctrine1)</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="PHP 5 Doctrine1 Object Relational Mapper (ORM)
">

        <meta name="keywords" content="php,doctrine1,orm">

                    <meta name="robots" content="noindex">
        
                    <link rel="canonical" href="https://staging.doctrine-project.org/projects/doctrine1/en/latest/cookbook/master-and-slave-connections.html" />
    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?3625e4" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/components/highlightjs/styles/railscasts.css?b4f8ae" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine1/en/latest/cookbook/master-and-slave-connections.html" />
        <meta property="og:title" content="Master and Slave Connections - Doctrine1 ORM (Doctrine1)" />
        <meta property="og:description" content="PHP 5 Doctrine1 Object Relational Mapper (ORM)
" />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Course",
            "name": "Doctrine Doctrine1 ORM",
            "description": "Master and Slave Connections",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://staging.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu projects-dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/couchdb-odm.html">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>

                <div class="search-results rounded">
                    <div id="hits">
                        <!-- Hits widget will appear here -->
                    </div>

                    <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
                </div>
            </nav>
        
            <div class="container-wrapper container-fluid">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        
<div class="toc"><ul><li id="code-igniter-and-doctrine-html-title-1" class="toc-item"><a href="code-igniter-and-doctrine.html#title.1">CodeIgniter and Doctrine</a></li><ul><li id="code-igniter-and-doctrine-html-title-1-1" class="toc-item"><a href="code-igniter-and-doctrine.html#title.1.1">Download Doctrine</a></li><li id="code-igniter-and-doctrine-html-title-1-2" class="toc-item"><a href="code-igniter-and-doctrine.html#title.1.2">Setup Doctrine</a></li><li id="code-igniter-and-doctrine-html-title-1-3" class="toc-item"><a href="code-igniter-and-doctrine.html#title.1.3">Setup Command Line Interface</a></li><li id="code-igniter-and-doctrine-html-title-1-4" class="toc-item"><a href="code-igniter-and-doctrine.html#title.1.4">Start Using Doctrine</a></li></ul><li id="creating-a-unit-of-work-using-doctrine-html-title-1" class="toc-item"><a href="creating-a-unit-of-work-using-doctrine.html#title.1">Writing a Unit of Work in PHP Doctrine</a></li><li id="index-html-title-1" class="toc-item"><a href="index.html#title.1">Cookbook</a></li><li id="master-and-slave-connections-html-title-1" class="toc-item"><a href="master-and-slave-connections.html#title.1">Master and Slave Connections</a></li><li id="my-first-project-html-title-1" class="toc-item"><a href="my-first-project.html#title.1">Introduction</a></li><li id="my-first-project-html-title-2" class="toc-item"><a href="my-first-project.html#title.2">Download</a></li><li id="my-first-project-html-title-3" class="toc-item"><a href="my-first-project.html#title.3">Running the CLI</a></li><li id="my-first-project-html-title-4" class="toc-item"><a href="my-first-project.html#title.4">Defining Schema</a></li><li id="my-first-project-html-title-5" class="toc-item"><a href="my-first-project.html#title.5">Test Data Fixtures</a></li><li id="my-first-project-html-title-6" class="toc-item"><a href="my-first-project.html#title.6">Building Everything Now that you have written your schema files and</a></li><li id="my-first-project-html-title-7" class="toc-item"><a href="my-first-project.html#title.7">Running Tests</a></li><li id="plug-and-play-schema-information-with-templates-html-title-1" class="toc-item"><a href="plug-and-play-schema-information-with-templates.html#title.1">Plug and Play Schema Information with Templates</a></li><li id="record-based-retrieval-security-template-html-title-1" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1">Record-based Retrieval Security Template</a></li><ul><li id="record-based-retrieval-security-template-html-title-1-1" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.1">Introduction</a></li><li id="record-based-retrieval-security-template-html-title-1-2" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.2">Template</a></li><li id="record-based-retrieval-security-template-html-title-1-3" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.3">YAML schema syntax</a></li><li id="record-based-retrieval-security-template-html-title-1-4" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.4">Using the template</a></li><li id="record-based-retrieval-security-template-html-title-1-5" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.5">User setup</a></li><li id="record-based-retrieval-security-template-html-title-1-6" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.6">Querying</a></li><li id="record-based-retrieval-security-template-html-title-1-7" class="toc-item"><a href="record-based-retrieval-security-template.html#title.1.7">Restrictions</a></li></ul><li id="taking-advantage-of-column-aggregation-inheritance-html-title-1" class="toc-item"><a href="taking-advantage-of-column-aggregation-inheritance.html#title.1">Taking Advantage of Column Aggregation Inheritance</a></li></ul></div>
                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects.html">Projects</a></li>
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine1.html">Doctrine1</a></li>
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine1/en/latest/">Documentation</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Master and Slave Connections</li>
                            </ol>
                        </nav>
                                    </div>

                                    <div class="alert caution bg-light-yellow text-dark border"><i class="fas fa-exclamation-circle text-warning mr-2"></i> This project is no longer maintained and has been archived.</div>
                
                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            <ul class="list-inline">
                                                                            <li class="list-inline-item mr-0">
                                            <a href="/projects/doctrine1/en/latest/cookbook/master-and-slave-connections.html" class="project-version-switcher badge badge-warning">master</a>
                                        </li>
                                    
                                    
                                    <li class="list-inline-item ml-2"><a href="https://github.com/doctrine/doctrine1-documentation/edit/master/source/en/cookbook/master-and-slave-connections.rst" class="badge badge-primary">Edit</a></li>

                                </ul>
                            
                            
<p></p>
<hr />
<a class="section-anchor" id="title.1" name="title.1"></a><h1 class="section-header"><a href="#title.1">Master and Slave Connections<i class="fas fa-link"></i></a></h1>
<p>In this tutorial we explain how you can setup Doctrine connections as
master and slaves for both reading and writing data. This strategy is
common when balancing load across database servers.</p>
<p>So, the first thing we need to do is configure all the available
connections for Doctrine.</p>
<blockquote><p>$connections = array( 'master' =&gt; 'mysql://root:@master/dbname',</p>
</blockquote>
<p>'slave\_1' =&gt; 'mysql://root:@slave1/dbname', 'slave\_2' =&gt;
'mysql://root:@slave2/dbname', 'slave\_3' =&gt;
'mysql://root:@slave3/dbname', 'slave\_4' =&gt;
'mysql://root:@slave4/dbname' );</p>
<p>foreach ($connections as $name =&gt;
`dsn) { Doctrine_Manager::connection(`\ dsn, $name); }
Now that we have one master connection and four slaves setup we can
override the Doctrine_Record and Doctrine\_Query classes to add our
logic for switching between the connections for read and write
functionality. All writes will go to the master connection and all reads
will be randomly distributed across the available slaves.</p>
<p>Lets start by adding our logic to Doctrine\_Query by extending it with
our own MyQuery class and switching the connection in the preQuery()
hook.</p>
<blockquote><p>class MyQuery extends Doctrine\_Query { // Since php doesn't support</p>
</blockquote>
<p>late static binding in 5.2 we need to override // this method to
instantiate a new MyQuery instead of Doctrine\_Query public static
function create(`conn = null) { return new MyQuery(`\ conn); }</p>
<pre><code class="">public function preQuery()
{
    // If this is a select query then set connection to one of the slaves
    if ($this-&gt;getType() == Doctrine_Query::SELECT) {
        $this-&gt;_conn = Doctrine_Manager::getInstance()-&gt;getConnection('slave_' . rand(1, 4));
    // All other queries are writes so they need to go to the master
    } else {
        $this-&gt;_conn = Doctrine_Manager::getInstance()-&gt;getConnection('master');
    }
}
</code></pre>
<p>}</p>
<p>Now we have queries taken care of, but what about when saving records?
We can force the connection for writes to the master by overriding
Doctrine\_Record and using it as the base for all of our models.</p>
<blockquote><p>abstract class MyRecord extends Doctrine\_Record { public function</p>
</blockquote>
<p>save(Doctrine\_Connection
`conn = null) { // If specific connection is not provided then lets force the connection // to be the master if (`\ conn=== null) {
`conn = Doctrine_Manager::getInstance()-&gt;getConnection('master'); } parent::save(`\ conn);} }</p>
<p>All done! Now reads will be distributed to the slaves and writes are
given to the master connection. Below are some examples of what happens
now when querying and saving records.</p>
<p>First we need to setup a model to test with.</p>
<blockquote><p>class User extends MyRecord { public function setTableDefinition() {</p>
</blockquote>
<p>$this-&gt;setTableName('user'); $this-&gt;hasColumn('username', 'string', 255,
array('type' =&gt; 'string', 'length' =&gt; '255'));
$this-&gt;hasColumn('password', 'string', 255, array('type' =&gt; 'string',
'length' =&gt; '255')); } }</p>
<blockquote><p>// The save() method will happen on the master connection because it is</p>
</blockquote>
<p>a write $user = new User(); $user-&gt;username = 'jwage'; $user-&gt;password =
'changeme'; $user-&gt;save();</p>
<p>// This query goes to one of the slaves because it is a read $q = new
MyQuery(); $q-&gt;from('User u'); $users = $q-&gt;execute();</p>
<p>print\_r($users-&gt;toArray(true));</p>
<p>// This query goes to the master connection because it is a write $q =
new MyQuery(); $q-&gt;delete('User') -&gt;from('User u') -&gt;execute();</p>
<p></p>
                                            </div>
                </div>
            </main>
        </div>
    </div>

                            
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://staging.doctrine-project.org/components/highlightjs/highlight.pack.js?3970aa"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?f32c09"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?21d569"></script>

        <script type="text/javascript">
            var projectSlug = 'doctrine1';
            var versionSlug = 'latest';

            new Main();

            new Search(projectSlug, versionSlug);
        </script>

            <script src="https://staging.doctrine-project.org/js/sidebar.js?6349dd"></script>

    <script type="text/javascript">
        new Sidebar();
    </script>

        
        
            </body>
</html>
