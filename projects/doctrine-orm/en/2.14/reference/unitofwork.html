<!DOCTYPE html>
<html>
    <head>
        <title>        Doctrine Internals explained - Doctrine Object Relational Mapper (ORM)
    </title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="Doctrine Object Relational Mapper Documentation: Doctrine Internals explained ">

        <meta name="keywords" content="                    orm,database,documentation,doctrine,internals,explained
    ">

                    <meta name="robots" content="noindex">
        
        
                    <link rel="canonical" href="https://staging.doctrine-project.org/projects/doctrine-orm/en/3.2/reference/unitofwork.html" />
    
        <link
            rel="stylesheet"
            type="text/css"
            href="https://staging.doctrine-project.org/frontend/css/index.css?c900c9"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine-orm/en/2.14/reference/unitofwork.html" />
        <meta property="og:title" content="        Doctrine Internals explained - Doctrine Object Relational Mapper (ORM)
    " />
        <meta property="og:description" content="Doctrine Object Relational Mapper Documentation: Doctrine Internals explained " />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Doctrine Object Relational Mapper",
            "description": "Doctrine Internals explained",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://staging.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://staging.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item" href="/projects/rst-parser.html">RST Parser</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/sponsorship.html">Sponsorship</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/orm/edit/2.14.x/docs/en/reference/unitofwork.rst" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>
                </div>
                <div class="nav-outbound">
                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <div class="container-wrapper container">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>

                        

            <div class="toc-section">
<h2 class="toc-header">Tutorials</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="../tutorials/getting-started.html#getting-started-with-doctrine">Getting Started with Doctrine</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/getting-started-database.html#getting-started-database-first">Getting Started: Database First</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/getting-started-models.html#getting-started-model-first">Getting Started: Model First</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/working-with-indexed-associations.html#working-with-indexed-associations">Working with Indexed Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/extra-lazy-associations.html#extra-lazy-associations">Extra Lazy Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/composite-primary-keys.html#composite-and-foreign-keys-as-primary-key">Composite and Foreign Keys as Primary Key</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/ordered-associations.html#ordering-to-many-associations">Ordering To-Many Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/override-field-association-mappings-in-subclasses.html#override-field-association-mappings-in-subclasses">Override Field Association Mappings In Subclasses</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/pagination.html#pagination">Pagination</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/embeddables.html#separating-concerns-using-embeddables">Separating Concerns using Embeddables</a>


</li>
    </ul>
</div>
</div><div class="toc-section">
<h2 class="toc-header">Reference</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="architecture.html#architecture">Architecture</a>


</li>
    <li class="toc-item">
    <a href="configuration.html#installation-and-configuration">Installation and Configuration</a>


</li>
    <li class="toc-item">
    <a href="faq.html#frequently-asked-questions">Frequently Asked Questions</a>


</li>
    <li class="toc-item">
    <a href="basic-mapping.html#basic-mapping">Basic Mapping</a>


</li>
    <li class="toc-item">
    <a href="association-mapping.html#association-mapping">Association Mapping</a>


</li>
    <li class="toc-item">
    <a href="inheritance-mapping.html#inheritance-mapping">Inheritance Mapping</a>


</li>
    <li class="toc-item">
    <a href="working-with-objects.html#working-with-objects">Working with Objects</a>


</li>
    <li class="toc-item">
    <a href="working-with-associations.html#working-with-associations">Working with Associations</a>


</li>
    <li class="toc-item">
    <a href="events.html#events">Events</a>


</li>
    <li class="toc-item opened">
    <a href="#doctrine-internals-explained">Doctrine Internals explained</a>


</li>
    <li class="toc-item">
    <a href="unitofwork-associations.html#association-updates-owning-side-and-inverse-side">Association Updates: Owning Side and Inverse Side</a>


</li>
    <li class="toc-item">
    <a href="transactions-and-concurrency.html#transactions-and-concurrency">Transactions and Concurrency</a>


</li>
    <li class="toc-item">
    <a href="batch-processing.html#batch-processing">Batch Processing</a>


</li>
    <li class="toc-item">
    <a href="dql-doctrine-query-language.html#doctrine-query-language">Doctrine Query Language</a>


</li>
    <li class="toc-item">
    <a href="query-builder.html#the-querybuilder">The QueryBuilder</a>


</li>
    <li class="toc-item">
    <a href="native-sql.html#native-sql">Native SQL</a>


</li>
    <li class="toc-item">
    <a href="change-tracking-policies.html#change-tracking-policies">Change Tracking Policies</a>


</li>
    <li class="toc-item">
    <a href="partial-objects.html#partial-objects">Partial Objects</a>


</li>
    <li class="toc-item">
    <a href="annotations-reference.html#annotations-reference">Annotations Reference</a>


</li>
    <li class="toc-item">
    <a href="attributes-reference.html#attributes-reference">Attributes Reference</a>


</li>
    <li class="toc-item">
    <a href="xml-mapping.html#xml-mapping">XML Mapping</a>


</li>
    <li class="toc-item">
    <a href="yaml-mapping.html#yaml-mapping">YAML Mapping</a>


</li>
    <li class="toc-item">
    <a href="php-mapping.html#php-mapping">PHP Mapping</a>


</li>
    <li class="toc-item">
    <a href="caching.html#caching">Caching</a>


</li>
    <li class="toc-item">
    <a href="improving-performance.html#improving-performance">Improving Performance</a>


</li>
    <li class="toc-item">
    <a href="tools.html#tools">Tools</a>


</li>
    <li class="toc-item">
    <a href="metadata-drivers.html#metadata-drivers">Metadata Drivers</a>


</li>
    <li class="toc-item">
    <a href="best-practices.html#best-practices">Best Practices</a>


</li>
    <li class="toc-item">
    <a href="limitations-and-known-issues.html#limitations-and-known-issues">Limitations and Known Issues</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/pagination.html#pagination">Pagination</a>


</li>
    <li class="toc-item">
    <a href="filters.html#filters">Filters</a>


</li>
    <li class="toc-item">
    <a href="namingstrategy.html#implementing-a-namingstrategy">Implementing a NamingStrategy</a>


</li>
    <li class="toc-item">
    <a href="advanced-configuration.html#advanced-configuration">Advanced Configuration</a>


</li>
    <li class="toc-item">
    <a href="second-level-cache.html#the-second-level-cache">The Second Level Cache</a>


</li>
    <li class="toc-item">
    <a href="security.html#security">Security</a>


</li>
    </ul>
</div>
</div><div class="toc-section">
<h2 class="toc-header">Cookbook</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="../cookbook/aggregate-fields.html#aggregate-fields">Aggregate Fields</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/custom-mapping-types.html#custom-mapping-types">Custom Mapping Types</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/decorator-pattern.html#persisting-the-decorator-pattern">Persisting the Decorator Pattern</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/dql-custom-walkers.html#extending-dql-in-doctrine-orm-custom-ast-walkers">Extending DQL in Doctrine ORM: Custom AST Walkers</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/dql-user-defined-functions.html#dql-user-defined-functions">DQL User Defined Functions</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/implementing-arrayaccess-for-domain-objects.html#implementing-arrayaccess-for-domain-objects">Implementing ArrayAccess for Domain Objects</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/implementing-the-notify-changetracking-policy.html#implementing-the-notify-changetracking-policy">Implementing the Notify ChangeTracking Policy</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/resolve-target-entity-listener.html#keeping-your-modules-independent">Keeping your Modules independent</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/sql-table-prefixes.html#sql-table-prefixes">SQL-Table Prefixes</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/strategy-cookbook-introduction.html#strategy-pattern">Strategy-Pattern</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/validation-of-entities.html#validation-of-entities">Validation of Entities</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/working-with-datetime.html#working-with-datetime-instances">Working with DateTime Instances</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/mysql-enums.html#mysql-enums">Mysql Enums</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/advanced-field-value-conversion-using-custom-mapping-types.html#advanced-field-value-conversion-using-custom-mapping-types">Advanced field value conversion using custom mapping types</a>


</li>
    <li class="toc-item">
    <a href="../cookbook/entities-in-session.html#entities-in-the-session">Entities in the Session</a>


</li>
    </ul>
</div>
</div>
    

                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
                {
            "@type": "ListItem",
            "position": 1,
            "name": "Projects",
            "item": "https://staging.doctrine-project.org/projects.html"
        },                {
            "@type": "ListItem",
            "position": 2,
            "name": "ORM",
            "item": "https://staging.doctrine-project.org/projects/orm.html"
        },                {
            "@type": "ListItem",
            "position": 3,
            "name": "Documentation",
            "item": "https://staging.doctrine-project.org/projects/doctrine-orm/en/2.14/index.html"
        },                {
            "@type": "ListItem",
            "position": 4,
            "name": "Doctrine Internals explained",
            "item": "https://staging.doctrine-project.org/projects/doctrine-orm/en/2.14/reference/unitofwork.html"
        }            ]
}
</script>

<nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
    <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects.html">Projects</a></li>
                                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/orm.html">ORM</a></li>
                                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine-orm/en/2.14/index.html">Documentation</a></li>
                                                <li class="breadcrumb-item active" aria-current="page">Doctrine Internals explained</li>
                        </ol>
</nav>
                                    </div>

                    
    <div class="alert caution bg-light-yellow text-dark border">
    <table width="100%">
        <tr>
            <td width="10" class="align-top">
                <i class="fas fa-exclamation-circle text-warning mr-2"></i>
            </td>
            <td><p>You are browsing a version that is no longer maintained.</p></td>
        </tr>
    </table>
</div>

                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            
                                <div class="dropdown show d-inline-block">
                                    <a class="project-version-switcher btn btn-secondary btn-sm dropdown-toggle" href="/projects/doctrine-orm/en/2.14/reference/unitofwork.html" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        2.14.3
                                    </a>

                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                                                    <h6 class="dropdown-header">Maintained</h6>

                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/latest/reference/unitofwork.html">
                                                        4.0

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/3.3/reference/unitofwork.html">
                                                        3.3

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/3.2/reference/unitofwork.html">
                                                        3.2.2

                                                                                                                    (current)
                                                        
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.20/reference/unitofwork.html">
                                                        2.20

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.19/reference/unitofwork.html">
                                                        2.19.7

                                                        
                                                                                                            </a>
                                                                                                                                    
                                                                                    <h6 class="dropdown-header">Unmaintained</h6>

                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/3.1/reference/unitofwork.html">3.1</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/3.0/reference/unitofwork.html">3.0</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.18/reference/unitofwork.html">2.18</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.17/reference/unitofwork.html">2.17</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.16/reference/unitofwork.html">2.16</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.15/reference/unitofwork.html">2.15</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item active" href="/projects/doctrine-orm/en/2.14/reference/unitofwork.html">2.14</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.13/reference/unitofwork.html">2.13</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.12/reference/unitofwork.html">2.12</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.11/reference/unitofwork.html">2.11</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.10/reference/unitofwork.html">2.10</a>
                                                                                                                                                                        </div>
                                </div>
                            
                            

            <div class="section" id="doctrine-internals-explained">
            <h1 class="section-header ">
    <a href="#doctrine-internals-explained">
        Doctrine Internals explained
        <i class="fas fa-link"></i>
    </a>
</h1>
            
    <p>Object relational mapping is a complex topic and sufficiently understanding how Doctrine works internally helps you use its full power.</p>

            <div class="section" id="how-doctrine-keeps-track-of-objects">
            <h2 class="section-header ">
    <a href="#how-doctrine-keeps-track-of-objects">
        How Doctrine keeps track of Objects
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Doctrine uses the Identity Map pattern to track objects. Whenever you fetch an
object from the database, Doctrine will keep a reference to this object inside
its UnitOfWork. The array holding all the entity references is two-levels deep
and has the keys &quot;root entity name&quot; and &quot;id&quot;. Since Doctrine allows composite
keys the id is a sorted, serialized version of all the key columns.</p>

            
    <p>This allows Doctrine room for optimizations. If you call the EntityManager and
ask for an entity with a specific ID twice, it will return the same instance:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="ff329b02e54b6d1d096c84e517a5ca4ada5295cb"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="ff329b02e54b6d1d096c84e517a5ca4ada5295cb"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-1" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-1">1</a></td><td class="code-line" rowspan="7"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testIdentityMap</span><span class="hljs-params">()</span>: <span class="hljs-title">void</span>
</span>{
    $objectA = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;find(<span class="hljs-string">'EntityName'</span>, <span class="hljs-number">1</span>);
    $objectB = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;find(<span class="hljs-string">'EntityName'</span>, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">$this</span>-&gt;assertSame($objectA, $objectB)
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-2" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-3" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-4" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-5" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-6" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-7" class="line-number-anchor" /><a href="#line-number-ff329b02e54b6d1d096c84e517a5ca4ada5295cb-7">7</a></td></tr></table></div></code></pre>
            
    <p>Only one SELECT query will be fired against the database here. In the second
<code>EntityManager#find()</code> call Doctrine will check the identity map first and
doesn&#039;t need to make that database roundtrip.</p>

            
    <p>Even if you get a proxy object first then fetch the object by the same id you
will still end up with the same reference:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="dc76da01b8cfd868e272dea8ca8e29a84f72c2fc"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="dc76da01b8cfd868e272dea8ca8e29a84f72c2fc"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-1" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-1">1</a></td><td class="code-line" rowspan="10"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testIdentityMapReference</span><span class="hljs-params">()</span>: <span class="hljs-title">void</span>
</span>{
    $objectA = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;getReference(<span class="hljs-string">'EntityName'</span>, <span class="hljs-number">1</span>);
    <span class="hljs-comment">// check for proxyinterface</span>
    <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(<span class="hljs-string">'Doctrine\Persistence\Proxy'</span>, $objectA);

    $objectB = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;find(<span class="hljs-string">'EntityName'</span>, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">$this</span>-&gt;assertSame($objectA, $objectB)
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-2" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-3" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-4" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-5" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-6" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-7" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-8" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-9" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-10" class="line-number-anchor" /><a href="#line-number-dc76da01b8cfd868e272dea8ca8e29a84f72c2fc-10">10</a></td></tr></table></div></code></pre>
            
    <p>The identity map being indexed by primary keys only allows shortcuts when you
ask for objects by primary key. Assume you have the following <code>persons</code>
table:</p>

            <div class="console"><pre><code class="console">id | name
-------------
1  | Benjamin
2  | Bud</code></pre></div>
            
    <p>Take the following example where two
consecutive calls are made against a repository to fetch an entity by a set of
criteria:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="881371516624005535172dce540f4e2cd22836a8"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="881371516624005535172dce540f4e2cd22836a8"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-1" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-1">1</a></td><td class="code-line" rowspan="8"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testIdentityMapRepositoryFindBy</span><span class="hljs-params">()</span>
</span>{
    $repository = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;getRepository(<span class="hljs-string">'Person'</span>);
    $objectA = $repository-&gt;findOneBy(<span class="hljs-keyword">array</span>(<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Benjamin'</span>));
    $objectB = $repository-&gt;findOneBy(<span class="hljs-keyword">array</span>(<span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'Benjamin'</span>));

    <span class="hljs-keyword">$this</span>-&gt;assertSame($objectA, $objectB);
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-2" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-3" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-4" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-5" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-6" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-7" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-881371516624005535172dce540f4e2cd22836a8-8" class="line-number-anchor" /><a href="#line-number-881371516624005535172dce540f4e2cd22836a8-8">8</a></td></tr></table></div></code></pre>
            
    <p>This query will still return the same references and <code>$objectA</code> and <code>$objectB</code>
are indeed referencing the same object. However when checking your SQL logs you
will realize that two queries have been executed against the database. Doctrine
only knows objects by id, so a query for different criteria has to go to the
database, even if it was executed just before.</p>

            
    <p>But instead of creating a second Person object Doctrine first gets the primary
key from the row and check if it already has an object inside the UnitOfWork
with that primary key. In our example it finds an object and decides to return
this instead of creating a new one.</p>

            
    <p>The identity map has a second use-case. When you call <code>EntityManager#flush</code>
Doctrine will ask the identity map for all objects that are currently managed.
This means you don&#039;t have to call <code>EntityManager#persist</code> over and over again
to pass known objects to the EntityManager. This is a NO-OP for known entities,
but leads to much code written that is confusing to other developers.</p>

            
    <p>The following code WILL update your database with the changes made to the
<code>Person</code> object, even if you did not call <code>EntityManager#persist</code>:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="1187cfbe5214bb7fcb335a54a203d30b63b5168e"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="1187cfbe5214bb7fcb335a54a203d30b63b5168e"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-1" class="line-number-anchor" /><a href="#line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-1">1</a></td><td class="code-line" rowspan="4"><span class="hljs-meta">&lt;?php</span>
$user = $entityManager-&gt;find(<span class="hljs-string">"Person"</span>, <span class="hljs-number">1</span>);
$user-&gt;setName(<span class="hljs-string">"Guilherme"</span>);
$entityManager-&gt;flush();</td></tr>
<tr><td class="line-number noselect"><a name="line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-2" class="line-number-anchor" /><a href="#line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-3" class="line-number-anchor" /><a href="#line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-4" class="line-number-anchor" /><a href="#line-number-1187cfbe5214bb7fcb335a54a203d30b63b5168e-4">4</a></td></tr></table></div></code></pre>
    </div>
            <div class="section" id="how-doctrine-detects-changes">
            <h2 class="section-header ">
    <a href="#how-doctrine-detects-changes">
        How Doctrine Detects Changes
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Doctrine is a data-mapper that tries to achieve persistence-ignorance (PI).
This means you map php objects into a relational database that don&#039;t
necessarily know about the database at all. A natural question would now be,
&quot;how does Doctrine even detect objects have changed?&quot;.</p>

            
    <p>For this Doctrine keeps a second map inside the UnitOfWork. Whenever you fetch
an object from the database Doctrine will keep a copy of all the properties and
associations inside the UnitOfWork. Because variables in the PHP language are
subject to &quot;copy-on-write&quot; the memory usage of a PHP request that only reads
objects from the database is the same as if Doctrine did not keep this variable
copy. Only if you start changing variables PHP will create new variables internally
that consume new memory.</p>

            
    <p>Now whenever you call <code>EntityManager#flush</code> Doctrine will iterate over the
Identity Map and for each object compares the original property and association
values with the values that are currently set on the object. If changes are
detected then the object is queued for a SQL UPDATE operation. Only the fields
that actually changed are updated.</p>

            
    <p>This process has an obvious performance impact. The larger the size of the
UnitOfWork is, the longer this computation takes. There are several ways to
optimize the performance of the Flush Operation:</p>

            

<ul>
    <li class="dash">Mark entities as read only. These entities can only be inserted or removed,
but are never updated. They are omitted in the changeset calculation.</li>
    <li class="dash">Temporarily mark entities as read only. If you have a very large UnitOfWork
but know that a large set of entities has not changed, just mark them as read
only with <code>$entityManager-&gt;getUnitOfWork()-&gt;markReadOnly($entity)</code>.</li>
    <li class="dash">Flush only a single entity with <code>$entityManager-&gt;flush($entity)</code>.</li>
    <li class="dash">Use <a href="change-tracking-policies.html">Change Tracking Policies</a> to use more
explicit strategies of notifying the UnitOfWork what objects/properties
changed.</li>
</ul>

                        <div class="alert note-admonition bg-light-yellow text-dark border ">
    <table width="100%">
        <tbody>
        <tr>
            <td width="10" class="align-top"><i class="fas fa-sticky-note text-primary mr-2"></i></td>
            <td>
                                                
    <p>Flush only a single entity with <code>$entityManager-&gt;flush($entity)</code> is deprecated and will be removed in ORM 3.0.
(<a href="https://github.com/doctrine/orm/issues/8459">Details</a>)</p>

            </td>
        </tr>
        </tbody>
    </table>
</div>
    </div>
            <div class="section" id="query-internals">
            <h2 class="section-header ">
    <a href="#query-internals">
        Query Internals
        <i class="fas fa-link"></i>
    </a>
</h2>
    </div>
            <div class="section" id="the-different-orm-layers">
            <h2 class="section-header ">
    <a href="#the-different-orm-layers">
        The different ORM Layers
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Doctrine ships with a set of layers with different responsibilities. This
section gives a short explanation of each layer.</p>

            <div class="section" id="hydration">
            <h3 class="section-header ">
    <a href="#hydration">
        Hydration
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>Responsible for creating a final result from a raw database statement and a
result-set mapping object. The developer can choose which kind of result they
wish to be hydrated. Default result-types include:</p>

            

<ul>
    <li class="dash">SQL to Entities</li>
    <li class="dash">SQL to structured Arrays</li>
    <li class="dash">SQL to simple scalar result arrays</li>
    <li class="dash">SQL to a single result variable</li>
</ul>

            
    <p>Hydration to entities and arrays is one of the most complex parts of Doctrine
algorithm-wise. It can build results with for example:</p>

            

<ul>
    <li class="dash">Single table selects</li>
    <li class="dash">Joins with n:1 or 1:n cardinality, grouping belonging to the same parent.</li>
    <li class="dash">Mixed results of objects and scalar values</li>
    <li class="dash">Hydration of results by a given scalar value as key.</li>
</ul>

    </div>
            <div class="section" id="persisters">
            <h3 class="section-header ">
    <a href="#persisters">
        Persisters
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
            <div class="section" id="unitofwork">
            <h3 class="section-header ">
    <a href="#unitofwork">
        UnitOfWork
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
            <div class="section" id="resultsetmapping">
            <h3 class="section-header ">
    <a href="#resultsetmapping">
        ResultSetMapping
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
            <div class="section" id="dql-parser">
            <h3 class="section-header ">
    <a href="#dql-parser">
        DQL Parser
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
            <div class="section" id="sqlwalker">
            <h3 class="section-header ">
    <a href="#sqlwalker">
        SQLWalker
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
            <div class="section" id="entitymanager">
            <h3 class="section-header ">
    <a href="#entitymanager">
        EntityManager
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
            <div class="section" id="classmetadatafactory">
            <h3 class="section-header ">
    <a href="#classmetadatafactory">
        ClassMetadataFactory
        <i class="fas fa-link"></i>
    </a>
</h3>
            
    <p>tbr</p>

    </div>
    </div>
    </div>
        

                                                </div>
                </div>
            </main>
        </div>
    </div>

        <button id="back-to-top" title="Go to top">Top</button>

                
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://staging.doctrine-project.org/frontend/js/bundle.js?ff3b61"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = 'orm';
            var versionSlug = '2.14';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search ORM 2.14'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
        
            </body>
</html>
