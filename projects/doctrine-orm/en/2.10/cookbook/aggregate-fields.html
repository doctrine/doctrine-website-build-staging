<!DOCTYPE html>
<html>
    <head>
        <title>        Aggregate Fields - Doctrine Object Relational Mapper (ORM)
    </title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="Doctrine Object Relational Mapper Documentation: Aggregate Fields ">

        <meta name="keywords" content="                    orm,database,documentation,aggregate,fields
    ">

                    <meta name="robots" content="noindex">
        
        
                    <link rel="canonical" href="https://staging.doctrine-project.org/projects/doctrine-orm/en/3.2/cookbook/aggregate-fields.html" />
    
        <link
            rel="stylesheet"
            type="text/css"
            href="https://staging.doctrine-project.org/frontend/css/index.css?c900c9"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine-orm/en/2.10/cookbook/aggregate-fields.html" />
        <meta property="og:title" content="        Aggregate Fields - Doctrine Object Relational Mapper (ORM)
    " />
        <meta property="og:description" content="Doctrine Object Relational Mapper Documentation: Aggregate Fields " />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Doctrine Object Relational Mapper",
            "description": "Aggregate Fields",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://staging.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://staging.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item" href="/projects/rst-parser.html">RST Parser</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/sponsorship.html">Sponsorship</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/orm/edit/2.10.x/docs/en/cookbook/aggregate-fields.rst" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>
                </div>
                <div class="nav-outbound">
                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <div class="container-wrapper container">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>

                        

            <div class="toc-section">
<h2 class="toc-header">Tutorials</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="../tutorials/getting-started.html#getting-started-with-doctrine">Getting Started with Doctrine</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/getting-started-database.html#getting-started-database-first">Getting Started: Database First</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/getting-started-models.html#getting-started-model-first">Getting Started: Model First</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/working-with-indexed-associations.html#working-with-indexed-associations">Working with Indexed Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/extra-lazy-associations.html#extra-lazy-associations">Extra Lazy Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/composite-primary-keys.html#composite-and-foreign-keys-as-primary-key">Composite and Foreign Keys as Primary Key</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/ordered-associations.html#ordering-to-many-associations">Ordering To-Many Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/override-field-association-mappings-in-subclasses.html#override-field-association-mappings-in-subclasses">Override Field Association Mappings In Subclasses</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/pagination.html#pagination">Pagination</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/embeddables.html#separating-concerns-using-embeddables">Separating Concerns using Embeddables</a>


</li>
    </ul>
</div>
</div><div class="toc-section">
<h2 class="toc-header">Reference</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="../reference/architecture.html#architecture">Architecture</a>


</li>
    <li class="toc-item">
    <a href="../reference/configuration.html#installation-and-configuration">Installation and Configuration</a>


</li>
    <li class="toc-item">
    <a href="../reference/faq.html#frequently-asked-questions">Frequently Asked Questions</a>


</li>
    <li class="toc-item">
    <a href="../reference/basic-mapping.html#basic-mapping">Basic Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/association-mapping.html#association-mapping">Association Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/inheritance-mapping.html#inheritance-mapping">Inheritance Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/working-with-objects.html#working-with-objects">Working with Objects</a>


</li>
    <li class="toc-item">
    <a href="../reference/working-with-associations.html#working-with-associations">Working with Associations</a>


</li>
    <li class="toc-item">
    <a href="../reference/events.html#events">Events</a>


</li>
    <li class="toc-item">
    <a href="../reference/unitofwork.html#doctrine-internals-explained">Doctrine Internals explained</a>


</li>
    <li class="toc-item">
    <a href="../reference/unitofwork-associations.html#association-updates-owning-side-and-inverse-side">Association Updates: Owning Side and Inverse Side</a>


</li>
    <li class="toc-item">
    <a href="../reference/transactions-and-concurrency.html#transactions-and-concurrency">Transactions and Concurrency</a>


</li>
    <li class="toc-item">
    <a href="../reference/batch-processing.html#batch-processing">Batch Processing</a>


</li>
    <li class="toc-item">
    <a href="../reference/dql-doctrine-query-language.html#doctrine-query-language">Doctrine Query Language</a>


</li>
    <li class="toc-item">
    <a href="../reference/query-builder.html#the-querybuilder">The QueryBuilder</a>


</li>
    <li class="toc-item">
    <a href="../reference/native-sql.html#native-sql">Native SQL</a>


</li>
    <li class="toc-item">
    <a href="../reference/change-tracking-policies.html#change-tracking-policies">Change Tracking Policies</a>


</li>
    <li class="toc-item">
    <a href="../reference/partial-objects.html#partial-objects">Partial Objects</a>


</li>
    <li class="toc-item">
    <a href="../reference/annotations-reference.html#annotations-reference">Annotations Reference</a>


</li>
    <li class="toc-item">
    <a href="../reference/attributes-reference.html#attributes-reference">Attributes Reference</a>


</li>
    <li class="toc-item">
    <a href="../reference/xml-mapping.html#xml-mapping">XML Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/yaml-mapping.html#yaml-mapping">YAML Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/php-mapping.html#php-mapping">PHP Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/caching.html#caching">Caching</a>


</li>
    <li class="toc-item">
    <a href="../reference/improving-performance.html#improving-performance">Improving Performance</a>


</li>
    <li class="toc-item">
    <a href="../reference/tools.html#tools">Tools</a>


</li>
    <li class="toc-item">
    <a href="../reference/metadata-drivers.html#metadata-drivers">Metadata Drivers</a>


</li>
    <li class="toc-item">
    <a href="../reference/best-practices.html#best-practices">Best Practices</a>


</li>
    <li class="toc-item">
    <a href="../reference/limitations-and-known-issues.html#limitations-and-known-issues">Limitations and Known Issues</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/pagination.html#pagination">Pagination</a>


</li>
    <li class="toc-item">
    <a href="../reference/filters.html#filters">Filters</a>


</li>
    <li class="toc-item">
    <a href="../reference/namingstrategy.html#implementing-a-namingstrategy">Implementing a NamingStrategy</a>


</li>
    <li class="toc-item">
    <a href="../reference/advanced-configuration.html#advanced-configuration">Advanced Configuration</a>


</li>
    <li class="toc-item">
    <a href="../reference/second-level-cache.html#the-second-level-cache">The Second Level Cache</a>


</li>
    <li class="toc-item">
    <a href="../reference/security.html#security">Security</a>


</li>
    </ul>
</div>
</div><div class="toc-section">
<h2 class="toc-header">Cookbook</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item opened">
    <a href="#aggregate-fields">Aggregate Fields</a>


</li>
    <li class="toc-item">
    <a href="custom-mapping-types.html#custom-mapping-types">Custom Mapping Types</a>


</li>
    <li class="toc-item">
    <a href="decorator-pattern.html#persisting-the-decorator-pattern">Persisting the Decorator Pattern</a>


</li>
    <li class="toc-item">
    <a href="dql-custom-walkers.html#extending-dql-in-doctrine-orm-custom-ast-walkers">Extending DQL in Doctrine ORM: Custom AST Walkers</a>


</li>
    <li class="toc-item">
    <a href="dql-user-defined-functions.html#dql-user-defined-functions">DQL User Defined Functions</a>


</li>
    <li class="toc-item">
    <a href="implementing-arrayaccess-for-domain-objects.html#implementing-arrayaccess-for-domain-objects">Implementing ArrayAccess for Domain Objects</a>


</li>
    <li class="toc-item">
    <a href="implementing-the-notify-changetracking-policy.html#implementing-the-notify-changetracking-policy">Implementing the Notify ChangeTracking Policy</a>


</li>
    <li class="toc-item">
    <a href="implementing-wakeup-or-clone.html#implementing-wakeup-or-clone">Implementing Wakeup or Clone</a>


</li>
    <li class="toc-item">
    <a href="resolve-target-entity-listener.html#keeping-your-modules-independent">Keeping your Modules independent</a>


</li>
    <li class="toc-item">
    <a href="sql-table-prefixes.html#sql-table-prefixes">SQL-Table Prefixes</a>


</li>
    <li class="toc-item">
    <a href="strategy-cookbook-introduction.html#strategy-pattern">Strategy-Pattern</a>


</li>
    <li class="toc-item">
    <a href="validation-of-entities.html#validation-of-entities">Validation of Entities</a>


</li>
    <li class="toc-item">
    <a href="working-with-datetime.html#working-with-datetime-instances">Working with DateTime Instances</a>


</li>
    <li class="toc-item">
    <a href="mysql-enums.html#mysql-enums">Mysql Enums</a>


</li>
    <li class="toc-item">
    <a href="advanced-field-value-conversion-using-custom-mapping-types.html#advanced-field-value-conversion-using-custom-mapping-types">Advanced field value conversion using custom mapping types</a>


</li>
    <li class="toc-item">
    <a href="entities-in-session.html#entities-in-the-session">Entities in the Session</a>


</li>
    </ul>
</div>
</div>
    

                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
                {
            "@type": "ListItem",
            "position": 1,
            "name": "Projects",
            "item": "https://staging.doctrine-project.org/projects.html"
        },                {
            "@type": "ListItem",
            "position": 2,
            "name": "ORM",
            "item": "https://staging.doctrine-project.org/projects/orm.html"
        },                {
            "@type": "ListItem",
            "position": 3,
            "name": "Documentation",
            "item": "https://staging.doctrine-project.org/projects/doctrine-orm/en/2.10/index.html"
        },                {
            "@type": "ListItem",
            "position": 4,
            "name": "Aggregate Fields",
            "item": "https://staging.doctrine-project.org/projects/doctrine-orm/en/2.10/cookbook/aggregate-fields.html"
        }            ]
}
</script>

<nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
    <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects.html">Projects</a></li>
                                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/orm.html">ORM</a></li>
                                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine-orm/en/2.10/index.html">Documentation</a></li>
                                                <li class="breadcrumb-item active" aria-current="page">Aggregate Fields</li>
                        </ol>
</nav>
                                    </div>

                    
    <div class="alert caution bg-light-yellow text-dark border">
    <table width="100%">
        <tr>
            <td width="10" class="align-top">
                <i class="fas fa-exclamation-circle text-warning mr-2"></i>
            </td>
            <td><p>You are browsing a version that is no longer maintained.</p></td>
        </tr>
    </table>
</div>

                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            
                                <div class="dropdown show d-inline-block">
                                    <a class="project-version-switcher btn btn-secondary btn-sm dropdown-toggle" href="/projects/doctrine-orm/en/2.10/cookbook/aggregate-fields.html" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        2.10.5
                                    </a>

                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                                                    <h6 class="dropdown-header">Maintained</h6>

                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/latest/cookbook/aggregate-fields.html">
                                                        4.0

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/3.3/cookbook/aggregate-fields.html">
                                                        3.3

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/3.2/cookbook/aggregate-fields.html">
                                                        3.2.2

                                                                                                                    (current)
                                                        
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.20/cookbook/aggregate-fields.html">
                                                        2.20

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.19/cookbook/aggregate-fields.html">
                                                        2.19.7

                                                        
                                                                                                            </a>
                                                                                                                                    
                                                                                    <h6 class="dropdown-header">Unmaintained</h6>

                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/3.1/cookbook/aggregate-fields.html">3.1</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/3.0/cookbook/aggregate-fields.html">3.0</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.18/cookbook/aggregate-fields.html">2.18</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.17/cookbook/aggregate-fields.html">2.17</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.16/cookbook/aggregate-fields.html">2.16</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.15/cookbook/aggregate-fields.html">2.15</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.14/cookbook/aggregate-fields.html">2.14</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.13/cookbook/aggregate-fields.html">2.13</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.12/cookbook/aggregate-fields.html">2.12</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.11/cookbook/aggregate-fields.html">2.11</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item active" href="/projects/doctrine-orm/en/2.10/cookbook/aggregate-fields.html">2.10</a>
                                                                                                                                                                        </div>
                                </div>
                            
                            

            <div class="section" id="aggregate-fields">
            <h1 class="section-header ">
    <a href="#aggregate-fields">
        Aggregate Fields
        <i class="fas fa-link"></i>
    </a>
</h1>
            <address itemprop="author" itemscope itemtype="http://schema.org/Person">
    <p>Author: <span itemprop="name">{node.value}</span></p>
    <p>Email: <a href="mailto:{node.email}"><span itemprop="email">{node.email}</span></a></p>
</address>
            
    <p>You will often come across the requirement to display aggregate
values of data that can be computed by using the MIN, MAX, COUNT or
SUM SQL functions. For any ORM this is a tricky issue
traditionally. Doctrine ORM offers several ways to get access to
these values and this article will describe all of them from
different perspectives.</p>

            
    <p>You will see that aggregate fields can become very explicit
features in your domain model and how this potentially complex
business rules can be easily tested.</p>

            <div class="section" id="an-example-model">
            <h2 class="section-header ">
    <a href="#an-example-model">
        An example model
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Say you want to model a bank account and all their entries. Entries
into the account can either be of positive or negative money
values. Each account has a credit limit and the account is never
allowed to have a balance below that value.</p>

            
    <p>For simplicity we live in a world where money is composed of
integers only. Also we omit the receiver/sender name, stated reason
for transfer and the execution date. These all would have to be
added on the <code>Entry</code> object.</p>

            
    <p>Our entities look like:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="12985b015a7d81ee5ee72683857df532d340ec07"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="12985b015a7d81ee5ee72683857df532d340ec07"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-1" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-1">1</a></td><td class="code-line" rowspan="75"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Bank</span>\<span class="hljs-title">Entities</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Mapping</span> <span class="hljs-title">as</span> <span class="hljs-title">ORM</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ORM</span>\Entity
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Id
     * <span class="hljs-doctag">@ORM</span>\GeneratedValue
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     */</span>
    <span class="hljs-keyword">private</span> ?int $id;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Column(type="string", unique=true)
     */</span>
    <span class="hljs-keyword">private</span> string $no;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\OneToMany(targetEntity="Entry", mappedBy="account", cascade={"persist"})
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">array</span> $entries;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     */</span>
    <span class="hljs-keyword">private</span> int $maxCredit = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(string $no, int $maxCredit = <span class="hljs-number">0</span>)</span>
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;no = $no;
        <span class="hljs-keyword">$this</span>-&gt;maxCredit = $maxCredit;
        <span class="hljs-keyword">$this</span>-&gt;entries = <span class="hljs-keyword">new</span> \Doctrine\Common\Collections\ArrayCollection();
    }
}

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ORM</span>\Entity
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entry</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Id
     * <span class="hljs-doctag">@ORM</span>\GeneratedValue
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     */</span>
    <span class="hljs-keyword">private</span> ?int $id;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\ManyToOne(targetEntity="Account", inversedBy="entries")
     */</span>
    <span class="hljs-keyword">private</span> Account $account;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     */</span>
    <span class="hljs-keyword">private</span> int $amount;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Account $account, int $amount)</span>
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;account = $account;
        <span class="hljs-keyword">$this</span>-&gt;amount = $amount;
        <span class="hljs-comment">// more stuff here, from/to whom, stated reason, execution date and such</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAmount</span><span class="hljs-params">()</span>: <span class="hljs-title">Amount</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;amount;
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-2" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-3" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-4" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-5" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-6" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-7" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-8" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-9" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-10" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-11" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-12" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-13" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-14" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-15" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-16" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-17" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-18" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-19" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-20" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-21" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-22" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-23" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-24" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-24">24</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-25" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-25">25</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-26" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-26">26</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-27" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-27">27</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-28" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-28">28</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-29" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-29">29</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-30" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-30">30</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-31" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-31">31</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-32" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-32">32</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-33" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-33">33</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-34" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-34">34</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-35" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-35">35</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-36" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-36">36</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-37" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-37">37</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-38" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-38">38</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-39" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-39">39</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-40" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-40">40</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-41" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-41">41</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-42" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-42">42</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-43" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-43">43</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-44" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-44">44</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-45" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-45">45</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-46" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-46">46</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-47" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-47">47</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-48" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-48">48</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-49" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-49">49</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-50" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-50">50</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-51" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-51">51</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-52" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-52">52</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-53" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-53">53</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-54" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-54">54</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-55" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-55">55</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-56" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-56">56</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-57" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-57">57</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-58" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-58">58</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-59" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-59">59</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-60" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-60">60</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-61" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-61">61</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-62" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-62">62</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-63" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-63">63</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-64" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-64">64</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-65" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-65">65</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-66" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-66">66</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-67" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-67">67</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-68" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-68">68</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-69" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-69">69</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-70" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-70">70</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-71" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-71">71</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-72" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-72">72</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-73" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-73">73</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-74" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-74">74</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12985b015a7d81ee5ee72683857df532d340ec07-75" class="line-number-anchor" /><a href="#line-number-12985b015a7d81ee5ee72683857df532d340ec07-75">75</a></td></tr></table></div></code></pre>
    </div>
            <div class="section" id="using-dql">
            <h2 class="section-header ">
    <a href="#using-dql">
        Using DQL
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>The Doctrine Query Language allows you to select for aggregate
values computed from fields of your Domain Model. You can select
the current balance of your account by calling:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="5ea523554c6232f9158da190f880c13c2e6ac45c"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="5ea523554c6232f9158da190f880c13c2e6ac45c"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-1" class="line-number-anchor" /><a href="#line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-1">1</a></td><td class="code-line" rowspan="6"><span class="hljs-meta">&lt;?php</span>
$dql = <span class="hljs-string">"SELECT SUM(e.amount) AS balance FROM Bank\Entities\Entry e "</span> .
       <span class="hljs-string">"WHERE e.account = ?1"</span>;
$balance = $em-&gt;createQuery($dql)
              -&gt;setParameter(<span class="hljs-number">1</span>, $myAccountId)
              -&gt;getSingleScalarResult();</td></tr>
<tr><td class="line-number noselect"><a name="line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-2" class="line-number-anchor" /><a href="#line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-3" class="line-number-anchor" /><a href="#line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-4" class="line-number-anchor" /><a href="#line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-5" class="line-number-anchor" /><a href="#line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-6" class="line-number-anchor" /><a href="#line-number-5ea523554c6232f9158da190f880c13c2e6ac45c-6">6</a></td></tr></table></div></code></pre>
            
    <p>The <code>$em</code> variable in this (and forthcoming) example holds the
Doctrine <code>EntityManager</code>. We create a query for the SUM of all
amounts (negative amounts are withdraws) and retrieve them as a
single scalar result, essentially return only the first column of
the first row.</p>

            
    <p>This approach is simple and powerful, however it has a serious
drawback. We have to execute a specific query for the balance
whenever we need it.</p>

            
    <p>To implement a powerful domain model we would rather have access to
the balance from our <code>Account</code> entity during all times (even if
the Account was not persisted in the database before!).</p>

            
    <p>Also an additional requirement is the max credit per <code>Account</code>
rule.</p>

            
    <p>We cannot reliably enforce this rule in our <code>Account</code> entity with
the DQL retrieval of the balance. There are many different ways to
retrieve accounts. We cannot guarantee that we can execute the
aggregation query for all these use-cases, let alone that a
userland programmer checks this balance against newly added
entries.</p>

    </div>
            <div class="section" id="using-your-domain-model">
            <h2 class="section-header ">
    <a href="#using-your-domain-model">
        Using your Domain Model
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p><code>Account</code> and all the <code>Entry</code> instances are connected through a
collection, which means we can compute this value at runtime:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="48df8a4e387f851d6155bbc0cb38d5f26de4a078"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="48df8a4e387f851d6155bbc0cb38d5f26de4a078"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-1" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-1">1</a></td><td class="code-line" rowspan="15"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>
</span>{
    <span class="hljs-comment">// .. previous code</span>

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBalance</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span>
    </span>{
        $balance = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;entries <span class="hljs-keyword">as</span> $entry) {
            $balance += $entry-&gt;getAmount();
        }

        <span class="hljs-keyword">return</span> $balance;
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-2" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-3" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-4" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-5" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-6" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-7" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-8" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-9" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-10" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-11" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-12" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-13" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-14" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-15" class="line-number-anchor" /><a href="#line-number-48df8a4e387f851d6155bbc0cb38d5f26de4a078-15">15</a></td></tr></table></div></code></pre>
            
    <p>Now we can always call <code>Account::getBalance()</code> to access the
current account balance.</p>

            
    <p>To enforce the max credit rule we have to implement the &quot;Aggregate
Root&quot; pattern as described in Eric Evans book on Domain Driven
Design. Described with one sentence, an aggregate root controls the
instance creation, access and manipulation of its children.</p>

            
    <p>In our case we want to enforce that new entries can only added to
the <code>Account</code> by using a designated method. The <code>Account</code> is
the aggregate root of this relation. We can also enforce the
correctness of the bi-directional <code>Account</code> &lt;-&gt; <code>Entry</code>
relation with this method:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="2162d5533b36126676ef3cfb345dc3694c61a749"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="2162d5533b36126676ef3cfb345dc3694c61a749"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-1" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-1">1</a></td><td class="code-line" rowspan="11"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addEntry</span><span class="hljs-params">(int $amount)</span>: <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;assertAcceptEntryAllowed($amount);

        $e = <span class="hljs-keyword">new</span> Entry(<span class="hljs-keyword">$this</span>, $amount);
        <span class="hljs-keyword">$this</span>-&gt;entries[] = $e;
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-2" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-3" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-4" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-5" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-6" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-7" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-8" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-9" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-10" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2162d5533b36126676ef3cfb345dc3694c61a749-11" class="line-number-anchor" /><a href="#line-number-2162d5533b36126676ef3cfb345dc3694c61a749-11">11</a></td></tr></table></div></code></pre>
            
    <p>Now look at the following test-code for our entities:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-1" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-1">1</a></td><td class="code-line" rowspan="26"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testAddEntry</span><span class="hljs-params">()</span>
    </span>{
        $account = <span class="hljs-keyword">new</span> Account(<span class="hljs-string">"123456"</span>, $maxCredit = <span class="hljs-number">200</span>);
        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">0</span>, $account-&gt;getBalance());

        $account-&gt;addEntry(<span class="hljs-number">500</span>);
        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">500</span>, $account-&gt;getBalance());

        $account-&gt;addEntry(<span class="hljs-number">-700</span>);
        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">-200</span>, $account-&gt;getBalance());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testExceedMaxLimit</span><span class="hljs-params">()</span>
    </span>{
        $account = <span class="hljs-keyword">new</span> Account(<span class="hljs-string">"123456"</span>, $maxCredit = <span class="hljs-number">200</span>);

        <span class="hljs-keyword">$this</span>-&gt;expectException(<span class="hljs-keyword">Exception</span>::class);
        $account-&gt;addEntry(<span class="hljs-number">-1000</span>);
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-2" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-3" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-4" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-5" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-6" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-7" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-8" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-9" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-10" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-11" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-12" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-13" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-14" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-15" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-16" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-17" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-18" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-19" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-20" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-21" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-22" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-23" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-24" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-24">24</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-25" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-25">25</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-26" class="line-number-anchor" /><a href="#line-number-f5fa3d7e0ab703147cc5a8bd441b2d0a76e73424-26">26</a></td></tr></table></div></code></pre>
            
    <p>To enforce our rule we can now implement the assertion in
<code>Account::addEntry</code>:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-1" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-1">1</a></td><td class="code-line" rowspan="15"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>
</span>{
    <span class="hljs-comment">// .. previous code</span>

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assertAcceptEntryAllowed</span><span class="hljs-params">(int $amount)</span>: <span class="hljs-title">void</span>
    </span>{
        $futureBalance = <span class="hljs-keyword">$this</span>-&gt;getBalance() + $amount;
        $allowedMinimalBalance = (<span class="hljs-keyword">$this</span>-&gt;maxCredit * <span class="hljs-number">-1</span>);
        <span class="hljs-keyword">if</span> ($futureBalance &lt; $allowedMinimalBalance) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-string">"Credit Limit exceeded, entry is not allowed!"</span>);
        }
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-2" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-3" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-4" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-5" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-6" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-7" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-8" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-9" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-10" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-11" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-12" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-13" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-14" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-15" class="line-number-anchor" /><a href="#line-number-eb25c09d48f2fe871c0d69d4f03c5aaae09d2a94-15">15</a></td></tr></table></div></code></pre>
            
    <p>We haven&#039;t talked to the entity manager for persistence of our
account example before. You can call
<code>EntityManager::persist($account)</code> and then
<code>EntityManager::flush()</code> at any point to save the account to the
database. All the nested <code>Entry</code> objects are automatically
flushed to the database also.</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="6b0aeb20fe3543a586875bb492881ffb5b841fc9"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="6b0aeb20fe3543a586875bb492881ffb5b841fc9"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-1" class="line-number-anchor" /><a href="#line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-1">1</a></td><td class="code-line" rowspan="6"><span class="hljs-meta">&lt;?php</span>
$account = <span class="hljs-keyword">new</span> Account(<span class="hljs-string">"123456"</span>, <span class="hljs-number">200</span>);
$account-&gt;addEntry(<span class="hljs-number">500</span>);
$account-&gt;addEntry(<span class="hljs-number">-200</span>);
$em-&gt;persist($account);
$em-&gt;flush();</td></tr>
<tr><td class="line-number noselect"><a name="line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-2" class="line-number-anchor" /><a href="#line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-3" class="line-number-anchor" /><a href="#line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-4" class="line-number-anchor" /><a href="#line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-5" class="line-number-anchor" /><a href="#line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-6" class="line-number-anchor" /><a href="#line-number-6b0aeb20fe3543a586875bb492881ffb5b841fc9-6">6</a></td></tr></table></div></code></pre>
            
    <p>The current implementation has a considerable drawback. To get the
balance, we have to initialize the complete <code>Account::$entries</code>
collection, possibly a very large one. This can considerably hurt
the performance of your application.</p>

    </div>
            <div class="section" id="using-an-aggregate-field">
            <h2 class="section-header ">
    <a href="#using-an-aggregate-field">
        Using an Aggregate Field
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>To overcome the previously mentioned issue (initializing the whole
entries collection) we want to add an aggregate field called
&quot;balance&quot; on the Account and adjust the code in
<code>Account::getBalance()</code> and <code>Account:addEntry()</code>:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="d5d2e11e5a9d29078b623b6155f08973edd20cf9"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="d5d2e11e5a9d29078b623b6155f08973edd20cf9"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-1" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-1">1</a></td><td class="code-line" rowspan="22"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     */</span>
    <span class="hljs-keyword">private</span> int $balance = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBalance</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;balance;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addEntry</span><span class="hljs-params">(int $amount)</span>: <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;assertAcceptEntryAllowed($amount);

        $e = <span class="hljs-keyword">new</span> Entry(<span class="hljs-keyword">$this</span>, $amount);
        <span class="hljs-keyword">$this</span>-&gt;entries[] = $e;
        <span class="hljs-keyword">$this</span>-&gt;balance += $amount;
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-2" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-3" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-4" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-5" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-6" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-7" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-8" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-9" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-10" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-11" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-12" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-13" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-14" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-15" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-16" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-17" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-18" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-19" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-20" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-21" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-22" class="line-number-anchor" /><a href="#line-number-d5d2e11e5a9d29078b623b6155f08973edd20cf9-22">22</a></td></tr></table></div></code></pre>
            
    <p>This is a very simple change, but all the tests still pass. Our
account entities return the correct balance. Now calling the
<code>Account::getBalance()</code> method will not occur the overhead of
loading all entries anymore. Adding a new Entry to the
<code>Account::$entities</code> will also not initialize the collection
internally.</p>

            
    <p>Adding a new entry is therefore very performant and explicitly
hooked into the domain model. It will only update the account with
the current balance and insert the new entry into the database.</p>

    </div>
            <div class="section" id="tackling-race-conditions-with-aggregate-fields">
            <h2 class="section-header ">
    <a href="#tackling-race-conditions-with-aggregate-fields">
        Tackling Race Conditions with Aggregate Fields
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Whenever you denormalize your database schema race-conditions can
potentially lead to inconsistent state. See this example:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="12a72806fd5df0362a87c4fa0063c3418ce8a8e5"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="12a72806fd5df0362a87c4fa0063c3418ce8a8e5"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-1" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-1">1</a></td><td class="code-line" rowspan="15"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">Bank</span>\<span class="hljs-title">Entities</span>\<span class="hljs-title">Account</span>;

<span class="hljs-comment">// The Account $accId has a balance of 0 and a max credit limit of 200:</span>
<span class="hljs-comment">// request 1 account</span>
$account1 = $em-&gt;find(Account::class, $accId);

<span class="hljs-comment">// request 2 account</span>
$account2 = $em-&gt;find(Account::class, $accId);

$account1-&gt;addEntry(<span class="hljs-number">-200</span>);
$account2-&gt;addEntry(<span class="hljs-number">-200</span>);

<span class="hljs-comment">// now request 1 and 2 both flush the changes.</span></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-2" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-3" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-4" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-5" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-6" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-7" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-8" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-9" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-10" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-11" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-12" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-13" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-14" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-15" class="line-number-anchor" /><a href="#line-number-12a72806fd5df0362a87c4fa0063c3418ce8a8e5-15">15</a></td></tr></table></div></code></pre>
            
    <p>The aggregate field <code>Account::$balance</code> is now -200, however the
SUM over all entries amounts yields -400. A violation of our max
credit rule.</p>

            
    <p>You can use both optimistic or pessimistic locking to safe-guard
your aggregate fields against this kind of race-conditions. Reading
Eric Evans DDD carefully he mentions that the &quot;Aggregate Root&quot;
(Account in our example) needs a locking mechanism.</p>

            
    <p>Optimistic locking is as easy as adding a version column:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="139a75dd353653e0282d8e1743dafe6a2b5f2cec"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="139a75dd353653e0282d8e1743dafe6a2b5f2cec"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-1" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-1">1</a></td><td class="code-line" rowspan="10"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@ORM</span>\Column(type="integer")
     * <span class="hljs-doctag">@ORM</span>\Version
     */</span>
    <span class="hljs-keyword">private</span> int $version;
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-2" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-3" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-4" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-5" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-6" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-7" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-8" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-9" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-10" class="line-number-anchor" /><a href="#line-number-139a75dd353653e0282d8e1743dafe6a2b5f2cec-10">10</a></td></tr></table></div></code></pre>
            
    <p>The previous example would then throw an exception in the face of
whatever request saves the entity last (and would create the
inconsistent state).</p>

            
    <p>Pessimistic locking requires an additional flag set on the
<code>EntityManager::find()</code> call, enabling write locking directly in
the database using a FOR UPDATE.</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="21106d7791e56b5502290127568b63b1706af3d3"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="21106d7791e56b5502290127568b63b1706af3d3"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-21106d7791e56b5502290127568b63b1706af3d3-1" class="line-number-anchor" /><a href="#line-number-21106d7791e56b5502290127568b63b1706af3d3-1">1</a></td><td class="code-line" rowspan="6"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">Bank</span>\<span class="hljs-title">Entities</span>\<span class="hljs-title">Account</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">DBAL</span>\<span class="hljs-title">LockMode</span>;

$account = $em-&gt;find(Account::class, $accId, LockMode::PESSIMISTIC_READ);</td></tr>
<tr><td class="line-number noselect"><a name="line-number-21106d7791e56b5502290127568b63b1706af3d3-2" class="line-number-anchor" /><a href="#line-number-21106d7791e56b5502290127568b63b1706af3d3-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-21106d7791e56b5502290127568b63b1706af3d3-3" class="line-number-anchor" /><a href="#line-number-21106d7791e56b5502290127568b63b1706af3d3-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-21106d7791e56b5502290127568b63b1706af3d3-4" class="line-number-anchor" /><a href="#line-number-21106d7791e56b5502290127568b63b1706af3d3-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-21106d7791e56b5502290127568b63b1706af3d3-5" class="line-number-anchor" /><a href="#line-number-21106d7791e56b5502290127568b63b1706af3d3-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-21106d7791e56b5502290127568b63b1706af3d3-6" class="line-number-anchor" /><a href="#line-number-21106d7791e56b5502290127568b63b1706af3d3-6">6</a></td></tr></table></div></code></pre>
    </div>
            <div class="section" id="keeping-updates-and-deletes-in-sync">
            <h2 class="section-header ">
    <a href="#keeping-updates-and-deletes-in-sync">
        Keeping Updates and Deletes in Sync
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>The example shown in this article does not allow changes to the
value in <code>Entry</code>, which considerably simplifies the effort to
keep <code>Account::$balance</code> in sync. If your use-case allows fields
to be updated or related entities to be removed you have to
encapsulate this logic in your &quot;Aggregate Root&quot; entity and adjust
the aggregate field accordingly.</p>

    </div>
            <div class="section" id="conclusion">
            <h2 class="section-header ">
    <a href="#conclusion">
        Conclusion
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>This article described how to obtain aggregate values using DQL or
your domain model. It showed how you can easily add an aggregate
field that offers serious performance benefits over iterating all
the related objects that make up an aggregate value. Finally I
showed how you can ensure that your aggregate fields do not get out
of sync due to race-conditions and concurrent access.</p>

    </div>
    </div>
        

                                                </div>
                </div>
            </main>
        </div>
    </div>

        <button id="back-to-top" title="Go to top">Top</button>

                
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://staging.doctrine-project.org/frontend/js/bundle.js?ff3b61"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = 'orm';
            var versionSlug = '2.10';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search ORM 2.10'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
        
            </body>
</html>
