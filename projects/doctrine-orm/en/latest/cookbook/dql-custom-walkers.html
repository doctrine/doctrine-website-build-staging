<!DOCTYPE html>
<html>
    <head>
        <title>        Extending DQL in Doctrine ORM: Custom AST Walkers - Doctrine Object Relational Mapper (ORM)
    </title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="Doctrine Object Relational Mapper Documentation: Extending DQL in Doctrine ORM: Custom AST Walkers ">

        <meta name="keywords" content="                    orm,database,documentation,extending,dql,in,doctrine,orm:,custom,ast,walkers
    ">

                    <meta name="robots" content="noindex">
        
        
                    <link rel="canonical" href="https://staging.doctrine-project.org/projects/doctrine-orm/en/3.2/cookbook/dql-custom-walkers.html" />
    
        <link
            rel="stylesheet"
            type="text/css"
            href="https://staging.doctrine-project.org/frontend/css/index.css?30e146"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://staging.doctrine-project.org/projects/doctrine-orm/en/latest/cookbook/dql-custom-walkers.html" />
        <meta property="og:title" content="        Extending DQL in Doctrine ORM: Custom AST Walkers - Doctrine Object Relational Mapper (ORM)
    " />
        <meta property="og:description" content="Doctrine Object Relational Mapper Documentation: Extending DQL in Doctrine ORM: Custom AST Walkers " />
        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Doctrine Object Relational Mapper",
            "description": "Extending DQL in Doctrine ORM: Custom AST Walkers",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://staging.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://staging.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item" href="/projects/rst-parser.html">RST Parser</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/sponsorship.html">Sponsorship</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/orm/edit/4.0.x/docs/en/cookbook/dql-custom-walkers.rst" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>
                </div>
                <div class="nav-outbound">
                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <div class="container-wrapper container">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>

                        

            <div class="toc-section">
<h2 class="toc-header">Tutorials</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="../tutorials/getting-started.html#getting-started-with-doctrine">Getting Started with Doctrine</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/getting-started-database.html#getting-started-database-first">Getting Started: Database First</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/getting-started-models.html#getting-started-model-first">Getting Started: Model First</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/working-with-indexed-associations.html#working-with-indexed-associations">Working with Indexed Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/extra-lazy-associations.html#extra-lazy-associations">Extra Lazy Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/composite-primary-keys.html#composite-and-foreign-keys-as-primary-key">Composite and Foreign Keys as Primary Key</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/ordered-associations.html#ordering-to-many-associations">Ordering To-Many Associations</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/override-field-association-mappings-in-subclasses.html#override-field-association-mappings-in-subclasses">Override Field Association Mappings In Subclasses</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/pagination.html#pagination">Pagination</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/embeddables.html#separating-concerns-using-embeddables">Separating Concerns using Embeddables</a>


</li>
    </ul>
</div>
</div><div class="toc-section">
<h2 class="toc-header">Reference</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="../reference/architecture.html#architecture">Architecture</a>


</li>
    <li class="toc-item">
    <a href="../reference/configuration.html#installation-and-configuration">Installation and Configuration</a>


</li>
    <li class="toc-item">
    <a href="../reference/faq.html#frequently-asked-questions">Frequently Asked Questions</a>


</li>
    <li class="toc-item">
    <a href="../reference/basic-mapping.html#basic-mapping">Basic Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/association-mapping.html#association-mapping">Association Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/inheritance-mapping.html#inheritance-mapping">Inheritance Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/working-with-objects.html#working-with-objects">Working with Objects</a>


</li>
    <li class="toc-item">
    <a href="../reference/working-with-associations.html#working-with-associations">Working with Associations</a>


</li>
    <li class="toc-item">
    <a href="../reference/typedfieldmapper.html#implementing-a-typedfieldmapper">Implementing a TypedFieldMapper</a>


</li>
    <li class="toc-item">
    <a href="../reference/events.html#events">Events</a>


</li>
    <li class="toc-item">
    <a href="../reference/unitofwork.html#doctrine-internals-explained">Doctrine Internals explained</a>


</li>
    <li class="toc-item">
    <a href="../reference/unitofwork-associations.html#association-updates-owning-side-and-inverse-side">Association Updates: Owning Side and Inverse Side</a>


</li>
    <li class="toc-item">
    <a href="../reference/transactions-and-concurrency.html#transactions-and-concurrency">Transactions and Concurrency</a>


</li>
    <li class="toc-item">
    <a href="../reference/batch-processing.html#batch-processing">Batch Processing</a>


</li>
    <li class="toc-item">
    <a href="../reference/dql-doctrine-query-language.html#doctrine-query-language">Doctrine Query Language</a>


</li>
    <li class="toc-item">
    <a href="../reference/query-builder.html#the-querybuilder">The QueryBuilder</a>


</li>
    <li class="toc-item">
    <a href="../reference/native-sql.html#native-sql">Native SQL</a>


</li>
    <li class="toc-item">
    <a href="../reference/change-tracking-policies.html#change-tracking-policies">Change Tracking Policies</a>


</li>
    <li class="toc-item">
    <a href="../reference/attributes-reference.html#attributes-reference">Attributes Reference</a>


</li>
    <li class="toc-item">
    <a href="../reference/xml-mapping.html#xml-mapping">XML Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/php-mapping.html#php-mapping">PHP Mapping</a>


</li>
    <li class="toc-item">
    <a href="../reference/caching.html#caching">Caching</a>


</li>
    <li class="toc-item">
    <a href="../reference/improving-performance.html#improving-performance">Improving Performance</a>


</li>
    <li class="toc-item">
    <a href="../reference/tools.html#tools">Tools</a>


</li>
    <li class="toc-item">
    <a href="../reference/metadata-drivers.html#metadata-drivers">Metadata Drivers</a>


</li>
    <li class="toc-item">
    <a href="../reference/best-practices.html#best-practices">Best Practices</a>


</li>
    <li class="toc-item">
    <a href="../reference/limitations-and-known-issues.html#limitations-and-known-issues">Limitations and Known Issues</a>


</li>
    <li class="toc-item">
    <a href="../tutorials/pagination.html#pagination">Pagination</a>


</li>
    <li class="toc-item">
    <a href="../reference/filters.html#filters">Filters</a>


</li>
    <li class="toc-item">
    <a href="../reference/namingstrategy.html#implementing-a-namingstrategy">Implementing a NamingStrategy</a>


</li>
    <li class="toc-item">
    <a href="../reference/advanced-configuration.html#advanced-configuration">Advanced Configuration</a>


</li>
    <li class="toc-item">
    <a href="../reference/second-level-cache.html#the-second-level-cache">The Second Level Cache</a>


</li>
    <li class="toc-item">
    <a href="../reference/security.html#security">Security</a>


</li>
    </ul>
</div>
</div><div class="toc-section">
<h2 class="toc-header">Cookbook</h2><div class="toc">
    <ul class="menu-level">
    <li class="toc-item">
    <a href="aggregate-fields.html#aggregate-fields">Aggregate Fields</a>


</li>
    <li class="toc-item">
    <a href="custom-mapping-types.html#custom-mapping-types">Custom Mapping Types</a>


</li>
    <li class="toc-item">
    <a href="decorator-pattern.html#persisting-the-decorator-pattern">Persisting the Decorator Pattern</a>


</li>
    <li class="toc-item opened">
    <a href="#extending-dql-in-doctrine-orm-custom-ast-walkers">Extending DQL in Doctrine ORM: Custom AST Walkers</a>


</li>
    <li class="toc-item">
    <a href="dql-user-defined-functions.html#dql-user-defined-functions">DQL User Defined Functions</a>


</li>
    <li class="toc-item">
    <a href="implementing-arrayaccess-for-domain-objects.html#implementing-arrayaccess-for-domain-objects">Implementing ArrayAccess for Domain Objects</a>


</li>
    <li class="toc-item">
    <a href="resolve-target-entity-listener.html#keeping-your-modules-independent">Keeping your Modules independent</a>


</li>
    <li class="toc-item">
    <a href="sql-table-prefixes.html#sql-table-prefixes">SQL-Table Prefixes</a>


</li>
    <li class="toc-item">
    <a href="strategy-cookbook-introduction.html#strategy-pattern">Strategy-Pattern</a>


</li>
    <li class="toc-item">
    <a href="validation-of-entities.html#validation-of-entities">Validation of Entities</a>


</li>
    <li class="toc-item">
    <a href="working-with-datetime.html#working-with-datetime-instances">Working with DateTime Instances</a>


</li>
    <li class="toc-item">
    <a href="mysql-enums.html#mysql-enums">Mysql Enums</a>


</li>
    <li class="toc-item">
    <a href="advanced-field-value-conversion-using-custom-mapping-types.html#advanced-field-value-conversion-using-custom-mapping-types">Advanced field value conversion using custom mapping types</a>


</li>
    <li class="toc-item">
    <a href="entities-in-session.html#entities-in-the-session">Entities in the Session</a>


</li>
    </ul>
</div>
</div>
    

                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
                {
            "@type": "ListItem",
            "position": 1,
            "name": "Projects",
            "item": "https://staging.doctrine-project.org/projects.html"
        },                {
            "@type": "ListItem",
            "position": 2,
            "name": "ORM",
            "item": "https://staging.doctrine-project.org/projects/orm.html"
        },                {
            "@type": "ListItem",
            "position": 3,
            "name": "Documentation",
            "item": "https://staging.doctrine-project.org/projects/doctrine-orm/en/latest/index.html"
        },                {
            "@type": "ListItem",
            "position": 4,
            "name": "Extending DQL in Doctrine ORM: Custom AST Walkers",
            "item": "https://staging.doctrine-project.org/projects/doctrine-orm/en/latest/cookbook/dql-custom-walkers.html"
        }            ]
}
</script>

<nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
    <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects.html">Projects</a></li>
                                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/orm.html">ORM</a></li>
                                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine-orm/en/latest/index.html">Documentation</a></li>
                                                <li class="breadcrumb-item active" aria-current="page">Extending DQL in Doctrine ORM: Custom AST Walkers</li>
                        </ol>
</nav>
                                    </div>

                    
    <div class="alert caution bg-light-yellow text-dark border">
    <table width="100%">
        <tr>
            <td width="10" class="align-top">
                <i class="fas fa-exclamation-circle text-warning mr-2"></i>
            </td>
            <td><p>You are browsing a version that has not yet been released.</p></td>
        </tr>
    </table>
</div>

                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            
                                <div class="dropdown show d-inline-block">
                                    <a class="project-version-switcher btn btn-secondary btn-sm dropdown-toggle" href="/projects/doctrine-orm/en/latest/cookbook/dql-custom-walkers.html" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        4.0
                                    </a>

                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                                                    <h6 class="dropdown-header">Maintained</h6>

                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item active" href="/projects/doctrine-orm/en/latest/cookbook/dql-custom-walkers.html">
                                                        4.0

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/3.3/cookbook/dql-custom-walkers.html">
                                                        3.3

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/3.2/cookbook/dql-custom-walkers.html">
                                                        3.2.2

                                                                                                                    (current)
                                                        
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.20/cookbook/dql-custom-walkers.html">
                                                        2.20

                                                        
                                                                                                                    (upcoming)
                                                                                                            </a>
                                                                                                                                                                                                
                                                    <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.19/cookbook/dql-custom-walkers.html">
                                                        2.19.7

                                                        
                                                                                                            </a>
                                                                                                                                    
                                                                                    <h6 class="dropdown-header">Unmaintained</h6>

                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/3.1/cookbook/dql-custom-walkers.html">3.1</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/3.0/cookbook/dql-custom-walkers.html">3.0</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.18/cookbook/dql-custom-walkers.html">2.18</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.17/cookbook/dql-custom-walkers.html">2.17</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.16/cookbook/dql-custom-walkers.html">2.16</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.15/cookbook/dql-custom-walkers.html">2.15</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.14/cookbook/dql-custom-walkers.html">2.14</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.13/cookbook/dql-custom-walkers.html">2.13</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.12/cookbook/dql-custom-walkers.html">2.12</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.11/cookbook/dql-custom-walkers.html">2.11</a>
                                                                                                                                                                                                
                                                    <a class="dropdown-item" href="/projects/doctrine-orm/en/2.10/cookbook/dql-custom-walkers.html">2.10</a>
                                                                                                                                                                        </div>
                                </div>
                            
                            

            <div class="section" id="extending-dql-in-doctrine-orm-custom-ast-walkers">
            <h1 class="section-header ">
    <a href="#extending-dql-in-doctrine-orm-custom-ast-walkers">
        Extending DQL in Doctrine ORM: Custom AST Walkers
        <i class="fas fa-link"></i>
    </a>
</h1>
            <div class="alert section-author bg-light text-dark border"><p class="author font-weight-bold">
        <i class="fas fa-pencil-alt"></i> Written by <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a></p>
</div>
            
    <p>The Doctrine Query Language &lt;DQL&gt; is a proprietary sql-dialect that
substitutes tables and columns for Entity names and their fields.
Using DQL you write a query against the database using your
entities. With the help of the metadata you can write very concise,
compact and powerful queries that are then translated into SQL by
the Doctrine ORM.</p>

            
    <p>In Doctrine 1 the DQL language was not implemented using a real
parser. This made modifications of the DQL by the user impossible.
Doctrine ORM in contrast has a real parser for the DQL language,
which transforms the DQL statement into an
<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a>
and generates the appropriate SQL statement for it. Since this
process is deterministic Doctrine heavily caches the SQL that is
generated from any given DQL query, which reduces the performance
overhead of the parsing process to zero.</p>

            
    <p>You can modify the Abstract syntax tree by hooking into DQL parsing
process by adding a Custom Tree Walker. A walker is an interface
that walks each node of the Abstract syntax tree, thereby
generating the SQL statement.</p>

            
    <p>There are two types of custom tree walkers that you can hook into
the DQL parser:</p>

            

<ul>
    <li class="dash">An output walker. This one actually generates the SQL, and there
is only ever one of them. We implemented the default SqlWalker
implementation for it.</li>
    <li class="dash">A tree walker. There can be many tree walkers, they cannot
generate the SQL, however they can modify the AST before its
rendered to SQL.</li>
</ul>

            
    <p>Now this is all awfully technical, so let me come to some use-cases
fast to keep you motivated. Using walker implementation you can for
example:</p>

            

<ul>
    <li class="dash">Modify the AST to generate a Count Query to be used with a
paginator for any given DQL query.</li>
    <li class="dash">Modify the Output Walker to generate vendor-specific SQL
(instead of ANSI).</li>
    <li class="dash">Modify the AST to add additional where clauses for specific
entities (example ACL, country-specific content...)</li>
    <li class="dash">Modify the Output walker to pretty print the SQL for debugging
purposes.</li>
</ul>

            
    <p>In this cookbook-entry I will show examples of the first two
points. There are probably much more use-cases.</p>

            <div class="section" id="generic-count-query-for-pagination">
            <h2 class="section-header ">
    <a href="#generic-count-query-for-pagination">
        Generic count query for pagination
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Say you have a blog and posts all with one category and one author.
A query for the front-page or any archive page might look something
like:</p>

            <pre class="code-block-table"><code class="sql"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="b4eef1427006f070d28b818d038616af75804f2e"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="b4eef1427006f070d28b818d038616af75804f2e"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-b4eef1427006f070d28b818d038616af75804f2e-1" class="line-number-anchor" /><a href="#line-number-b4eef1427006f070d28b818d038616af75804f2e-1">1</a></td><td class="code-line" rowspan="1"><span class="hljs-keyword">SELECT</span> p, c, a <span class="hljs-keyword">FROM</span> BlogPost p <span class="hljs-keyword">JOIN</span> p.category c <span class="hljs-keyword">JOIN</span> p.author a <span class="hljs-keyword">WHERE</span> ...</td></tr></table></div></code></pre>
            
    <p>Now in this query the blog post is the root entity, meaning it&#039;s the
one that is hydrated directly from the query and returned as an
array of blog posts. In contrast the comment and author are loaded
for deeper use in the object tree.</p>

            
    <p>A pagination for this query would want to approximate the number of
posts that match the WHERE clause of this query to be able to
predict the number of pages to show to the user. A draft of the DQL
query for pagination would look like:</p>

            <pre class="code-block-table"><code class="sql"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="13dab06ad31e3f6cfe86508fb865bcfbf06094fc"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="13dab06ad31e3f6cfe86508fb865bcfbf06094fc"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-13dab06ad31e3f6cfe86508fb865bcfbf06094fc-1" class="line-number-anchor" /><a href="#line-number-13dab06ad31e3f6cfe86508fb865bcfbf06094fc-1">1</a></td><td class="code-line" rowspan="1"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-keyword">DISTINCT</span> p.id) <span class="hljs-keyword">FROM</span> BlogPost p <span class="hljs-keyword">JOIN</span> p.category c <span class="hljs-keyword">JOIN</span> p.author a <span class="hljs-keyword">WHERE</span> ...</td></tr></table></div></code></pre>
            
    <p>Now you could go and write each of these queries by hand, or you
can use a tree walker to modify the AST for you. Let&#039;s see how the
API would look for this use-case:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="cff41885f44983687ea2b6255edc0d131a34a834"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="cff41885f44983687ea2b6255edc0d131a34a834"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-1" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-1">1</a></td><td class="code-line" rowspan="7"><span class="hljs-meta">&lt;?php</span>
$pageNum = <span class="hljs-number">1</span>;
$query = $em-&gt;createQuery($dql);
$query-&gt;setFirstResult( ($pageNum<span class="hljs-number">-1</span>) * <span class="hljs-number">20</span>)-&gt;setMaxResults(<span class="hljs-number">20</span>);

$totalResults = Paginate::count($query);
$results = $query-&gt;getResult();</td></tr>
<tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-2" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-3" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-4" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-5" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-6" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-cff41885f44983687ea2b6255edc0d131a34a834-7" class="line-number-anchor" /><a href="#line-number-cff41885f44983687ea2b6255edc0d131a34a834-7">7</a></td></tr></table></div></code></pre>
            
    <p>The <code>Paginate::count(Query $query)</code> looks like:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="3c35192a17b40d2f599c7a9d4f9726ecb626286b"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="3c35192a17b40d2f599c7a9d4f9726ecb626286b"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-1" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-1">1</a></td><td class="code-line" rowspan="14"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Paginate</span>
</span>{
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">count</span><span class="hljs-params">(Query $query)</span>
    </span>{
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> Query $countQuery */</span>
        $countQuery = <span class="hljs-keyword">clone</span> $query;

        $countQuery-&gt;setHint(Query::HINT_CUSTOM_TREE_WALKERS, <span class="hljs-keyword">array</span>(<span class="hljs-string">'DoctrineExtensions\Paginate\CountSqlWalker'</span>));
        $countQuery-&gt;setFirstResult(<span class="hljs-keyword">null</span>)-&gt;setMaxResults(<span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">return</span> $countQuery-&gt;getSingleScalarResult();
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-2" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-3" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-4" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-5" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-6" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-7" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-8" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-9" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-10" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-11" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-12" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-13" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-14" class="line-number-anchor" /><a href="#line-number-3c35192a17b40d2f599c7a9d4f9726ecb626286b-14">14</a></td></tr></table></div></code></pre>
            
    <p>It clones the query, resets the limit clause first and max results
and registers the <code>CountSqlWalker</code> custom tree walker which
will modify the AST to execute a count query. The walkers
implementation is:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="2ff8303224685be4541c408a74ffb6d05f867066"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="2ff8303224685be4541c408a74ffb6d05f867066"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-1" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-1">1</a></td><td class="code-line" rowspan="33"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountSqlWalker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TreeWalkerAdapter</span>
</span>{
    <span class="hljs-comment">/**
     * Walks down a SelectStatement AST node, thereby generating the appropriate SQL.
     *
     * <span class="hljs-doctag">@return</span> string The SQL.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">walkSelectStatement</span><span class="hljs-params">(SelectStatement $AST)</span>
    </span>{
        $parent = <span class="hljs-keyword">null</span>;
        $parentName = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_getQueryComponents() <span class="hljs-keyword">as</span> $dqlAlias =&gt; $qComp) {
            <span class="hljs-keyword">if</span> ($qComp[<span class="hljs-string">'parent'</span>] === <span class="hljs-keyword">null</span> &amp;&amp; $qComp[<span class="hljs-string">'nestingLevel'</span>] == <span class="hljs-number">0</span>) {
                $parent = $qComp;
                $parentName = $dqlAlias;
                <span class="hljs-keyword">break</span>;
            }
        }

        $pathExpression = <span class="hljs-keyword">new</span> PathExpression(
            PathExpression::TYPE_STATE_FIELD | PathExpression::TYPE_SINGLE_VALUED_ASSOCIATION, $parentName,
            $parent[<span class="hljs-string">'metadata'</span>]-&gt;getSingleIdentifierFieldName()
        );
        $pathExpression-&gt;type = PathExpression::TYPE_STATE_FIELD;

        $AST-&gt;selectClause-&gt;selectExpressions = <span class="hljs-keyword">array</span>(
            <span class="hljs-keyword">new</span> SelectExpression(
                <span class="hljs-keyword">new</span> AggregateExpression(<span class="hljs-string">'count'</span>, $pathExpression, <span class="hljs-keyword">true</span>), <span class="hljs-keyword">null</span>
            )
        );
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-2" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-3" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-4" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-5" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-6" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-7" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-8" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-9" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-10" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-11" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-12" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-13" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-14" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-15" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-16" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-17" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-18" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-19" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-20" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-21" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-22" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-23" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-24" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-24">24</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-25" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-25">25</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-26" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-26">26</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-27" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-27">27</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-28" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-28">28</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-29" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-29">29</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-30" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-30">30</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-31" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-31">31</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-32" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-32">32</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-2ff8303224685be4541c408a74ffb6d05f867066-33" class="line-number-anchor" /><a href="#line-number-2ff8303224685be4541c408a74ffb6d05f867066-33">33</a></td></tr></table></div></code></pre>
            
    <p>This will delete any given select expressions and replace them with
a distinct count query for the root entities primary key. This will
only work if your entity has only one identifier field (composite
keys won&#039;t work).</p>

    </div>
            <div class="section" id="modify-the-output-walker-to-generate-vendor-specific-sql">
            <h2 class="section-header ">
    <a href="#modify-the-output-walker-to-generate-vendor-specific-sql">
        Modify the Output Walker to generate Vendor specific SQL
        <i class="fas fa-link"></i>
    </a>
</h2>
            
    <p>Most RMDBS have vendor-specific features for optimizing select
query execution plans. You can write your own output walker to
introduce certain keywords using the Query Hint API. A query hint
can be set via <code>Query::setHint($name, $value)</code> as shown in the
previous example with the <code>HINT_CUSTOM_TREE_WALKERS</code> query hint.</p>

            
    <p>We will implement a custom Output Walker that allows to specify the
<code>SQL_NO_CACHE</code> query hint.</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="61bde0bef2bd3fdba5420d0864def4fd697b3206"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="61bde0bef2bd3fdba5420d0864def4fd697b3206"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-1" class="line-number-anchor" /><a href="#line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-1">1</a></td><td class="code-line" rowspan="6"><span class="hljs-meta">&lt;?php</span>
$dql = <span class="hljs-string">"SELECT p, c, a FROM BlogPost p JOIN p.category c JOIN p.author a WHERE ..."</span>;
$query = $m-&gt;createQuery($dql);
$query-&gt;setHint(Query::HINT_CUSTOM_OUTPUT_WALKER, <span class="hljs-string">'DoctrineExtensions\Query\MysqlWalker'</span>);
$query-&gt;setHint(<span class="hljs-string">"mysqlWalker.sqlNoCache"</span>, <span class="hljs-keyword">true</span>);
$results = $query-&gt;getResult();</td></tr>
<tr><td class="line-number noselect"><a name="line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-2" class="line-number-anchor" /><a href="#line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-3" class="line-number-anchor" /><a href="#line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-4" class="line-number-anchor" /><a href="#line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-5" class="line-number-anchor" /><a href="#line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-6" class="line-number-anchor" /><a href="#line-number-61bde0bef2bd3fdba5420d0864def4fd697b3206-6">6</a></td></tr></table></div></code></pre>
            
    <p>Our <code>MysqlWalker</code> will extend the default <code>SqlWalker</code>. We will
modify the generation of the SELECT clause, adding the
<code>SQL_NO_CACHE</code> on those queries that need it:</p>

            <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="b61f3703a61b34acf881f9dcd4c765db93215325"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="b61f3703a61b34acf881f9dcd4c765db93215325"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-1" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-1">1</a></td><td class="code-line" rowspan="24"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MysqlWalker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SqlWalker</span>
</span>{
     <span class="hljs-comment">/**
     * Walks down a SelectClause AST node, thereby generating the appropriate SQL.
     *
     * <span class="hljs-doctag">@param</span> $selectClause
     * <span class="hljs-doctag">@return</span> string The SQL.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">walkSelectClause</span><span class="hljs-params">($selectClause)</span>
    </span>{
        $sql = <span class="hljs-keyword">parent</span>::walkSelectClause($selectClause);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;getQuery()-&gt;getHint(<span class="hljs-string">'mysqlWalker.sqlNoCache'</span>) === <span class="hljs-keyword">true</span>) {
            <span class="hljs-keyword">if</span> ($selectClause-&gt;isDistinct) {
                $sql = str_replace(<span class="hljs-string">'SELECT DISTINCT'</span>, <span class="hljs-string">'SELECT DISTINCT SQL_NO_CACHE'</span>, $sql);
            } <span class="hljs-keyword">else</span> {
                $sql = str_replace(<span class="hljs-string">'SELECT'</span>, <span class="hljs-string">'SELECT SQL_NO_CACHE'</span>, $sql);
            }
        }

        <span class="hljs-keyword">return</span> $sql;
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-2" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-3" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-4" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-5" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-6" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-7" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-8" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-9" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-10" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-11" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-12" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-13" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-14" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-15" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-16" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-17" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-18" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-19" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-20" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-21" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-22" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-23" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-b61f3703a61b34acf881f9dcd4c765db93215325-24" class="line-number-anchor" /><a href="#line-number-b61f3703a61b34acf881f9dcd4c765db93215325-24">24</a></td></tr></table></div></code></pre>
            
    <p>Writing extensions to the Output Walker requires a very deep
understanding of the DQL Parser and Walkers, but may offer your
huge benefits with using vendor specific features. This would still
allow you write DQL queries instead of NativeQueries to make use of
vendor specific features.</p>

    </div>
    </div>
        

                                                </div>
                </div>
            </main>
        </div>
    </div>

        <button id="back-to-top" title="Go to top">Top</button>

                
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://staging.doctrine-project.org/frontend/js/bundle.js?ff3b61"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = 'orm';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search ORM 4.0'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                console.log(eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
        
            </body>
</html>
