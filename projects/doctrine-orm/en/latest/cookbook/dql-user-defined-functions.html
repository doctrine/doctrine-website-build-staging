<!DOCTYPE html>
<html>
    <head>
        <title>DQL User Defined Functions - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                                                                
                                
                                                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/">Home</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/">Projects</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/orm/">ORM</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/doctrine-orm/en/latest/">Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">DQL User Defined Functions</li>
                        </ol>
                    </nav>
                
                                    <ul class="list-inline float-right">
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-orm/en/latest/cookbook/dql-user-defined-functions.html" class="badge badge-primary">master</a>
                            </li>
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-orm/en/2.6/cookbook/dql-user-defined-functions.html" class="badge badge-secondary">2.6</a>
                            </li>
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-orm/en/2.5/cookbook/dql-user-defined-functions.html" class="badge badge-secondary">2.5</a>
                            </li>
                                            </ul>
                
                <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>
<h1 class="section-header" id="title.1"><a href="#title.1">DQL User Defined Functions<i class="fas fa-link"></i></a></h1>
<div class="section-author"><p>By default DQL supports a limited subset of all the vendor-specific
SQL functions common between all the vendors. However in many cases
once you have decided on a specific database vendor, you will never
change it during the life of your project. This decision for a
specific vendor potentially allows you to make use of powerful SQL
features that are unique to the vendor.</p></div>
<p>It is worth to mention that Doctrine 2 also allows you to handwrite
your SQL instead of extending the DQL parser. Extending DQL is sort of an
advanced extension point. You can map arbitrary SQL to your objects
and gain access to vendor specific functionalities using the
<code>EntityManager#createNativeQuery()</code> API as described in
the <a href="../reference/native-sql.html">Native Query</a> chapter.</p>
<p>The DQL Parser has hooks to register functions that can then be
used in your DQL queries and transformed into SQL, allowing to
extend Doctrines Query capabilities to the vendors strength. This
post explains the Used-Defined Functions API (UDF) of the Dql
Parser and shows some examples to give you some hints how you would
extend DQL.</p>
<p>There are three types of functions in DQL, those that return a
numerical value, those that return a string and those that return a
Date. Your custom method has to be registered as either one of
those. The return type information is used by the DQL parser to
check possible syntax errors during the parsing process, for
example using a string function return value in a math expression.</p>
<h2 class="section-header" id="title.1.1"><a href="#title.1.1">Registering your own DQL functions<i class="fas fa-link"></i></a></h2>
<p>You can register your functions adding them to the ORM
configuration:</p>
<pre><code class="php">&lt;?php
$config = new \Doctrine\ORM\Configuration();
$config-&gt;addCustomStringFunction($name, $class);
$config-&gt;addCustomNumericFunction($name, $class);
$config-&gt;addCustomDatetimeFunction($name, $class);

$em = EntityManager::create($dbParams, $config);
</code></pre>
<p>The <code>$name</code> is the name the function will be referred to in the
DQL query. <code>$class</code> is a string of a class-name which has to
extend <code>Doctrine\ORM\Query\Node\FunctionNode</code>. This is a class
that offers all the necessary API and methods to implement a UDF.</p>
<p>Instead of providing the function class name, you can also provide
a callable that returns the function object:</p>
<pre><code class="php">&lt;?php
$config = new \Doctrine\ORM\Configuration();
$config-&gt;addCustomStringFunction($name, function () {
    return new MyCustomFunction();
});
</code></pre>
<p>In this post we will implement some MySql specific Date calculation
methods, which are quite handy in my opinion:</p>
<h2 class="section-header" id="title.1.2"><a href="#title.1.2">Date Diff<i class="fas fa-link"></i></a></h2>
<p><a href="https://dev.mysql.com/doc/refman/5.1/en/date-and-time-functions.html#function_datediff">Mysql's DateDiff function</a>
takes two dates as argument and calculates the difference in days
with <code>date1-date2</code>.</p>
<p>The DQL parser is a top-down recursive descent parser to generate
the Abstract-Syntax Tree (AST) and uses a TreeWalker approach to
generate the appropriate SQL from the AST. This makes reading the
Parser/TreeWalker code manageable in a finite amount of time.</p>
<p>The <code>FunctionNode</code> class I referred to earlier requires you to
implement two methods, one for the parsing process (obviously)
called <code>parse</code> and one for the TreeWalker process called
<code>getSql()</code>. I show you the code for the DateDiff method and
discuss it step by step:</p>
<pre><code class="php">&lt;?php
/**
 * DateDiffFunction ::= &quot;DATEDIFF&quot; &quot;(&quot; ArithmeticPrimary &quot;,&quot; ArithmeticPrimary &quot;)&quot;
 */
class DateDiff extends FunctionNode
{
    // (1)
    public $firstDateExpression = null;
    public $secondDateExpression = null;

    public function parse(\Doctrine\ORM\Query\Parser $parser)
    {
        $parser-&gt;match(Lexer::T_IDENTIFIER); // (2)
        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS); // (3)
        $this-&gt;firstDateExpression = $parser-&gt;ArithmeticPrimary(); // (4)
        $parser-&gt;match(Lexer::T_COMMA); // (5)
        $this-&gt;secondDateExpression = $parser-&gt;ArithmeticPrimary(); // (6)
        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS); // (3)
    }

    public function getSql(\Doctrine\ORM\Query\SqlWalker $sqlWalker)
    {
        return 'DATEDIFF(' .
            $this-&gt;firstDateExpression-&gt;dispatch($sqlWalker) . ', ' .
            $this-&gt;secondDateExpression-&gt;dispatch($sqlWalker) .
        ')'; // (7)
    }
}
</code></pre>
<p>The Parsing process of the DATEDIFF function is going to find two
expressions the date1 and the date2 values, whose AST Node
representations will be saved in the variables of the DateDiff
FunctionNode instance at (1).</p>
<p>The parse() method has to cut the function call &quot;DATEDIFF&quot; and its
argument into pieces. Since the parser detects the function using a
lookahead the T\_IDENTIFIER of the function name has to be taken
from the stack (2), followed by a detection of the arguments in
(4)-(6). The opening and closing parenthesis have to be detected
also. This happens during the Parsing process and leads to the
generation of a DateDiff FunctionNode somewhere in the AST of the
dql statement.</p>
<p>The <code>ArithmeticPrimary</code> method call is the most common
denominator of valid EBNF tokens taken from the
<a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/dql-doctrine-query-language.html#ebnf">DQL EBNF grammar</a>
that matches our requirements for valid input into the DateDiff Dql
function. Picking the right tokens for your methods is a tricky
business, but the EBNF grammar is pretty helpful finding it, as is
looking at the Parser source code.</p>
<p>Now in the TreeWalker process we have to pick up this node and
generate SQL from it, which apparently is quite easy looking at the
code in (7). Since we don't know which type of AST Node the first
and second Date expression are we are just dispatching them back to
the SQL Walker to generate SQL from and then wrap our DATEDIFF
function call around this output.</p>
<p>Now registering this DateDiff FunctionNode with the ORM using:</p>
<pre><code class="php">&lt;?php
$config = new \Doctrine\ORM\Configuration();
$config-&gt;addCustomStringFunction('DATEDIFF', 'DoctrineExtensions\Query\MySql\DateDiff');
</code></pre>
<p>We can do fancy stuff like:</p>
<pre><code class="sql">SELECT p FROM DoctrineExtensions\Query\BlogPost p WHERE DATEDIFF(CURRENT_TIME(), p.created) &lt; 7
</code></pre>
<h2 class="section-header" id="title.1.3"><a href="#title.1.3">Date Add<i class="fas fa-link"></i></a></h2>
<p>Often useful it the ability to do some simple date calculations in
your DQL query using
<a href="https://dev.mysql.com/doc/refman/5.1/en/date-and-time-functions.html#function_date-add">MySql's DATE\_ADD function</a>.</p>
<p>I'll skip the blah and show the code for this function:</p>
<pre><code class="php">&lt;?php
/**
 * DateAddFunction ::=
 *     &quot;DATE_ADD&quot; &quot;(&quot; ArithmeticPrimary &quot;, INTERVAL&quot; ArithmeticPrimary Identifier &quot;)&quot;
 */
class DateAdd extends FunctionNode
{
    public $firstDateExpression = null;
    public $intervalExpression = null;
    public $unit = null;

    public function parse(\Doctrine\ORM\Query\Parser $parser)
    {
        $parser-&gt;match(Lexer::T_IDENTIFIER);
        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);

        $this-&gt;firstDateExpression = $parser-&gt;ArithmeticPrimary();

        $parser-&gt;match(Lexer::T_COMMA);
        $parser-&gt;match(Lexer::T_IDENTIFIER);

        $this-&gt;intervalExpression = $parser-&gt;ArithmeticPrimary();

        $parser-&gt;match(Lexer::T_IDENTIFIER);

        /** @var Lexer $lexer */
        $lexer = $parser-&gt;getLexer();
        $this-&gt;unit = $lexer-&gt;token['value'];

        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);
    }

    public function getSql(\Doctrine\ORM\Query\SqlWalker $sqlWalker)
    {
        return 'DATE_ADD(' .
            $this-&gt;firstDateExpression-&gt;dispatch($sqlWalker) . ', INTERVAL ' .
            $this-&gt;intervalExpression-&gt;dispatch($sqlWalker) . ' ' . $this-&gt;unit .
        ')';
    }
}
</code></pre>
<p>The only difference compared to the DATEDIFF here is, we
additionally need the <code>Lexer</code> to access the value of the
<code>T_IDENTIFIER</code> token for the Date Interval unit, for example the
MONTH in:</p>
<pre><code class="sql">SELECT p FROM DoctrineExtensions\Query\BlogPost p WHERE DATE_ADD(CURRENT_TIME(), INTERVAL 4 MONTH) &gt; p.created
</code></pre>
<p>The above method now only supports the specification using
<code>INTERVAL</code>, to also allow a real date in DATE\_ADD we need to add
some decision logic to the parsing process (makes up for a nice
exercise).</p>
<p>Now as you see, the Parsing process doesn't catch all the possible
SQL errors, here we don't match for all the valid inputs for the
interval unit. However where necessary we rely on the database
vendors SQL parser to show us further errors in the parsing
process, for example if the Unit would not be one of the supported
values by MySql.</p>
<h2 class="section-header" id="title.1.4"><a href="#title.1.4">Conclusion<i class="fas fa-link"></i></a></h2>
<p>Now that you all know how you can implement vendor specific SQL
functionalities in DQL, we would be excited to see user extensions
that add vendor specific function packages, for example more math
functions, XML + GIS Support, Hashing functions and so on.</p>
<p>For 2.0 we will come with the current set of functions, however for
a future version we will re-evaluate if we can abstract even more
vendor sql functions and extend the DQL languages scope.</p>
<p>Code for this Extension to DQL and other Doctrine Extensions can be
found
<a href="https://github.com/beberlei/DoctrineExtensions">in my Github DoctrineExtensions repository</a>.</p>
</body>
</html>                    </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
