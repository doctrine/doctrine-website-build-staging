<!DOCTYPE html>
<html>
    <head>
        <title>Using a Custom Document Class Mapper with PHPCR-ODM - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.">

        <meta name="keywords" content="php, mysql, orm, dbal, database, mongodb, odm, annotations, migrations, cache, couchdb">

                    <meta name="robots" content="noindex">
        
                    <link rel="canonical" href="https://staging.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/cookbook/custom_documentclass_mapper.html" />
    
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://staging.doctrine-project.org/css/style.css?3625e4" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://staging.doctrine-project.org/components/highlightjs/styles/railscasts.css?b4f8ae" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://staging.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://staging.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://staging.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://staging.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://staging.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://staging.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://staging.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://staging.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://staging.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://staging.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://staging.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://staging.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://staging.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://staging.doctrine-project.org/images/mstile-310x310.png" />

        <meta property="og:image" content="https://staging.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://staging.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://staging.doctrine-project.org",
            "logo": "https://staging.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://staging.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://staging.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://staging.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Course",
            "name": "Doctrine PHPCR ODM",
            "description": "Using a Custom Document Class Mapper with PHPCR-ODM",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://staging.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://staging.doctrine-project.org/"><img src="https://staging.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="https://staging.doctrine-project.org/projects.html" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu projects-dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/couchdb-odm.html">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://staging.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>

                <div class="search-results rounded">
                    <div id="hits">
                        <!-- Hits widget will appear here -->
                    </div>

                    <a href="https://www.algolia.com" target="_blank"><img src="https://staging.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
                </div>
            </nav>
        
            <div class="container-wrapper container-fluid">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        
<div class="toc"><ul><li id="custom_documentclass_mapper-html-title-1" class="toc-item"><a href="custom_documentclass_mapper.html#title.1">Using a Custom Document Class Mapper with PHPCR-ODM</a></li><ul><li id="custom_documentclass_mapper-html-title-1-1" class="toc-item"><a href="custom_documentclass_mapper.html#title.1.1">Symfony2 integration</a></li></ul><li id="last-modified-html-title-1" class="toc-item"><a href="last-modified.html#title.1">Last modification timestamp</a></li><ul><li id="last-modified-html-title-1-1" class="toc-item"><a href="last-modified.html#title.1.1">Using the build-in support</a></li><li id="last-modified-html-title-1-2" class="toc-item"><a href="last-modified.html#title.1.2">A lastModified listener for custom behaviour</a></li></ul><li id="refactoring-multilang-html-title-1" class="toc-item"><a href="refactoring-multilang.html#title.1">Refactoring Multilanguage Documents</a></li><ul><li id="refactoring-multilang-html-title-1-1" class="toc-item"><a href="refactoring-multilang.html#title.1.1">Procedure</a></li><li id="refactoring-multilang-html-title-1-2" class="toc-item"><a href="refactoring-multilang.html#title.1.2">Converting Untranslated Fields to be Translated</a></li><li id="refactoring-multilang-html-title-1-3" class="toc-item"><a href="refactoring-multilang.html#title.1.3">Removing Translation from a Field</a></li><li id="refactoring-multilang-html-title-1-4" class="toc-item"><a href="refactoring-multilang.html#title.1.4">Changing the Translation Strategy</a></li></ul></ul></div>
                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects.html">Projects</a></li>
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a></li>
                                <li class="breadcrumb-item"><a href="https://staging.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/">Documentation</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Using a Custom Document Class Mapper with PHPCR-ODM</li>
                            </ol>
                        </nav>
                                    </div>

                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            <ul class="list-inline">
                                                                            <li class="list-inline-item mr-0">
                                            <a href="/projects/doctrine-phpcr-odm/en/latest/cookbook/custom_documentclass_mapper.html" class="project-version-switcher badge badge-warning">master</a>
                                        </li>
                                    
                                    
                                    <li class="list-inline-item ml-2"><a href="https://github.com/doctrine/phpcr-odm/edit/master/docs/en/cookbook/custom_documentclass_mapper.rst" class="badge badge-primary">Edit</a></li>

                                </ul>
                            
                            
<a class="section-anchor" id="title.1" name="title.1"></a><h1 class="section-header"><a href="#title.1">Using a Custom Document Class Mapper with PHPCR-ODM<i class="fas fa-link"></i></a></h1>
<p>The default document class mapper of PHPCR-ODM uses the attribute
<code>phpcr:class</code> to store and retrieve the document class of a node. When
accessing an existing PHPCR repository, you might need different logic to
decide on the class.</p>
<p>You can extend the <code>DocumentClassMapper</code> or implement
<code>DocumentClassMapperInterface</code> from scratch. The important methods are
<code>getClassName</code> that needs to find the class name and <code>writeMetadata</code>
that needs to make sure the class of a newly stored document can be
determined when loading it again.</p>
<p>An example mapper from the <a href="https://github.com/symfony-cmf/cmf-sandbox/tree/magnolia_integration">symfony cmf sandbox</a>
(<code>magnolia_integration</code> branch):</p>
<pre><code class="">namespace Sandbox\MagnoliaBundle\Document;

use Doctrine\ODM\PHPCR\DocumentClassMapper;
use Doctrine\ODM\PHPCR\DocumentManager;

use PHPCR\NodeInterface;
use PHPCR\PropertyType;

class MagnoliaDocumentClassMapper extends DocumentClassMapper
{
    private $templateMap;

    /**
     * @param array $templateMap map from mgnl:template values to document class names
     */
    public function __construct($templateMap)
    {
        $this-&gt;templateMap = $templateMap;
    }

    /**
     * Determine the class name from a given node
     *
     * @param DocumentManager
     * @param NodeInterface $node
     * @param string $className
     *
     * @return string
     *
     * @throws \RuntimeException if no class name could be determined
     */
    public function getClassName(DocumentManager $dm, NodeInterface $node, $className = null)
    {
        $className = parent::getClassName($dm, $node, $className);
        if ('Doctrine\ODM\PHPCR\Document\Generic' == $className) {
            if ($node-&gt;hasNode('MetaData')) {
                $metaData = $node-&gt;getNode('MetaData');
                if ($metaData-&gt;hasProperty('mgnl:template')) {
                    if (isset($this-&gt;templateMap[$metaData-&gt;getPropertyValue('mgnl:template')])) {
                        return $this-&gt;templateMap[$metaData-&gt;getPropertyValue('mgnl:template')];
                    }
                }
            }
        }

        return $className;
    }
}
</code></pre>
<p>Then adjust your <a href="../">bootstrap code</a> to use the
custom mapper:</p>
<pre><code class="">/* prepare the doctrine configuration */
$config = new \Doctrine\ODM\PHPCR\Configuration();
$map = array(
    'standard-templating-kit:pages/stkSection' =&gt; 'Sandbox\MagnoliaBundle\Document\Section',
);
$mapper = new MagnoliaDocumentClassMapper($map);
$config-&gt;setDocumentClassMapper($mapper);

$documentManager = \Doctrine\ODM\PHPCR\DocumentManager::create($session, $config);

...
</code></pre>
<a class="section-anchor" id="title.1.1" name="title.1.1"></a><h2 class="section-header"><a href="#title.1.1">Symfony2 integration<i class="fas fa-link"></i></a></h2>
<p>If you are running on Symfony2, you do not instantiate PHPCR-ODM manually.
Instead, you adjust the configuration in your service definition.</p>
<p>Here we overwrite the <code>doctrine.odm_configuration</code> service to call
<code>setDocumentClassMapper</code> on it. This will make it use this mapper instead
of instantiating the default one. An example from the <a href="https://github.com/symfony-cmf/cmf-sandbox/tree/magnolia_integration">symfony cmf sandbox</a>
(<code>magnolia_integration</code> branch):</p>
<div class="configuration-block"><pre><code class="yaml"># if you want to overwrite default configuration, otherwise use a
# custom name and specify in odm configuration block

doctrine.odm_configuration:
    class: %doctrine_phpcr.odm.configuration.class%
    calls:
        - [ setDocumentClassMapper, [@sandbox_magnolia.odm_mapper] ]

sandbox_magnolia.odm_mapper:
    class: &quot;Sandbox\MagnoliaBundle\Document\MagnoliaDocumentClassMapper&quot;
    arguments:
        - 'standard-templating-kit:pages/stkSection': 'Sandbox\MagnoliaBundle\Document\Section'
</code></pre>
<pre><code class="xml">&lt;service id=&quot;doctrine.odm_configuration&quot;
    class=&quot;%doctrine_phpcr.odm.configuration.class%&quot;&gt;
    &lt;call method=&quot;setDocumentClassMapper&quot;&gt;
        &lt;argument type=&quot;service&quot; id=&quot;sandbox_magnolia.odm_mapper&quot; /&gt;
    &lt;/call&gt;
&lt;/service&gt;

&lt;service id=&quot;sandbox_magnolia.odm_mapper&quot;
    class=&quot;Sandbox\MagnoliaBundle\Document\MagnoliaDocumentClassMapper&quot;&gt;
    &lt;argument type=&quot;collection&quot;&gt;
        &lt;argument type=&quot;standard-templating-kit:pages/stkSection&quot;&gt;Sandbox\MagnoliaBundle\Document\Section&lt;/argument&gt;
    &lt;/argument&gt;
&lt;/service&gt;
</code></pre>
<pre><code class="php">use Symfony\Component\DependencyInjection\Definition;
use Symfony\Component\DependencyInjection\Reference;

$container
    -&gt;register('doctrine.odm_configuration', '%doctrine_phpcr.odm.configuration.class%')
    -&gt;addMethodCall('setDocumentClassMapper', array(
        new Reference('sandbox_magnolia.odm_mapper'),
    ))
;

$container -&gt;setDefinition('sandbox_amgnolia.odm_mapper', new Definition(
    'Sandbox\MagnoliaBundle\Document\MagnoliaDocumentClassMapper',
    array(
        array(
            'standard-templating-kit:pages/stkSection' =&gt; 'Sandbox\MagnoliaBundle\Document\Section',
        ),
    ),
));
</code></pre>
</div>
                                            </div>
                </div>
            </main>
        </div>
    </div>

                            
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://staging.doctrine-project.org/components/highlightjs/highlight.pack.js?3970aa"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://staging.doctrine-project.org/js/main.js?f32c09"></script>
        <script src="https://staging.doctrine-project.org/js/search.js?21d569"></script>

        <script type="text/javascript">
            var projectSlug = 'phpcr-odm';
            var versionSlug = 'latest';

            new Main();

            new Search(projectSlug, versionSlug);
        </script>

            <script src="https://staging.doctrine-project.org/js/sidebar.js?6349dd"></script>

    <script type="text/javascript">
        new Sidebar();
    </script>

        
        
            </body>
</html>
