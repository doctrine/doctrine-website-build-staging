<!DOCTYPE html>
<html>
    <head>
        <title>Events - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                                                                
                                
                                                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/">Home</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/">Projects</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/">Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Events</li>
                        </ol>
                    </nav>
                
                                    <ul class="list-inline float-right">
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-phpcr-odm/en/latest/reference/events.html" class="badge badge-primary">master</a>
                            </li>
                                            </ul>
                
                <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>
<h1 class="section-header" id="title.1"><a href="#title.1">Events<i class="fas fa-link"></i></a></h1>
<p>Doctrine PHPCR-ODM features a lightweight event system that is part of the
Common package.</p>
<p>For a general introduction, see the corresponding chapter in the <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/events.html">Doctrine ORM documentation</a></p>
<h2 class="section-header" id="title.1.1"><a href="#title.1.1">Lifecycle Events<i class="fas fa-link"></i></a></h2>
<p>The DocumentManager and PHPCR-ODM UnitOfWork trigger a bunch of events during
the life-time of their registered documents.</p>
<ul><li class="dash">prePersist - occurs before a new document is created in the repository;</li>
<li class="dash">postPersist - occurs after a document has been created in repository.
  Generated fields will be available in this state;</li>
<li class="dash">preUpdate - occurs before an existing document is updated in the repository,
  during the flush operation;</li>
<li class="dash">postUpdate - occurs after an existing document has successfully been updated
  in the repository;</li>
<li class="dash">postLoad - occurs after the document has been loaded from the repository;</li>
<li class="dash">preMove - occurs before a document move operation is persisted to the PHPCR
  session during flush;</li>
<li class="dash">postMove - occurs after a document move operation has been persisted to the
  PHPCR session during flush;</li>
<li class="dash">preRemove - occurs before a document is removed from the repository;</li>
<li class="dash">postRemove - occurs after the document has been successfully removed from the
  repository;</li>
<li class="dash">preFlush - occurs at the very beginning of a flush operation. This event is
  not a lifecycle callback;</li>
<li class="dash">onFlush - occurs after the change-sets of all managed documents have been
  computed. This event is not a lifecycle callback;</li>
<li class="dash">postFlush - occurs after the flush has been committed, but before the UOW
  state has been reset. This event is not a lifecycle callback;</li>
<li class="dash">endFlush - occurs after the flush has been comitted <em>and</em> the UOW has been
  reset. It is safe to call `flush()` again from this event. This event is not
  a lifecycle callback.</li>
<li class="dash">onClear - occurs when the DocumentManager#clear() operation is invoked, after
  all references to documents have been removed from the unit of work. This
  event is not a lifecycle callback;</li>
<li class="dash">loadClassMetadata - occurs after mapping metadata for a class has been loaded
  from a mapping source (annotations/xml/yaml). This event is not a lifecycle
  callback.</li>
<li class="dash">postLoadTranslation - occurs when a translation of a document has been loaded
  from the repository.</li>
<li class="dash">preBindTranslation - occurs before binding a translation, but after persist
  (you need to persist before binding a translation)</li>
<li class="dash">postBindTranslation - occurs after a translation has been created in the
  repository.</li>
<li class="dash">preRemoveTranslation - occurs before a document's translation is removed
  from repository.</li>
<li class="dash">postRemoveTranslation - occurs after a document's translation was successfully
  removed.</li>
</ul>

<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>If you use PHPCR-ODM inside Symfony2, you can use the tag
doctrine_phpcr.event_listener to register a service as event listener.
See the <a href="http://github.com/doctrine/DoctrinePHPCRBundle">Documentation of DoctrinePHPCRBundle</a>
for more information.</p>
</div>
<div class="alert warning bg-light-yellow text-dark border"><i class="fas fa-exclamation-circle text-warning mr-2"></i><p>Note that the postLoad event occurs for a document
before any associations have been initialized. Therefore it is not
safe to access associations in a postLoad callback or event
handler.</p>
</div>
<p>You can access the Event constants from the <code>Event</code> class in the
PHPCR-ODM package:</p>
<pre><code class="">use Doctrine\ODM\PHPCR\Event;

echo Event::preUpdate;
</code></pre>
<h2 class="section-header" id="title.1.2"><a href="#title.1.2">Event order when moving<i class="fas fa-link"></i></a></h2>
<p>During the flush() operation of a modified document, the events get triggered in the following order:</p>
<ul><li>1. preFlush</li>
<li>2. onFlush</li>
<li>3. preUpdate</li>
<li>4. postUpdate</li>
<li>5. preMove</li>
<li>6. postMove</li>
<li>7. postFlush</li>
</ul>

<p>As the move event is triggered after the changeset has been calculated,
modifications to the document are not taken into account anymore.</p>
<h2 class="section-header" id="title.1.3"><a href="#title.1.3">Event order when handling with translations<i class="fas fa-link"></i></a></h2>
<p>When binding/removing a translation or load it from repository, the events get
triggered in the following order:</p>
<ul><li>1. prePersist (you need to persist before calling <code>bindTranlation()</code>)</li>
<li>2. preBindTranslation</li>
<li>3. postBindTranslation</li>
</ul>

<p>Load a document by its translation</p>
<ul><li>4. postLoadTranslation</li>
</ul>

<p>Remove a translation</p>
<ul><li>5. preRemoveTranslation</li>
<li>6. postRemoveTranslation</li>
</ul>

<h2 class="section-header" id="title.1.4"><a href="#title.1.4">Listening to events<i class="fas fa-link"></i></a></h2>
<p>These can be hooked into by two different types of event
listeners:</p>
<ul><li class="dash"> Lifecycle Callbacks are methods on the document classes that are
   called when the event is triggered. They receive absolutely no
   arguments and are specifically designed to allow changes inside the
   document classes state.</li>
<li class="dash"> Lifecycle Event Listeners are classes with specific callback
   methods that receives some kind of <code>EventArgs</code> instance which
   give access to the entity, EntityManager or other relevant data.</li>
</ul>

<a id="events_lifecyclecallbacks"></a>
<h2 class="section-header" id="title.1.5"><a href="#title.1.5">Lifecycle Callbacks<i class="fas fa-link"></i></a></h2>
<p>A lifecycle event is a regular event with the additional feature of
providing a mechanism to register direct callbacks inside the
corresponding document classes that are executed when the lifecycle
event occurs.</p>
<div class="configuration-block"><pre><code class="php">use Doctrine\ODM\PHPCR\Mapping\Annotations as PHPCR;

/**
 * @PHPCR\PrePersist
 */
public function doStuffOnPrePersist()
{
    $this-&gt;createdAt = date('Y-m-d H:m:s');
}

/**
 * @PHPCR\PrePersist
 */
public function doOtherStuffOnPrePersist()
{
    $this-&gt;value = 'changed from prePersist callback!';
}

/**
 * @PHPCR\PostPersist
 */
public function doStuffOnPostPersist()
{
    $this-&gt;value = 'changed from postPersist callback!';
}

/**
 * @PHPCR\PostLoad
 */
public function doStuffOnPostLoad()
{
    $this-&gt;value = 'changed from postLoad callback!';
}

/**
 * @PHPCR\PreUpdate
 */
public function doStuffOnPreUpdate()
{
    $this-&gt;value = 'changed from preUpdate callback!';
}

/**
 * @PHPCR\PreBindTranslation
 */
public function doStuffOnPreBindTranslation()
{
    $this-&gt;value = 'changed from preBindTranslation callback!';
}

/**
 * @PHPCR\PostBindTranslation
 */
public function doStuffOnPostBindTranslation()
{
    $this-&gt;value = 'changed from postBindTranslation callback!';
}

/**
 * @PHPCR\postLoadTranslation
 */
public function doStuffOnPostLoadTranslation()
{
    $this-&gt;value = 'changed from postLoadTranslation callback!';
}
/**
 * @PHPCR\PreRemoveTranslation
 */
public function doStuffOnPreRemoveTranslation()
{
    $this-&gt;value = 'changed from preRemoveTranslation callback!';
}
/**
 * @PHPCR\PostRemoveTranslation
 */
public function doStuffOnPostRemoveTranslation()
{
    $this-&gt;value = 'changed from postRemoveTranslation callback!';
}
</code></pre>
<pre><code class="yaml">MyPersistentClass:
  lifecycleCallbacks:
    prePersist: [ doStuffOnPrePersist, doOtherStuffOnPrePersistToo ]
    postPersist: [ doStuffOnPostPersist ]
</code></pre>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;doctrine-mapping&gt;
    &lt;document name=&quot;MyPersistentClass&quot;&gt;
        &lt;lifecycle-callbacks&gt;
            &lt;lifecycle-callback type=&quot;prePersist&quot; method=&quot;doStuffOnPrePersist&quot;/&gt;
            &lt;lifecycle-callback type=&quot;postPersist&quot; method=&quot;doStuffOnPostPersist&quot;/&gt;
        &lt;/lifecycle-callbacks&gt;
    &lt;/document&gt;
&lt;/doctrine-mapping&gt;
</code></pre>
</div>
<p>The methods mapped to the callbacks in xml or yml need to be public methods of your document.</p>
<p>The <code>key</code> of the lifecycleCallbacks is the name of the method and
the value is the event type. The allowed event types are the ones
listed in the previous Lifecycle Events section.</p>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>Contrary to the ORM, PHPCR-ODM does <strong>not</strong> use the @HasLifecycleCallbacks marker.</p>
</div>
<h2 class="section-header" id="title.1.6"><a href="#title.1.6">Listening to Lifecycle Events<i class="fas fa-link"></i></a></h2>
<p>This works exactly the same as with the <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/events.html#listening-to-lifecycle-events">ORM events</a>.</p>
</body>
</html>                    </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
