<!DOCTYPE html>
<html>
    <head>
        <title>Views and Map-Reduce Queries - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                                                                
                                
                                                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/">Home</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/">Projects</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/doctrine-couchdb-odm/en/latest/">Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Views and Map-Reduce Queries</li>
                        </ol>
                    </nav>
                
                                    <ul class="list-inline float-right">
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-couchdb-odm/en/latest/reference/map-reduce-queries.html" class="badge badge-primary">master</a>
                            </li>
                                            </ul>
                
                <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>
<h1 class="section-header" id="title.1"><a href="#title.1">Views and Map-Reduce Queries<i class="fas fa-link"></i></a></h1>
<p>CouchDB uses views filtered through map-reduce to query all the documents of your database. Each view
has a map- and optionally a reduce-function. Doctrine CouchDB ODM allows you to create and query views
in your application.</p>
<h2 class="section-header" id="title.1.1"><a href="#title.1.1">Creating and Managing Views<i class="fas fa-link"></i></a></h2>
<p>Views are best managed as a folder structure in the filesystem. Create a Directory &quot;couchdb/views&quot;
and instantiate a <code>FolderDesignDocument</code> in the following way and create the
design document in the database:</p>
<pre><code class="php">&lt;?php
use Doctrine\CouchDB\View\FolderDesignDocument;

$view = new FolderDesignDocument(&quot;path/to/app/couchdb&quot;);
$designDocJson = $view-&gt;getData();

$couchClient-&gt;createDesignDocument(&quot;myapp&quot;, $view);
</code></pre>
<p>If the directory structure now looked like the following:</p>

<pre><code class="">couchdb/
    views/
        username/
            map.js
        article-dates/
            map.js
            reduce.js
</code></pre>
<p>It will create two views &quot;username&quot; and &quot;article-dates&quot; with
corresponding map and reduce functions. For example
the username map.js might look like:</p>
<pre><code class="javascript">function(doc) {
    if (doc.type == 'Doctrine.Tests.Models.CMS.CmsUser') {
        emit(doc.username, doc._id);
    }
}
</code></pre>
<h2 class="section-header" id="title.1.2"><a href="#title.1.2">Querying Views<i class="fas fa-link"></i></a></h2>
<p>To query a view from Doctrine CouchDB ODM you have to register it with its design document name
in the CouchDB ODM Configuration:</p>
<pre><code class="php">&lt;?php

$config = $dm-&gt;getConfiguration();
$config-&gt;addDesignDocument(
    &quot;myapp&quot;, 
    &quot;Doctrine\CouchDB\View\FolderDesignDocument&quot;,
    &quot;path/to/app/couchdb&quot;
);
</code></pre>
<p>You can then create either a native or a odm-query by calling
either <code>DocumentManager#createNativeQuery($designDocName, $viewName)</code> or
<code>DocumentManager#createQuery($designDocName, $viewName)</code>.</p>
<p>The difference between both queries is their result and some parameters. The ODM query will
return instances of php objects that map to the CouchDB documents and
the native query will return only convert the json to arrays that have been fetched from
the CouchDB.</p>
<p>Both queries have a common base class with a simple API:</p>
<pre><code class="php">&lt;?php

namespace Doctrine\CouchDB\View;

abstract class AbstractQuery
{
    /**
     * Get HTTP Query Parameter 
     *
     * @param  string $key
     * @return mixed
     */
    public function getParameter($key);

    /**
     * Query the view with the current params.
     *
     * @return Doctrine\CouchDB\View\Result
     */
    public function execute();

    /**
     * Create design document for this query.
     *
     * Method is used internally when querying the view and it doesnt exist yet.
     *
     * @return void
     */
    public function createDesignDocument();
}
</code></pre>
<p>With both query types you just call execute() to retrieve the result from the database.</p>
<p>The following query parameter related methods exist in both the native and odm-query:</p>
<pre><code class="php">&lt;?php
namespace Doctrine\CouchDB\View;

class Query extends AbstractQuery
{
    /**
     * Find key in view.
     *
     * @param  string $val
     * @return Query
     */
    public function setKey($val);

    /**
     * Set starting key to query view for.
     *
     * @param  string $val
     * @return Query
     */
    public function setStartKey($val);

    /**
     * Set ending key to query view for.
     *
     * @param  string $val
     * @return Query
     */
    public function setEndKey($val);

    /**
     * Document id to start with
     *
     * @param  string $val
     * @return Query
     */
    public function setStartKeyDocId($val);

    /**
     * Last document id to include in the output
     *
     * @param  string $val
     * @return Query
     */
    public function setEndKeyDocId($val);

    /**
     * Limit the number of documents in the output
     *
     * @param  int $val
     * @return Query
     */
    public function setLimit($val);

    /**
     * Skip n number of documents
     *
     * @param  int $val
     * @return Query
     */
    public function setSkip($val);

    /**
     * If stale=ok is set CouchDB will not refresh the view even if it is stalled.
     *
     * @param  bool $flag
     * @return Query
     */
    public function setStale($flag);

    /**
     * reverse the output
     *
     * @param  bool $flag
     * @return Query
     */
    public function setDescending($flag);

    /**
     * The group option controls whether the reduce function reduces to a set of distinct keys or to a single result row.
     *
     * @param  bool $flag
     * @return Query
     */
    public function setGroup($flag);

    public function setGroupLevel($level);

    /**
     * Use the reduce function of the view. It defaults to true, if a reduce function is defined and to false otherwise.
     *
     * @param  bool $flag
     * @return Query
     */
    public function setReduce($flag);

    /**
     * Controls whether the endkey is included in the result. It defaults to true.
     *
     * @param  bool $flag
     * @return Query
     */
    public function setInclusiveEnd($flag);

    /**
     * Automatically fetch and include the document which emitted each view entry
     *
     * @param  bool $flag
     * @return Query
     */
    public function setIncludeDocs($flag);
}
</code></pre>
<p>There is a single additional method on the ODM Query that specifies if
you just want to return the documents associated with a view result:</p>
<pre><code class="php">&lt;?php
namespace Doctrine\ODM\CouchDB\View;

class ODMQuery extends Query
{
    public function onlyDocs($flag);
}
</code></pre>
<p>An example execution of the username view given above looks like:</p>
<pre><code class="php">&lt;?php

$query = $dm-&gt;createQuery(&quot;myapp&quot;, &quot;username&quot;);
$result = $query-&gt;setStartKey(&quot;b&quot;)
      -&gt;setEndKey(&quot;c&quot;)
      -&gt;setLimit(100)
      -&gt;setSkip(20)
      -&gt;onlyDocs(true)
      -&gt;execute();
</code></pre>
<p>This will return all usernames starting with &quot;b&quot; and ending with &quot;c&quot;,
skipping the first 20 results and limiting the result to 100 documents.</p>
<h2 class="section-header" id="title.1.3"><a href="#title.1.3">View Results<i class="fas fa-link"></i></a></h2>
<p>The result of a view is an instance of <code>Doctrine\CouchDB\View\Result</code>.
It implements <code>Countable</code>, <code>IteratorAggregate</code> and <code>ArrayAccess</code>.
If you specify <code>onlyDocs(true)</code> each result-row will contain only
the associated document, otherwise the document is on the row index &quot;doc&quot;
of the query.</p>
<p>The following snippet shows the difference:</p>
<pre><code class="php">&lt;?php

$query = $dm-&gt;createQuery(&quot;myapp&quot;, &quot;username&quot;);
$result = $query-&gt;setStartKey(&quot;b&quot;)
      -&gt;setEndKey(&quot;c&quot;)
      -&gt;setLimit(100)
      -&gt;setSkip(20)
      -&gt;onlyDocs(true)
      -&gt;execute();

foreach ($result AS $user) {
    echo $user-&gt;getUsername() . &quot;\n&quot;;
}

$query-&gt;onlyDocs(false);
$result = $query-&gt;execute();

foreach ($result AS $userRow) {
    echo $userRow['doc']-&gt;getUsername() . &quot;\n&quot;;
}
</code></pre>
</body>
</html>                    </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
