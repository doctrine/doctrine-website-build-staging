<!DOCTYPE html>
<html>
    <head>
        <title>Transactions - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    <meta name="robots" content="noindex, follow">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                                                                
                                
                                                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/">Home</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/">Projects</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/dbal/">DBAL</a></li>
                            <li class="breadcrumb-item"><a href="https://new.doctrine-project.org/projects/doctrine-dbal/en/latest/">Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Transactions</li>
                        </ol>
                    </nav>
                
                                    <ul class="list-inline float-right">
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-dbal/en/latest/reference/transactions.html" class="badge badge-primary">master</a>
                            </li>
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-dbal/en/2.6/reference/transactions.html" class="badge badge-secondary">2.6</a>
                            </li>
                                                    <li class="list-inline-item mr-0">
                                <a href="/projects/doctrine-dbal/en/2.5/reference/transactions.html" class="badge badge-secondary">2.5</a>
                            </li>
                                            </ul>
                
                <!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body>
<h1 class="section-header" id="title.1"><a href="#title.1">Transactions<i class="fas fa-link"></i></a></h1>
<p>A <code>Doctrine\DBAL\Connection</code> provides a PDO-like API for
transaction management, with the methods
<code>Connection#beginTransaction()</code>, <code>Connection#commit()</code> and
<code>Connection#rollBack()</code>.</p>
<p>Transaction demarcation with the Doctrine DBAL looks as follows:</p>

<pre><code class="">&lt;?php
$conn-&gt;beginTransaction();
try{
    // do stuff
    $conn-&gt;commit();
} catch (\Exception $e) {
    $conn-&gt;rollBack();
    throw $e;
}
</code></pre>
<p>Alternatively, the control abstraction
<code>Connection#transactional($func)</code> can be used to make the code
more concise and to make sure you never forget to rollback the
transaction in the case of an exception. The following code snippet
is functionally equivalent to the previous one:</p>

<pre><code class="">&lt;?php
$conn-&gt;transactional(function($conn) {
    // do stuff
});
</code></pre>
<p>The <code>Doctrine\DBAL\Connection</code> also has methods to control the
transaction isolation level as supported by the underlying
database. <code>Connection#setTransactionIsolation($level)</code> and
<code>Connection#getTransactionIsolation()</code> can be used for that purpose.
The possible isolation levels are represented by the following
constants:</p>

<pre><code class="">&lt;?php
Connection::TRANSACTION_READ_UNCOMMITTED
Connection::TRANSACTION_READ_COMMITTED
Connection::TRANSACTION_REPEATABLE_READ
Connection::TRANSACTION_SERIALIZABLE
</code></pre>
<p>The default transaction isolation level of a
<code>Doctrine\DBAL\Connection</code> is chosen by the underlying platform
but it is always at least READ\_COMMITTED.</p>
<h2 class="section-header" id="title.1.1"><a href="#title.1.1">Transaction Nesting<i class="fas fa-link"></i></a></h2>
<p>A <code>Doctrine\DBAL\Connection</code> also adds support for nesting
transactions, or rather propagating transaction control up the call
stack. For that purpose, the <code>Connection</code> class keeps an internal
counter that represents the nesting level and is
increased/decreased as <code>beginTransaction()</code>, <code>commit()</code> and
<code>rollBack()</code> are invoked. <code>beginTransaction()</code> increases the
nesting level whilst
<code>commit()</code> and <code>rollBack()</code> decrease the nesting level. The nesting level starts at 0. Whenever the nesting level transitions from 0 to 1, <code>beginTransaction()</code> is invoked on the underlying driver connection and whenever the nesting level transitions from 1 to 0, <code>commit()</code> or <code>rollBack()</code> is invoked on the underlying driver, depending on whether the transition was caused by <code>Connection#commit()</code> or <code>Connection#rollBack()</code>.</p>
<p>What this means is that transaction control is basically passed to
code higher up in the call stack and the inner transaction block is
ignored, with one important exception that is described further
below. Do not confuse this with &quot;real&quot; nested transactions or
savepoints. These are not supported by Doctrine. There is always
only a single, real database transaction.</p>
<p>To visualize what this means in practice, consider the following
example:</p>

<pre><code class="">&lt;?php
// $conn instanceof Doctrine\DBAL\Connection
$conn-&gt;beginTransaction(); // 0 =&gt; 1, &quot;real&quot; transaction started
try {

    ...

    // nested transaction block, this might be in some other API/library code that is
    // unaware of the outer transaction.
    $conn-&gt;beginTransaction(); // 1 =&gt; 2
    try {
        ...

        $conn-&gt;commit(); // 2 =&gt; 1
    } catch (\Exception $e) {
        $conn-&gt;rollBack(); // 2 =&gt; 1, transaction marked for rollback only
        throw $e;
    }

    ...

    $conn-&gt;commit(); // 1 =&gt; 0, &quot;real&quot; transaction committed
} catch (\Exception $e) {
    $conn-&gt;rollBack(); // 1 =&gt; 0, &quot;real&quot; transaction rollback
    throw $e;
}
</code></pre>
<p>However,
<strong>a rollback in a nested transaction block will always mark the current transaction so that the only possible outcome of the transaction is to be rolled back</strong>.
That means in the above example, the rollback in the inner
transaction block marks the whole transaction for rollback only.
Even if the nested transaction block would not rethrow the
exception, the transaction is marked for rollback only and the
commit of the outer transaction would trigger an exception, leading
to the final rollback. This also means that you can not
successfully commit some changes in an outer transaction if an
inner transaction block fails and issues a rollback, even if this
would be the desired behavior (i.e. because the nested operation is
&quot;optional&quot; for the purpose of the outer transaction block). To
achieve that, you need to restructure your application logic so as
to avoid nesting transaction blocks. If this is not possible
because the nested transaction blocks are in a third-party API
you're out of luck.</p>
<p>All that is guaranteed to the inner transaction is that it still
happens atomically, all or nothing, the transaction just gets a
wider scope and the control is handed to the outer scope.</p>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>The transaction nesting described here is a debated
feature that has its critics. Form your own opinion. We recommend
avoiding nesting transaction blocks when possible, and most of the
time, it is possible. Transaction control should mostly be left to
a service layer and not be handled in data access objects or
similar.</p>
</div>
<div class="alert warning bg-light-yellow text-dark border"><i class="fas fa-exclamation-circle text-warning mr-2"></i><p>Directly invoking <code>PDO#beginTransaction()</code>,
<code>PDO#commit()</code> or <code>PDO#rollBack()</code> or the corresponding methods
on the particular <code>Doctrine\DBAL\Driver\Connection</code> instance in
use bypasses the transparent transaction nesting that is provided
by <code>Doctrine\DBAL\Connection</code> and can therefore corrupt the
nesting level, causing errors with broken transaction boundaries
that may be hard to debug.</p>
</div>
<h2 class="section-header" id="title.1.2"><a href="#title.1.2">Auto-commit mode<i class="fas fa-link"></i></a></h2>
<p>A <code>Doctrine\DBAL\Connection</code> supports setting the auto-commit mode
to control whether queries should be automatically wrapped into a
transaction or directly be committed to the database.
By default a connection runs in auto-commit mode which means
that it is non-transactional unless you start a transaction explicitly
via <code>beginTransaction()</code>. To have a connection automatically open up
a new transaction on <code>connect()</code> and after <code>commit()</code> or <code>rollBack()</code>,
you can disable auto-commit mode with <code>setAutoCommit(false)</code>.</p>

<pre><code class="">&lt;?php
// define connection parameters $params and initialize driver $driver

$conn = new \Doctrine\DBAL\Connection($params, $driver);

$conn-&gt;setAutoCommit(false); // disables auto-commit
$conn-&gt;connect(); // connects and immediately starts a new transaction

try {
    // do stuff
    $conn-&gt;commit(); // commits transaction and immediately starts a new one
} catch (\Exception $e) {
    $conn-&gt;rollBack(); // rolls back transaction and immediately starts a new one
}

// still transactional
</code></pre>
<div class="alert note bg-light-yellow text-dark border"><i class="fas fa-sticky-note text-primary mr-2"></i><p>Changing auto-commit mode during an active transaction, implicitly
commits active transactions for that particular connection.</p>
</div>

<pre><code class="">&lt;?php
// define connection parameters $params and initialize driver $driver

$conn = new \Doctrine\DBAL\Connection($params, $driver);

// we are in auto-commit mode
$conn-&gt;beginTransaction();

// disable auto-commit, commits currently active transaction
$conn-&gt;setAutoCommit(false); // also causes a new transaction to be started

// no-op as auto-commit is already disabled
$conn-&gt;setAutoCommit(false);

// enable auto-commit again, commits currently active transaction
$conn-&gt;setAutoCommit(true); // does not start a new transaction automatically
</code></pre>
<p>Committing or rolling back an active transaction will of course only
open up a new transaction automatically if the particular action causes
the transaction context of a connection to terminate.
That means committing or rolling back nested transactions are not affected
by this behaviour.</p>

<pre><code class="">&lt;?php
// we are not in auto-commit mode, transaction is active

try {
    // do stuff

    $conn-&gt;beginTransaction(); // start inner transaction, nesting level 2

    try {
        // do stuff
        $conn-&gt;commit(); // commits inner transaction, does not start a new one
    } catch (\Exception $e) {
        $conn-&gt;rollBack(); // rolls back inner transaction, does not start a new one
    }

    // do stuff

    $conn-&gt;commit(); // commits outer transaction, and immediately starts a new one
} catch (\Exception $e) {
    $conn-&gt;rollBack(); // rolls back outer transaction, and immediately starts a new one
}
</code></pre>
<p>To initialize a <code>Doctrine\DBAL\Connection</code> with auto-commit disabled,
you can also use the <code>Doctrine\DBAL\Configuration</code> container to modify the
default auto-commit mode via <code>Doctrine\DBAL\Configuration::setAutoCommit(false)</code>
and pass it to a <code>Doctrine\DBAL\Connection</code> when instantiating.</p>
<h2 class="section-header" id="title.1.3"><a href="#title.1.3">Error handling<i class="fas fa-link"></i></a></h2>
<p>In order to handle errors related to deadlocks or lock wait timeouts,
you can use Doctrine built-in transaction exceptions.
All transaction exceptions where retrying makes sense have a marker interface: <code>Doctrine\DBAL\Exception\RetryableException</code>.
A practical example is as follows:</p>

<pre><code class="">&lt;?php

try {
    // process stuff
} catch (\Doctrine\DBAL\Exception\RetryableException $e) {
    // retry the processing
}
</code></pre>
<p>If you need stricter control, you can catch the concrete exceptions directly:</p>
<ul><li class="dash"><code>Doctrine\DBAL\Exception\DeadlockException</code>: this can happen when each member
  of a group of actions is waiting for some other member to release a shared lock.</li>
<li class="dash"><code>Doctrine\DBAL\Exception\LockWaitTimeoutException</code>: this exception happens when
  a transaction has to wait a considerable amount of time to obtain a lock, even if
  a deadlock is not involved.</li>
</ul>

</body>
</html>                    </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
