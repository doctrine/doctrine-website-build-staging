<!DOCTYPE html>
<html>
    <head>
        <title>Cross Database Joins - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <meta name="robots" content="index, follow">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                <article>
        <header>
            <h2>Cross Database Joins <small>post</small></h2>
        </header>

        <p class="lead">
            Posted on 2009-06-19
                            by
                                    jwage
                                    </p>

        <div>
            <a id="title.1"></a><h1>Cross Database Joins</h1>
<p>In Doctrine, joining data across databases is not technically
&quot;supported&quot; by a designed feature, but you can make it work by
tricking Doctrine a little bit.</p>
<p>In this article I'll show you how you can setup a database schema
that specifies relationships across two databases and then issue a
query which joins data from these two databases.</p>
<p>I used the Doctrine sandbox to prepare this test so if you want to
try it, you can use it too.</p>
<a id="title.2"></a><h1>Database Connections</h1>
<p>First lets setup our two database connections we'll use to query
from. Modify the <code>config.php</code> file included with the sandbox and
replace the default single connection with the following code.</p>
<pre><code class="php">&lt;?php
Doctrine_Manager::connection('mysql://root@localhost/doctrine_test1', 'doctrine_test1');
Doctrine_Manager::connection('mysql://root@localhost/doctrine_test2', 'doctrine_test2');
</code></pre>
<a id="title.3"></a><h1>Schema</h1>
<p>Now lets define our YAML schema file that we'll use to run our
tests against. You can modify the <code>config/doctrine/schema.yml</code>
file and include the following YAML.</p>

<pre><code class="">[yml]
User:
  tableName: doctrine_test1.user
  connection: doctrine_test1
  columns:
    username: string(255)
    password: string(255)

Profile:
  tableName: doctrine_test2.profile
  connection: doctrine_test2
  columns:
    user_id: integer
    first_name: string(255)
    last_name: string(255)
  relations:
    User:
      foreignType: one
      onDelete: CASCADE

**NOTE** Notice how we specify the full table name, including the
name of the database. Currently, Doctrine does not generate the SQL
that includes the database name. It only includes the table name,
but we can trick Doctrine by simply specifying the
``database_name.table_name`` as the table name.

</code></pre>
<a id="title.4"></a><h1>Test Data Fixtures</h1>
<p>In the <code>data/fixtures</code> directory create a <code>data.yml</code> file and
paste the following fixtures inside so we can have some data in
each database to run our tests against.</p>

<pre><code class="">[yml]
User:
  jwage:
    username: jwage
    password: changeme
    Profile:
      first_name: string(255)
      last_name: string(255)
</code></pre>
<a id="title.5"></a><h1>Build the Database</h1>
<p>Now lets build our database and import the data fixtures from
above. This can be easily done by running the following from the
Doctrine command line interface.</p>

<pre><code class="">$ php doctrine build-all-reload
</code></pre>
<a id="title.6"></a><h1>Run the Test</h1>
<p>Now we have our models created, we have our database created and we
have our test fixtures loaded in to the database. Now it is time to
run some sample code and see what we get!</p>
<p>First lets write our <code>Doctrine_Query</code> and look at the generated
SQL. Paste the following code in to index.php and lets execute it!</p>
<pre><code class="php">&lt;?php
$q = Doctrine::getTable('User')
  -&gt;createQuery('u')
  -&gt;leftJoin('u.Profile p');

echo $q-&gt;getSql();
</code></pre>
<p>The above code would output the following SQL query.</p>

<pre><code class="">[sql]
SELECT d.id AS d__id, d.username AS d__username, d.password AS d__password, d2.id AS d2__id, d2.user_id AS d2__user_id, d2.first_name AS d2__first_name, d2.last_name AS d2__last_name FROM doctrine_test1.user d LEFT JOIN doctrine_test2.profile d2 ON d.id = d2.user_id

**NOTE** Notice how in the above SQL that is generated it include
the database name and the table name. So now the query is able to
join across databases if your RDBMS supports it.

</code></pre>
<p>Now lets execute the above query and look at the results.</p>
<pre><code class="php">&lt;?php
$q = Doctrine::getTable('User')
  -&gt;createQuery('u')
  -&gt;leftJoin('u.Profile p');

$users = $q-&gt;fetchArray();

print_r($users);
</code></pre>
<p>The above would output just exactly what you'd expect.</p>

<pre><code class="">Array
(
    [0] =&gt; Array
        (
            [id] =&gt; 1
            [username] =&gt; jwage
            [password] =&gt; changeme
            [Profile] =&gt; Array
                (
                    [id] =&gt; 1
                    [user_id] =&gt; 1
                    [first_name] =&gt; string(255)
                    [last_name] =&gt; string(255)
                )

        )

)
</code></pre>
<p>The data from the <code>User</code> model came from one database, and the
data from the <code>Profile</code> model came from the other database.</p>
<blockquote><p><strong>NOTE</strong> This will only work if your database supports foreign keys
and joins across databases. I know MySQL does support this but I am
unsure about others. This same method can be used to query for data
across PostgreSQL schemas too.</p>
</blockquote>
<p>That is it! Joining data from across different databases is no
problem in Doctrine.</p>
<blockquote><p><strong>CAUTION</strong> This is not a designed feature of Doctrine and you may
experience edge cases that may not work as you'd expect. This is
just useful if you need to join data across databases and if you
experience edge cases you can work around them in your project.</p>
</blockquote>

        </div>
                
                    <nav class="article">
                <ul class="pagination">
                                            <li class="page-item"><a class="page-link previous" href="https://new.doctrine-project.org/2009/06/17/special-price-offer-symfony-1-2-doctrine-training-workshop" title="Special Price Offer: Symfony 1.2 + Doctrine Training Workshop"><span class="title">Previous: Special Price Offer: Symfony 1.2 + Doctrine Training Workshop</span></a></li>
                                                                <li class="page-item"><a class="page-link next" href="https://new.doctrine-project.org/2009/06/19/using-views-with-doctrine" title="Using Views with Doctrine"><span class="title">Next: Using Views with Doctrine</span></a></li>
                                    </ul>
            </nav>
            </article>



        </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
