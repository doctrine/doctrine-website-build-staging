<!DOCTYPE html>
<html>
    <head>
        <title>Using Views with Doctrine - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <meta name="robots" content="index, follow">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                <article>
        <header>
            <h2>Using Views with Doctrine <small>post</small></h2>
        </header>

        <p class="lead">
            Posted on 2009-06-19
                            by
                                    jwage
                                    </p>

        <div>
            <p>I've seen a few requests recently on how you can use a view with
Doctrine. This is very easy and I've also learned a few neat tricks
that you can do to accomplish abnormal things while writing this
article.</p>
<a id="title.1"></a><h1>Creating the View</h1>
<p>First I will demonstrate how you can turn a normal
<code>Doctrine_Query</code> instance in to a view. This is just as easy as
creating an instance of <code>Doctrine_View</code> and setting a reference
between the query and the view.</p>
<pre><code class="php">&lt;?php
$q = Doctrine::getTable('BlogPost')
  -&gt;createQuery('p')
  -&gt;select('p.*, COUNT(c.id) as num_comments')
  -&gt;leftJoin('p.Comments c')
  -&gt;orderBy('p.id DESC')
  -&gt;groupBy('p.id');

$view = new Doctrine_View($q, 'test_view');
</code></pre>
<p>To create the view in the database you can call the
<code>Doctrine_View::create()</code> method.</p>
<pre><code class="php">&lt;?php
$view-&gt;create();

**TIP** You can drop the view just the same by calling the
``Doctrine_View::drop()`` method.
</code></pre>
<pre><code class="php">&lt;?php
    $view-&gt;drop();

</code></pre>
<a id="title.2"></a><h1>Executing the View</h1>
<p>Now when the <code>Doctrine_Query</code> instance above is executed, it will
execute the SQL for the view instead of parsing the DQL, generating
the SQL and executing it.</p>
<pre><code class="php">&lt;?php
$blogPosts = $q-&gt;execute();
</code></pre>
<p>Executing the above would execute the following SQL query.</p>

<pre><code class="">[sql]
SELECT * FROM test_view
</code></pre>
<a id="title.3"></a><h1>Tweaking the View</h1>
<p>Now here is where things get interesting. Say we wanted to take the
SQL that the above <code>Doctrine_Query</code> generates, and modify it
slightly with some custom SQL that otherwise could not make it
through the DQL parser.</p>
<p>We can get the SQL from the query, modify it, then manually create
the view in our database.</p>
<pre><code class="php">&lt;?php
echo $q-&gt;getSql();
</code></pre>
<p>The above would output the following SQL.</p>

<pre><code class="">[sql]
SELECT b.id AS b__id, b.title AS b__title, b.excerpt AS b__excerpt, b.body AS b__body, COUNT(c.id) AS c__0 FROM blog_post b LEFT JOIN comment c ON b.id = c.blog_post_id GROUP BY b.id ORDER BY b.id DESC
</code></pre>
<p>Now lets say we wanted to add something to the SQL that is
proprietary to your DBMS, or is some complex SQL that won't make it
through the DQL parser. We can modify the above SQL then re-create
the view with that SQL manually. Let's make a simple change and add
the <code>USE INDEX</code> keyword to force MySQL to use a certain index for
the query.</p>
<blockquote><p><strong>NOTE</strong> The example I have chosen is a very simple one only to
demonstrate the capabilities. This example may not be a real world
scenario for you. The only purpose of me showing this is to open a
door for you to solve potential problems for you in the future.</p>
</blockquote>

<pre><code class="">[sql]
SELECT b.id AS b__id, b.title AS b__title, b.excerpt AS b__excerpt, b.body AS b__body, COUNT(c.id) AS c__0 FROM blog_post b LEFT JOIN comment c USE INDEX (blog_post_id_idx) ON b.id = c.blog_post_id GROUP BY b.id ORDER BY b.id DESC;
</code></pre>
<p>Now lets take this query and manually create the view with it.</p>
<blockquote><p><strong>NOTE</strong> We must first drop the view as we already created it once
in a previous step. This is just as easy as issuing the DROP VIEW
command to MySQL. Afterward, re-create the view again with the
modified SQL.</p>
</blockquote>

<pre><code class="">[sql]
DROP VIEW test_view;
CREATE VIEW test_view AS SELECT b.id AS b__id, b.title AS b__title, b.excerpt AS b__excerpt, b.body AS b__body, COUNT(c.id) AS c__0 FROM blog_post b LEFT JOIN comment c USE INDEX (blog_post_id_idx) ON b.id = c.blog_post_id GROUP BY b.id ORDER BY b.id DESC;
</code></pre>
<p>Now when we execute the code in the first part of this article it
will execute the view which contains the customized SQL.</p>
<pre><code class="php">&lt;?php
$blogPosts = $q-&gt;execute();

**CAUTION** If you customize the SQL, it must maintain the same
structure, aliases, etc. in order for Doctrine to be able to
hydrate the data in to the object graph.

</code></pre>
<p>That is it! Now you can easily use some custom SQL in your queries
as views. The benefit of using a view is that it is easily reusable
and it is much faster than executing a normal query in most cases.</p>

        </div>
                
                    <nav class="article">
                <ul class="pagination">
                                            <li class="page-item"><a class="page-link previous" href="https://new.doctrine-project.org/2009/06/19/cross-database-joins" title="Cross Database Joins"><span class="title">Previous: Cross Database Joins</span></a></li>
                                                                <li class="page-item"><a class="page-link next" href="https://new.doctrine-project.org/2009/06/21/doctrine-future-roadmap" title="Doctrine Future Roadmap"><span class="title">Next: Doctrine Future Roadmap</span></a></li>
                                    </ul>
            </nav>
            </article>



        </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
