<!DOCTYPE html>
<html>
    <head>
        <title>Transactions and Performance - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <meta name="robots" content="index, follow">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://new.doctrine-project.org/css/style.css?9" rel="stylesheet" type="text/css" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://new.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://new.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://new.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://new.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://new.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://new.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://new.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://new.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://new.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://new.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://new.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://new.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://new.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://new.doctrine-project.org/images/mstile-310x310.png" />

        <link rel="stylesheet" href="https://new.doctrine-project.org/components/highlightjs/styles/railscasts.css?9" />
        <link rel="alternate" type="application/atom+xml" href="https://new.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        
        
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>
    </head>
    <body>

        <header>
            <nav class="navbar navbar-expand-md navbar-dark border-bottom">
                <a class="navbar-brand text-hide" href="https://new.doctrine-project.org/"><img src="https://new.doctrine-project.org/images/doctrine-logo.svg" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/">Home</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://new.doctrine-project.org/projects/" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orm/">ORM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/dbal/">DBAL</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb-odm/">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/phpcr-odm/">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/couchdb-odm/">CouchDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/migrations/">Migrations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/common/">Common</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/mongodb/">MongoDB</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/orientdb-odm/">OrientDB ODM</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/annotations/">Annotations</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/collections/">Collections</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/inflector/">Inflector</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/cache/">Cache</a>
                                                                    <a class="dropdown-item" href="https://new.doctrine-project.org/projects/lexer/">Lexer</a>
                                                            </div>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/contribute/">Contribute</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://new.doctrine-project.org/search/">Search</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://github.com/doctrine/" target="_blank">Development</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                <article>
        <header>
            <h2>Transactions and Performance <small>post</small></h2>
        </header>

        <p class="lead">
            Posted on 2009-08-22
                            by
                                    romanb
                                    </p>

        <div>
            <p>In this post I want to clarify some things about transactions and
performance of PHP applications in general. I want to show you that
it is very easy to lose a lot of performance without using any
&quot;heavy&quot; framework at all and I also want to show that frameworks
can actually help you avoid a lot of these problems transparently.
I want to sensibilize you for the fact that there are a lot of
factors in PHP application performance and that you can very easily
lose the performance that you hoped to gain by not using framework
X or Z or building your own (&quot;Not Invented Here&quot;-syndrome) by
several orders of magnitude through rather trivial errors or
misconceptions.</p>
<p>Given a MySql database with InnoDB tables, which of the following
code snippets that insert 20 users do you think is faster? First
the Doctrine (2) version:</p>
<pre><code class="php">&lt;?php
// Using Doctrine 2 to insert 20 users
for ($i=0; $i&lt;20; ++$i) {
    $user = new CmsUser;
    $user-&gt;name = 'Guilherme';
    $user-&gt;status = 'Slave';
    $user-&gt;username = 'gblanco';
    $em-&gt;persist($user);
}

$s = microtime(true);
$em-&gt;flush();
$e = microtime(true);
echo ($e - $s) . &quot;&lt;br/&gt;&quot;;
</code></pre>
<p>Now the good old mysql\_query version:</p>
<pre><code class="php">&lt;?php
$s = microtime(true);
for ($i=0; $i&lt;20; ++$i) {
    mysql_query(&quot;INSERT INTO cms_users (name, status, username) VALUES ('Guilherme', 'Slave', 'gblanco')&quot;, $link);
}
$e = microtime(true);
echo ($e - $s) . &quot;&lt;br/&gt;&quot;;
</code></pre>
<p>Even this comparison is not fair since flush() is doing a lot more
stuff but anyhow. The results might surprise some of you:</p>

<pre><code class="">Doctrine 2: 0.0094 seconds
mysql_query: 0.0165 seconds
</code></pre>
<p>Yes, our good old mysql\_query code is almost twice as slow even
though it does a lot less, provides no features, no abstraction, no
basic protection against SQL injection, etc. Why is that? The
answer is: transactions. In the Doctrine 2 example, Doctrine takes
over transaction management for us and efficiently executes all
inserts in a single, short transaction. In the plain mysql\_query
example, there is no transaction demarcation and since MySql by
default operates in autocommit mode, every mysql\_query call will
implicitly commit the transaction and start a new one. Thats 20
transactions. Here is the revised code of the second example with
proper transaction demarcation:</p>
<pre><code class="php">&lt;?php
$s = microtime(true);
mysql_query('START TRANSACTION', $link);
for ($i=0; $i&lt;20; ++$i) {
    mysql_query(&quot;INSERT INTO cms_users (name, status, username) VALUES ('Guilherme', 'Slave', 'gblanco')&quot;, $link);
}
mysql_query('COMMIT', $link);
$e = microtime(true);
echo ($e - $s) . &quot;&lt;br/&gt;&quot;;
</code></pre>
<p>The result:</p>

<pre><code class="">mysql_query: 0.0028 seconds
</code></pre>
<p>Thats a huge difference. We can conclude:</p>
<p><strong>Bad or no transaction management/demarcation can reduce performance by several orders of magnitude.</strong></p>
<p>Many people are used to autocommit mode without really being aware
of what it is doing. It does not mean there is no transaction
unless you issue START/BEGIN TRANSACTION or PDO#beginTransaction().
It means after every single query a transaction is committed
automatically and a new one started. Methods like
PDO#beginTransaction() merely suspend autocommit mode for a short
duration (until you call PDO#commit()/PDO#rollback()).</p>
<p>To clarify:</p>
<p><strong>You can not talk to your database outside of a transaction.</strong></p>
<p>Even SELECT queries get wrapped in a small transaction in
autocommit mode. However since SELECT statements usually don't
result in any write locks (like INSERT/UPDATE/DELETE) the penalty
of these transactions is usually not that big.</p>
<p>Doctrine 2 can help a lot here. You can modify your objects
anywhere, persist and delete objects anywhere and once you call
<code>EntityManager#flush()</code> Doctrine 2 will efficiently make all
updates in a single transaction.</p>
<p>What I wanted to highlight with this post is that there are a lot
of factors that influence the performance of your application, and
raw execution speed of the code is certainly not one of the most
influential ones. You can very easily lose 10 times the performance
by trivial things such as the one shown above (bad/no transaction
demarcation) than what you gained by choosing some &quot;ultra
lightweight&quot; PHP framework or a homegrown solution.</p>
<p>There are many more factors, like network load, inefficient
database indices or no indices, and much more. Don't just always
look at the raw execution speed of your code. Use code that is well
tested, established, used by lots of people and developed by lots
of people. Don't reinvent the wheel and use existing tools or help
make existing tools better! (Oh, and use the right tool for the
job, of course!)</p>
<p>Most of the time when you think your own solutions are much better
and have a lot less bugs than existing ones then thats most likely
just because noone else is using it and so the bugs are never found
:-).</p>
<p>PS: If you're still confused by the autocommit mode, let me
recommend this excellent page from the Hibernate project:
<a href="https://www.hibernate.org/403.html">Non-transactional data access and the auto-commit mode</a></p>

        </div>
                
                    <nav class="article">
                <ul class="pagination">
                                            <li class="page-item"><a class="page-link previous" href="https://new.doctrine-project.org/2009/08/15/doctrine2-native-queries" title="Doctrine 2 Native Queries"><span class="title">Previous: Doctrine 2 Native Queries</span></a></li>
                                                                <li class="page-item"><a class="page-link next" href="https://new.doctrine-project.org/2009/08/24/doctrine-2-0-quality-assurance" title="Doctrine 2.0 Quality Assurance"><span class="title">Next: Doctrine 2.0 Quality Assurance</span></a></li>
                                    </ul>
            </nav>
            </article>



        </main>

        <footer class="footer">
            <div class="container">
                <i class="fa fa-copyright"></i> 2018 Doctrine
            </div>
        </footer>

        <script type="text/javascript">
            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() {scrollFunction()};

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById('back-to-top').style.display = "block";
                } else {
                    document.getElementById('back-to-top').style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            function topFunction() {
                document.body.scrollTop = 0; // For Safari
                document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
            }
        </script>

        <button onclick="topFunction()" id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://new.doctrine-project.org/components/highlightjs/highlight.pack.js?9"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
